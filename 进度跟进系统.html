<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“”å“©å“”å“©è¯¾ç¨‹è¿›åº¦è·Ÿè¸ªå™¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #333;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 20px; 
        }

        header h1 {
            color: #2c3e50;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px; /* Reduced margin to bring new text closer */
        }

        .motivational-phrase { /* Style for the new motivational phrase */
            color: #e67e22; /* An encouraging orange color */
            font-size: 18px;
            font-weight: 500;
            margin-top: 0;
            margin-bottom: 20px; /* Space before the course cards or next element */
        }


        .data-actions-container { 
            margin-top: 15px;
            margin-bottom: 15px; 
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .action-button {
            background-color: #5dade2; 
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color: 0.3s ease;
        }
        .action-button:hover {
            background-color: #3498db;
        }
        .action-button.edit-mode-active-btn {
            background-color: #e74c3c;
        }
        .action-button.edit-mode-active-btn:hover {
            background-color: #c0392b;
        }


        #course-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 25px;
            padding: 20px 5px; 
            width: 100%;
            box-sizing: border-box;
        }

        .course-item-container {
            position: relative; /* Needed for positioning edit buttons */
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 230px;
            min-height: 220px; 
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .course-item-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        /* Edit mode buttons styling */
        .delete-course-btn, .edit-icon-text-btn, .add-sub-course-btn {
            display: none; /* Hidden by default */
            position: absolute;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
            z-index: 10;
            width: 28px;
            height: 28px;
            font-size: 16px;
            line-height: 28px;
        }

        .delete-course-btn {
            top: -8px;
            right: -8px;
            background-color: rgba(231, 76, 60, 0.9);
        }
        .delete-course-btn:hover {
            background-color: #c0392b;
            transform: scale(1.1);
        }

        .edit-icon-text-btn {
            top: 30px;
            right: -8px;
            font-size: 14px;
            background-color: rgba(52, 152, 219, 0.9);
        }
        .edit-icon-text-btn:hover {
            background-color: #2980b9;
            transform: scale(1.1);
        }
        
        .add-sub-course-btn {
            top: 68px;
            right: -8px;
            background-color: rgba(46, 204, 113, 0.9);
            font-size: 20px;
        }
        .add-sub-course-btn:hover {
            background-color: #27ae60;
            transform: scale(1.1);
        }


        /* Show buttons when in edit mode */
        body.edit-mode-active .delete-course-btn,
        body.edit-mode-active .edit-icon-text-btn,
        body.edit-mode-active .add-sub-course-btn {
            display: block;
        }


        .course-icon { 
            width: 90px; 
            height: 90px; 
            background-color: #3498db; 
            color: white;
            font-size: 18px; 
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
            transition: background-color 0.3s ease;
            flex-shrink: 0; 
            text-align: center;
            padding: 5px;
            line-height: 1.2;
            word-break: break-word;
        }

        .course-icon:hover {
            background-color: #2980b9; 
        }

        .course-name { 
            font-size: 17px; 
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            word-break: break-word; 
        }
        
        .course-item-container .course-name.multi-link-title {
            font-size: 18px;
            font-weight: 700;
        }

        .update-link-button { 
            background-color: #2ecc71; 
            color: white;
            border: none;
            padding: 10px 18px; 
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px; 
            font-weight: 500;
            transition: background-color 0.3s ease;
            width: 100%; 
            box-sizing: border-box;
            margin-top: auto; 
        }

        .update-link-button:hover {
            background-color: #27ae60; 
        }

        .sub-courses-icons-container { 
            display: flex;
            justify-content: center; /* Centered items */
            align-items: flex-start; 
            gap: 10px; 
            margin-bottom: 15px; 
            width: 100%;
            /* flex-wrap: wrap; -- Removed this to prevent wrapping */
        }

        .sub-course-item { 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px; 
            position: relative; /* For edit button positioning */
        }
        
        .sub-course-icon { 
            width: 60px; 
            height: 60px;
            background-color: #3498db; 
            color: white;
            font-size: 12px; 
            font-weight: bold;
            border: none;
            border-radius: 8px; 
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease;
            flex-shrink: 0;
            line-height: 1.2; 
            padding: 2px; 
            text-align: center;
            word-break: break-word;
        }

        .sub-course-icon:hover {
            background-color: #2980b9;
        }
        .sub-course-item-name { 
            font-size: 12px; 
            color: #555;
        }

        /* Adjusting edit buttons for sub-courses */
        .sub-course-item .delete-course-btn {
            top: -5px;
            right: -5px;
            width: 24px;
            height: 24px;
            font-size: 14px;
            line-height: 24px;
        }
        .sub-course-item .edit-icon-text-btn {
            top: 20px;
            right: -5px;
            width: 24px;
            height: 24px;
            font-size: 12px;
            line-height: 24px;
        }
        .sub-course-item .add-sub-course-btn {
            display: none; /* Hide add button on sub-items */
        }

        /* Modal styles */
        .modal {
            display: none; 
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5); 
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            text-align: left;
            position: relative;
            animation: fadeInModal 0.3s ease-out;
        }

        @keyframes fadeInModal {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
        }

        .modal h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 22px;
        }
        
        .modal-input-section {
            margin-bottom: 15px;
        }
        .modal-input-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        .modal-input-section input[type="url"],
        .modal-input-section input[type="text"] {
            width: 100%; 
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        #modal-default-input-container p { 
             margin-bottom: 10px;
             font-size: 16px;
             line-height: 1.6;
        }
         #modal-multi-inputs-container p { 
             margin-bottom: 15px;
             font-size: 16px;
             line-height: 1.6;
        }


        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        #modal-save-button, .modal-confirm-btn, .modal-cancel-btn {
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        #modal-save-button, .modal-confirm-btn {
             background-color: #3498db;
        }
        .modal-cancel-btn {
            background-color: #95a5a6;
        }

        #modal-save-button:hover, .modal-confirm-btn:hover {
            background-color: #2980b9;
        }
        .modal-cancel-btn:hover {
            background-color: #7f8c8d;
        }

        /* Celebration Toast Styles */
        #celebration-toast {
            position: fixed;
            bottom: 30px; 
            left: 50%;
            transform: translateX(-50%);
            background-color: #2ecc71; 
            color: white;
            padding: 18px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 2000; 
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease, bottom 0.5s ease; 
            text-align: center;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #celebration-toast.show {
            opacity: 1;
            visibility: visible;
            bottom: 50px; 
        }

        .toast-flowers {
            font-size: 24px; 
            animation: bloom 0.8s ease-out forwards;
        }
        
        @keyframes bloom { 
            0% { transform: scale(0.5); opacity: 0.5; }
            70% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Footer Styles */
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px; 
            border-top: 1px solid #e0e0e0; 
            width: 100%;
            max-width: 800px; 
            margin-left: auto;
            margin-right: auto;
            box-sizing: border-box;
        }
        footer p {
            color: #555;
            font-size: 16px;
            margin-top: 10px;
            margin-bottom: 10px;
            line-height: 1.6;
        }

        @media (max-width: 600px) {
            header h1 {
                font-size: 24px;
            }
            .motivational-phrase {
                font-size: 16px;
                margin-bottom: 15px;
            }
            footer .data-actions-container { 
                flex-direction: column; 
                align-items: center;
            }
            footer .action-button { 
                width: 80%;
                max-width: 250px; 
            }
            .course-item-container {
                width: 190px; 
                padding: 15px;
                min-height: 200px;
            }
            .course-icon {
                width: 70px; 
                height: 70px;
                font-size: 16px; 
            }
            .course-name {
                font-size: 16px; 
                margin-bottom: 10px; 
            }
             .course-item-container .course-name.multi-link-title {
                font-size: 17px;
            }
            .update-link-button {
                font-size: 12px; 
                padding: 8px 12px; 
            }
            .sub-course-icon { 
                width: 50px;
                height: 50px;
                font-size: 10px;
            }
            .sub-course-item-name {
                font-size: 11px;
            }
             .sub-courses-icons-container {
                gap: 5px; 
            }


            .modal-content {
                width: 90%;
                padding: 20px;
            }
            .modal-input-section input[type="url"],
            .modal-input-section input[type="text"] {
                font-size: 14px;
            }
            #modal-save-button, .modal-confirm-btn, .modal-cancel-btn { 
                font-size: 14px;
                padding: 10px 18px;
            }
            #celebration-toast {
                padding: 15px 25px;
                font-size: 14px;
                width: calc(90% - 50px); 
            }
            .toast-flowers {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å“”å“©å“”å“©è¯¾ç¨‹è¿›åº¦è·Ÿè¸ªå™¨</h1>
            <p class="motivational-phrase">åŠ æ²¹, åšæŒ, åŠªåŠ›ï¼</p> 
        </header>

        <div id="course-container">
            <!-- Courses will be rendered here by JavaScript -->
        </div>

        <!-- Main Modal for updating links and editing text -->
        <div id="main-modal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h2 id="modal-title">æ›´æ–°è¯¾ç¨‹é“¾æ¥</h2>
                
                <!-- Container for default link input -->
                <div id="modal-default-input-container" class="modal-input-section">
                    <p>è¯·ç²˜è´´å½“å‰è¯¾æ—¶çš„å“”å“©å“”å“©é“¾æ¥ï¼š</p>
                    <input type="url" id="modal-link-input" placeholder="ä¾‹å¦‚ï¼šhttps://www.bilibili.com/video/BVxxxxxx">
                </div>
                
                <!-- Container for multi-link inputs -->
                <div id="modal-multi-inputs-container" style="display: none;">
                    <!-- Dynamic inputs for sub-courses will be added here -->
                </div>

                <!-- Container for editing icon text -->
                <div id="modal-edit-text-container" class="modal-input-section" style="display: none;">
                    <label for="modal-text-input">å›¾æ ‡æ–‡å­—:</label>
                    <input type="text" id="modal-text-input" placeholder="è¾“å…¥æ–°çš„å›¾æ ‡æ–‡å­—">
                </div>
                
                <div class="modal-buttons">
                    <button id="modal-save-button">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- Deletion Confirmation Modal -->
        <div id="delete-confirm-modal" class="modal">
            <div class="modal-content">
                <h2 id="delete-modal-title">ç¡®è®¤åˆ é™¤</h2>
                <p id="delete-confirm-message">æ‚¨ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
                <div class="modal-buttons">
                    <button id="cancel-delete-button" class="modal-cancel-btn">å–æ¶ˆ</button>
                    <button id="confirm-delete-button" class="modal-confirm-btn">ç¡®è®¤åˆ é™¤</button>
                </div>
            </div>
        </div>
        
        <!-- Add Item Modal -->
        <div id="add-item-modal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h2 id="add-item-modal-title">æ·»åŠ æ–°é¡¹ç›®</h2>
                <div class="modal-input-section">
                    <label for="add-item-modal-input">é¡¹ç›®åç§°:</label>
                    <input type="text" id="add-item-modal-input" placeholder="è¾“å…¥æ–°é¡¹ç›®åç§°">
                </div>
                <div class="modal-buttons">
                    <button id="cancel-add-item-button" class="modal-cancel-btn">å–æ¶ˆ</button>
                    <button id="confirm-add-item-button" class="modal-confirm-btn">ç¡®è®¤æ·»åŠ </button>
                </div>
            </div>
        </div>


        <div id="celebration-toast">
            <span class="toast-flowers">ğŸŒ¸</span>
            <span id="toast-message">å¤ªæ£’äº†ï¼ç¦»æˆåŠŸåˆè¿‘äº†ä¸€æ­¥ï¼</span>
            <span class="toast-flowers">ğŸ‰</span>
        </div>
    </div> 
    
    <footer>
        <p>è½»æ¾è®°å½•å’Œè¿”å›æ‚¨åœ¨å“”å“©å“”å“©ä¸Šå­¦ä¹ çš„è¯¾ç¨‹è¿›åº¦ã€‚</p>
        <div class="data-actions-container">
            <button id="edit-mode-button" class="action-button">ç¼–è¾‘</button>
            <button id="export-data-button" class="action-button">å¯¼å‡ºè®°å½•</button>
            <button id="import-data-button" class="action-button">å¯¼å…¥è®°å½•</button>
            <input type="file" id="import-file-input" accept=".json" style="display: none;">
        </div>
        <p><strong>ä½¿ç”¨è¯´æ˜ï¼š</strong>ç‚¹å‡»è¯¾ç¨‹å›¾æ ‡æˆ–å­è¯¾ç¨‹å›¾æ ‡æ‰“å¼€ä¸Šæ¬¡è§‚çœ‹çš„è§†é¢‘ã€‚è§‚çœ‹æ–°è§†é¢‘åï¼Œç‚¹å‡»ç›¸åº”çš„â€œæ›´æ–°è¿›åº¦â€æŒ‰é’®ï¼Œç²˜è´´æ–°çš„è§†é¢‘é“¾æ¥å¹¶ä¿å­˜ã€‚</p>
        <p><strong>ç¼–è¾‘æ¨¡å¼è¯´æ˜ï¼š</strong>ç‚¹å‡»â€œç¼–è¾‘â€æŒ‰é’®è¿›å…¥ç¼–è¾‘æ¨¡å¼ã€‚ç‚¹å‡»ç»¿è‰²â€œ+â€æ·»åŠ å­é¡¹ç›®ï¼Œç‚¹å‡»è“è‰²é“…ç¬”â€œâœâ€ç¼–è¾‘å›¾æ ‡æ–‡å­—ï¼Œç‚¹å‡»çº¢è‰²â€œXâ€åˆ é™¤é¡¹ç›®ã€‚</p>
    </footer>

    <script>
        // --- å…¨å±€çŠ¶æ€å’Œå¸¸é‡ ---
        let courses = [
            { id: 'chinese', name: 'è¯­æ–‡', iconText: 'è¯­æ–‡', defaultUrl: 'BILIBILI_CHINESE_PLACEHOLDER', currentUrl: null },
            { id: 'math', name: 'æ•°å­¦', iconText: 'æ•°å­¦', defaultUrl: 'BILIBILI_MATH_PLACEHOLDER', currentUrl: null },
            {
                id: 'english', name: 'è‹±è¯­', isMultiLink: true,
                subCourses: [
                    { name: 'å…”å­', defaultUrl: 'BILIBILI_ENGLISH_RABBIT_PLACEHOLDER', currentUrl: null, iconText: 'å…”å­' },
                    { name: 'ä¸€è‹±', defaultUrl: 'BILIBILI_ENGLISH_YIYING_PLACEHOLDER', currentUrl: null, iconText: 'ä¸€è‹±' },
                    { name: 'free', defaultUrl: 'BILIBILI_ENGLISH_FREE_PLACEHOLDER', currentUrl: null, iconText: 'free' } 
                ]
            },
            {
                id: 'physics', name: 'ç‰©ç†', isMultiLink: true,
                subCourses: [
                    { name: 'è·³è·³', defaultUrl: 'BILIBILI_PHYSICS_TIAOTIAO_PLACEHOLDER', currentUrl: null, iconText: 'è·³è·³' },
                    { name: 'å¤«äºº', defaultUrl: 'BILIBILI_PHYSICS_FUREN_PLACEHOLDER', currentUrl: null, iconText: 'å¤«äºº' }
                ]
            },
            {
                id: 'biology', name: 'ç”Ÿç‰©', isMultiLink: true,
                subCourses: [
                    { name: 'æ±‰æ°´', defaultUrl: 'BILIBILI_BIOLOGY_HANSHUI_PLACEHOLDER', currentUrl: null, iconText: 'æ±‰æ°´' },
                    { name: 'ä¸€ç”Ÿ', defaultUrl: 'BILIBILI_BIOLOGY_YISHENG_PLACEHOLDER', currentUrl: null, iconText: 'ä¸€ç”Ÿ' }
                ]
            },
            { id: 'chemistry', name: 'åŒ–å­¦', iconText: 'åŒ–å­¦', defaultUrl: 'BILIBILI_CHEMISTRY_PLACEHOLDER', currentUrl: null }
        ];
        let isEditMode = false; // Flag for edit mode
        let currentCourseToUpdate = null; 
        let currentSubCourseToUpdate = null;
        let currentModalMode = 'link'; // 'link', 'text', 'delete', 'add'
        let itemToAddInfo = { isAdding: false, courseId: null };


        const BILIBILI_LINK_PLACEHOLDER_PREFIX = 'BILIBILI_'; 
        const LOCAL_STORAGE_KEY = 'bilibiliCourseTracker';

        // --- DOM å…ƒç´ è·å– ---
        const courseContainer = document.getElementById('course-container');
        const mainModal = document.getElementById('main-modal');
        const modalTitle = document.getElementById('modal-title');
        const closeButton = mainModal.querySelector('.close-button');
        const modalDefaultInputContainer = document.getElementById('modal-default-input-container');
        const modalLinkInput = document.getElementById('modal-link-input');
        const modalMultiInputsContainer = document.getElementById('modal-multi-inputs-container'); 
        const modalEditTextContainer = document.getElementById('modal-edit-text-container');
        const modalTextInput = document.getElementById('modal-text-input');
        const modalSaveButton = document.getElementById('modal-save-button');
        const celebrationToast = document.getElementById('celebration-toast');
        const toastMessageElement = document.getElementById('toast-message');
        const exportDataButton = document.getElementById('export-data-button');
        const importDataButton = document.getElementById('import-data-button');
        const importFileInput = document.getElementById('import-file-input');
        const editModeButton = document.getElementById('edit-mode-button');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const confirmDeleteButton = document.getElementById('confirm-delete-button');
        const cancelDeleteButton = document.getElementById('cancel-delete-button');
        const deleteConfirmMessage = document.getElementById('delete-confirm-message');
        const deleteModalTitle = document.getElementById('delete-modal-title');
        const addItemModal = document.getElementById('add-item-modal');
        const addItemModalTitle = document.getElementById('add-item-modal-title');
        const addItemModalInput = document.getElementById('add-item-modal-input');
        const confirmAddItemButton = document.getElementById('confirm-add-item-button');
        const cancelAddItemButton = document.getElementById('cancel-add-item-button');


        const encouragingMessages = [
            "å¤ªæ£’äº†ï¼ç¦»æˆåŠŸåˆè¿‘äº†ä¸€æ­¥ï¼", "æ­å–œä½ ï¼ŒåšæŒå°±æ˜¯èƒœåˆ©ï¼", "çœŸå‰å®³ï¼ç»§ç»­ä¿æŒè¿™ä¸ªåŠ¿å¤´ï¼",
            "åˆå®Œæˆäº†ä¸€ä¸ªå°ç›®æ ‡ï¼Œä¸ºä½ å–å½©ï¼", "å­¦æ— æ­¢å¢ƒï¼Œä½ åˆè¿›æ­¥å•¦ï¼", "ä¸ºä½ ç‚¹èµï¼å‘ç€ç›®æ ‡å‰è¿›ï¼",
            "å¥½æ ·çš„ï¼æ¯ä¸€æ¬¡åŠªåŠ›éƒ½ç®—æ•°ï¼", "â€œä¹¦å±±æœ‰è·¯å‹¤ä¸ºå¾„ï¼Œå­¦æµ·æ— æ¶¯è‹¦ä½œèˆŸã€‚â€ - éŸ©æ„ˆ",
            "â€œé”²è€Œä¸èˆï¼Œé‡‘çŸ³å¯é•‚ã€‚â€ - è€å­", "â€œåƒé‡Œä¹‹è¡Œï¼Œå§‹äºè¶³ä¸‹ã€‚â€ - è€å­"
        ];
        const flowerEmojis = ["ğŸŒ¸", "ğŸŒ¼", "ğŸŒ»", "ğŸŒ¹", "ğŸŒ·", "ğŸ‰", "âœ¨", "ğŸŒŸ", "ğŸ’–", "ğŸˆ", "ğŸŠ", "ğŸ’«", "ğŸ¥³"];

        // --- æ•°æ®å¤„ç†å‡½æ•° ---
        function getSubCourse(course, subCourseName) {
            if (course && course.isMultiLink && course.subCourses) {
                return course.subCourses.find(sc => sc.name === subCourseName);
            }
            return null;
        }

        function loadCourses() {
            const storedCourses = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedCourses) {
                try {
                    const parsedStoredCourses = JSON.parse(storedCourses);
                    if (Array.isArray(parsedStoredCourses)) {
                        // A simple merge: keep default structure, update with stored data
                        const storedCoursesMap = new Map(parsedStoredCourses.map(sc => [sc.id, sc]));
                        courses = courses.map(defaultCourse => {
                            const storedCourse = storedCoursesMap.get(defaultCourse.id);
                            if (storedCourse) {
                                let mergedCourse = { ...defaultCourse, ...storedCourse };
                                if (defaultCourse.isMultiLink && Array.isArray(defaultCourse.subCourses)) {
                                    mergedCourse.subCourses = defaultCourse.subCourses.map(defaultSubCourse => {
                                        const storedSubCourse = Array.isArray(storedCourse.subCourses) ? 
                                                                storedCourse.subCourses.find(sc => sc.name === defaultSubCourse.name) : null;
                                        return storedSubCourse ? { ...defaultSubCourse, ...storedSubCourse } : defaultSubCourse;
                                    });
                                }
                                return mergedCourse;
                            }
                            return defaultCourse;
                        }).filter(c => c); // Filter out nulls if any
                    } else {
                         console.warn("Stored data is not an array. Using default courses.");
                    }
                } catch (error) {
                    console.error("Error parsing stored courses data:", error);
                    showToast("åŠ è½½è®°å½•æ—¶å‡ºé”™ï¼Œå¯èƒ½è®°å½•å·²æŸåã€‚", true);
                }
            }
        }

        function saveCourses() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(courses));
        }

        // --- æ¸²æŸ“å‡½æ•° ---
        function renderCourses() {
            courseContainer.innerHTML = ''; 
            courses.forEach(course => {
                const courseDiv = document.createElement('div');
                courseDiv.className = 'course-item-container';
                
                if (course.isMultiLink && course.subCourses) { 
                    // ... Multi-link course rendering ...
                    const subIconsContainer = document.createElement('div');
                    subIconsContainer.className = 'sub-courses-icons-container'; 
                    course.subCourses.forEach(subCourse => {
                        const subCourseItemDiv = document.createElement('div');
                        subCourseItemDiv.className = 'sub-course-item'; 
                        
                        const subIconButton = document.createElement('button');
                        subIconButton.className = 'sub-course-icon'; 
                        subIconButton.textContent = subCourse.iconText || subCourse.name; 
                        subIconButton.title = `æ‰“å¼€ ${course.name} - ${subCourse.name}`;
                        subIconButton.addEventListener('click', () => {
                            if (isEditMode) return;
                            let urlToOpen = subCourse.currentUrl || subCourse.defaultUrl;
                            if (!urlToOpen || urlToOpen.startsWith(BILIBILI_LINK_PLACEHOLDER_PREFIX)) { 
                                showToast(`è¯·å…ˆä¸º "${course.name} - ${subCourse.name}" æ›´æ–°é“¾æ¥ã€‚`, true); 
                                openModal(course.id, null, 'link'); 
                            } else {
                                window.open(urlToOpen, '_blank');
                            }
                        });
                        
                        const subCourseNameLabel = document.createElement('span');
                        subCourseNameLabel.className = 'sub-course-item-name'; 
                        subCourseNameLabel.textContent = subCourse.iconText || subCourse.name;
                        
                        subCourseItemDiv.appendChild(subIconButton);
                        subCourseItemDiv.appendChild(subCourseNameLabel);
                        
                        // Add edit buttons for sub-course
                        const deleteBtn = createDeleteButton(() => openDeleteModal(course.id, subCourse.name));
                        const editBtn = createEditButton(() => openModal(course.id, subCourse.name, 'text'));
                        subCourseItemDiv.appendChild(deleteBtn);
                        subCourseItemDiv.appendChild(editBtn);

                        subIconsContainer.appendChild(subCourseItemDiv);
                    });
                    courseDiv.appendChild(subIconsContainer); 
                    
                    const nameLabel = document.createElement('p');
                    nameLabel.className = 'course-name multi-link-title';
                    nameLabel.textContent = course.name;
                    courseDiv.appendChild(nameLabel); 
                    
                    const mainUpdateButton = document.createElement('button');
                    mainUpdateButton.className = 'update-link-button';
                    mainUpdateButton.textContent = 'æ›´æ–°è¿›åº¦';
                    mainUpdateButton.addEventListener('click', () => openModal(course.id, null, 'link'));
                    courseDiv.appendChild(mainUpdateButton);

                } else { 
                    // ... Single course rendering ...
                    const iconButton = document.createElement('button');
                    iconButton.className = 'course-icon';
                    iconButton.textContent = course.iconText || course.name;
                    iconButton.title = `æ‰“å¼€ ${course.name} (ä¸Šæ¬¡è§‚çœ‹ä½ç½®)`;
                    iconButton.addEventListener('click', () => {
                        if (isEditMode) return;
                        let urlToOpen = course.currentUrl || course.defaultUrl;
                        if (!urlToOpen || urlToOpen.startsWith(BILIBILI_LINK_PLACEHOLDER_PREFIX)) { 
                            showToast(`è¯·å…ˆä¸º "${course.name}" è®¾ç½®é“¾æ¥ã€‚`, true); 
                            openModal(course.id, null, 'link'); 
                        } else {
                            window.open(urlToOpen, '_blank');
                        }
                    });
                    
                    const nameLabel = document.createElement('p');
                    nameLabel.className = 'course-name';
                    nameLabel.textContent = course.iconText || course.name;
                    
                    const updateButton = document.createElement('button');
                    updateButton.className = 'update-link-button';
                    updateButton.textContent = 'æ›´æ–°è¿›åº¦';
                    updateButton.title = `æ›´æ–° ${course.name} çš„å½“å‰è¯¾æ—¶é“¾æ¥`;
                    updateButton.addEventListener('click', () => openModal(course.id, null, 'link'));
                    
                    courseDiv.appendChild(iconButton); 
                    courseDiv.appendChild(nameLabel);   
                    courseDiv.appendChild(updateButton);
                }

                // Add edit buttons for main course container
                const deleteBtn = createDeleteButton(() => openDeleteModal(course.id, null));
                const addBtn = createAddButton(() => openAddItemModal(course.id));
                courseDiv.appendChild(addBtn);

                const editBtn = createEditButton(() => openModal(course.id, null, 'text'));
                if (!course.isMultiLink) { // Only add edit button to single courses here
                    courseDiv.appendChild(editBtn);
                }
                courseDiv.appendChild(deleteBtn);

                courseContainer.appendChild(courseDiv);
            });
        }

        // --- ç¼–è¾‘æ¨¡å¼ç›¸å…³å‡½æ•° ---
        function createDeleteButton(onClick) {
            const button = document.createElement('button');
            button.className = 'delete-course-btn';
            button.innerHTML = '&times;';
            button.title = 'åˆ é™¤';
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                onClick();
            });
            return button;
        }

        function createEditButton(onClick) {
            const button = document.createElement('button');
            button.className = 'edit-icon-text-btn';
            button.innerHTML = '&#9998;'; // Pencil icon
            button.title = 'ç¼–è¾‘å›¾æ ‡æ–‡å­—';
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                onClick();
            });
            return button;
        }
        
        function createAddButton(onClick) {
            const button = document.createElement('button');
            button.className = 'add-sub-course-btn';
            button.innerHTML = '+';
            button.title = 'æ·»åŠ å­é¡¹ç›®';
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                onClick();
            });
            return button;
        }


        function toggleEditMode() {
            isEditMode = !isEditMode;
            document.body.classList.toggle('edit-mode-active', isEditMode);
            editModeButton.textContent = isEditMode ? 'å®Œæˆç¼–è¾‘' : 'ç¼–è¾‘';
            editModeButton.classList.toggle('edit-mode-active-btn', isEditMode);
            renderCourses(); // Re-render to show/hide buttons
        }

        // --- å¼¹çª— (Modal) å‡½æ•° ---
        function openModal(courseId, subCourseName = null, mode = 'link') {
            currentCourseToUpdate = courses.find(c => c.id === courseId);
            if (!currentCourseToUpdate) return;

            currentSubCourseToUpdate = subCourseName ? getSubCourse(currentCourseToUpdate, subCourseName) : null;
            currentModalMode = mode;

            // Reset all modal sections
            modalDefaultInputContainer.style.display = 'none';
            modalMultiInputsContainer.style.display = 'none';
            modalEditTextContainer.style.display = 'none';

            if (mode === 'link') {
                modalTitle.textContent = `æ›´æ–° "${currentCourseToUpdate.name}" è¯¾ç¨‹é“¾æ¥`;
                if (currentCourseToUpdate.isMultiLink) {
                    modalMultiInputsContainer.innerHTML = '<p>è¯·ä¸ºä»¥ä¸‹å­é¡¹ç›®æ›´æ–°é“¾æ¥ (ç•™ç©ºåˆ™ä¸æ›´æ–°)ï¼š</p>'; 
                    currentCourseToUpdate.subCourses.forEach((subCourse, index) => {
                        const sectionDiv = document.createElement('div');
                        sectionDiv.className = 'modal-input-section';
                        const inputId = `modal-sub-input-${courseId}-${index}`;
                        const displayName = subCourse.iconText || subCourse.name;
                        sectionDiv.innerHTML = `
                            <label for="${inputId}">${displayName}:</label>
                            <input type="url" id="${inputId}" placeholder="${(subCourse.currentUrl && !subCourse.currentUrl.startsWith(BILIBILI_LINK_PLACEHOLDER_PREFIX)) ? subCourse.currentUrl : `${displayName}çš„Bç«™é“¾æ¥`}" data-sub-course-name="${subCourse.name}">
                        `;
                        modalMultiInputsContainer.appendChild(sectionDiv);
                    });
                    modalMultiInputsContainer.style.display = 'block';
                } else {
                    modalLinkInput.value = '';
                    modalLinkInput.placeholder = (currentCourseToUpdate.currentUrl && !currentCourseToUpdate.currentUrl.startsWith(BILIBILI_LINK_PLACEHOLDER_PREFIX)) ? currentCourseToUpdate.currentUrl : "ä¾‹å¦‚ï¼šhttps://www.bilibili.com/video/BVxxxxxx";
                    modalDefaultInputContainer.style.display = 'block';
                    modalLinkInput.focus();
                }
            } else if (mode === 'text') {
                const itemToEditText = currentSubCourseToUpdate || currentCourseToUpdate;
                modalTitle.textContent = `ç¼–è¾‘ "${itemToEditText.name}" çš„å›¾æ ‡æ–‡å­—`;
                modalTextInput.value = itemToEditText.iconText || '';
                modalEditTextContainer.style.display = 'block';
                modalTextInput.focus();
            }
            
            mainModal.style.display = 'flex';
        }

        function openDeleteModal(courseId, subCourseName = null) {
            currentCourseToUpdate = courses.find(c => c.id === courseId);
            if (!currentCourseToUpdate) return;
            currentSubCourseToUpdate = subCourseName ? getSubCourse(currentCourseToUpdate, subCourseName) : null;
            
            const itemToDeleteName = currentSubCourseToUpdate ? `${currentCourseToUpdate.name} - (å­é¡¹ç›®: ${currentSubCourseToUpdate.iconText || currentSubCourseToUpdate.name})` : currentCourseToUpdate.name;
            deleteModalTitle.textContent = `ç¡®è®¤åˆ é™¤ "${itemToDeleteName}"`;
            deleteConfirmMessage.textContent = `æ‚¨ç¡®å®šè¦åˆ é™¤ "${itemToDeleteName}" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`;
            deleteConfirmModal.style.display = 'flex';
        }
        
        function openAddItemModal(courseId = null) {
            itemToAddInfo.isAdding = true;
            itemToAddInfo.courseId = courseId;
            addItemModalInput.value = '';

            if (courseId) {
                const course = courses.find(c => c.id === courseId);
                addItemModalTitle.textContent = `ä¸º "${course.name}" æ·»åŠ å­é¡¹ç›®`;
                addItemModalInput.placeholder = 'è¾“å…¥æ–°çš„å­é¡¹ç›®åç§°';
            } else {
                // This case is now removed from the UI
                addItemModalTitle.textContent = 'æ·»åŠ æ–°è¯¾ç¨‹';
                addItemModalInput.placeholder = 'è¾“å…¥æ–°çš„è¯¾ç¨‹åç§°';
            }
            addItemModal.style.display = 'flex';
            addItemModalInput.focus();
        }


        function closeModal() {
            mainModal.style.display = 'none';
            deleteConfirmModal.style.display = 'none';
            addItemModal.style.display = 'none';
            currentCourseToUpdate = null;
            currentSubCourseToUpdate = null;
            itemToAddInfo = { isAdding: false, courseId: null };
        }

        function handleModalSave() {
            if (!currentCourseToUpdate) return; 
            let changed = false;

            if (currentModalMode === 'link') {
                // ... Link saving logic ...
                if (currentCourseToUpdate.isMultiLink) {
                    const dynamicInputs = modalMultiInputsContainer.querySelectorAll('input[type="url"]');
                    dynamicInputs.forEach(input => {
                        const subName = input.dataset.subCourseName;
                        const subCourse = getSubCourse(currentCourseToUpdate, subName);
                        const newUrl = input.value.trim();
                        if (newUrl && subCourse && subCourse.currentUrl !== newUrl) {
                            subCourse.currentUrl = newUrl;
                            changed = true;
                        }
                    });
                } else {
                    const newUrl = modalLinkInput.value.trim();
                    if (newUrl && currentCourseToUpdate.currentUrl !== newUrl) {
                        currentCourseToUpdate.currentUrl = newUrl;
                        changed = true;
                    }
                }
            } else if (currentModalMode === 'text') {
                // ... Text saving logic ...
                const itemToEditText = currentSubCourseToUpdate || currentCourseToUpdate;
                const newText = modalTextInput.value.trim();
                // Allow clearing the text
                if (itemToEditText.iconText !== newText) {
                    itemToEditText.iconText = newText;
                    changed = true;
                }
            }

            if (changed) {
                saveCourses();
                renderCourses(); 
                const randomMessage = encouragingMessages[Math.floor(Math.random() * encouragingMessages.length)];
                showToast(randomMessage);
            }
            closeModal();
        }
        
        function handleDeleteConfirm() {
            if (!currentCourseToUpdate) return;

            if (currentSubCourseToUpdate) {
                // Delete a sub-course
                currentCourseToUpdate.subCourses = currentCourseToUpdate.subCourses.filter(
                    sc => sc.name !== currentSubCourseToUpdate.name
                );
                 // If it becomes a single item, convert it back
                if (currentCourseToUpdate.subCourses.length === 1) {
                    const lastSubCourse = currentCourseToUpdate.subCourses[0];
                    currentCourseToUpdate.iconText = lastSubCourse.iconText || lastSubCourse.name;
                    currentCourseToUpdate.currentUrl = lastSubCourse.currentUrl;
                    currentCourseToUpdate.defaultUrl = lastSubCourse.defaultUrl;
                    delete currentCourseToUpdate.subCourses;
                    delete currentCourseToUpdate.isMultiLink;
                }

            } else {
                // Delete a main course
                courses = courses.filter(c => c.id !== currentCourseToUpdate.id);
            }
            
            saveCourses();
            renderCourses();
            showToast('é¡¹ç›®å·²åˆ é™¤ã€‚');
            closeModal();
        }
        
        function handleAddItemConfirm() {
            const newName = addItemModalInput.value.trim();
            if (!newName) {
                showToast('é¡¹ç›®åç§°ä¸èƒ½ä¸ºç©ºã€‚', true);
                return;
            }

            // Logic is only for adding sub-items now
            if (itemToAddInfo.courseId) {
                const course = courses.find(c => c.id === itemToAddInfo.courseId);
                if (!course) return;

                if (course.isMultiLink) {
                    // Already a multi-link course, just add
                    course.subCourses.push({
                        name: newName,
                        defaultUrl: `BILIBILI_${course.id.toUpperCase()}_${newName.toUpperCase()}_PLACEHOLDER`,
                        currentUrl: null,
                        iconText: newName
                    });
                } else {
                    // This is a single course, convert it
                    const originalSubCourse = {
                        name: course.name,
                        defaultUrl: course.defaultUrl,
                        currentUrl: course.currentUrl,
                        iconText: course.iconText || course.name
                    };
                    const newSubCourse = {
                        name: newName,
                        defaultUrl: `BILIBILI_${course.id.toUpperCase()}_${newName.toUpperCase()}_PLACEHOLDER`,
                        currentUrl: null,
                        iconText: newName
                    };
                    
                    course.isMultiLink = true;
                    course.subCourses = [originalSubCourse, newSubCourse];
                    delete course.iconText;
                    delete course.currentUrl;
                    delete course.defaultUrl;
                }
            } 
            
            saveCourses();
            renderCourses();
            showToast(`"${newName}" å·²æˆåŠŸæ·»åŠ ï¼`);
            closeModal();
        }


        // --- æç¤º (Toast) å‡½æ•° ---
        let toastTimeout; 
        function showToast(message, isError = false) {
            clearTimeout(toastTimeout); 
            toastMessageElement.textContent = message;
            const flowerSpans = celebrationToast.querySelectorAll('.toast-flowers');
            if (isError) {
                flowerSpans.forEach(span => span.textContent = 'âš ï¸');
                celebrationToast.style.backgroundColor = '#e74c3c'; 
            } else {
                flowerSpans[0].textContent = flowerEmojis[Math.floor(Math.random() * flowerEmojis.length)];
                flowerSpans[1].textContent = flowerEmojis[Math.floor(Math.random() * flowerEmojis.length)];
                celebrationToast.style.backgroundColor = '#2ecc71'; 
            }
            celebrationToast.classList.add('show');
            toastTimeout = setTimeout(() => {
                celebrationToast.classList.remove('show');
            }, 3500); 
        }

        // --- å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½ ---
        exportDataButton.addEventListener('click', () => {
            const data = JSON.stringify(courses, null, 2); // Pretty print JSON
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bilibili_course_tracker_data.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('è®°å½•å·²æˆåŠŸå¯¼å‡ºï¼');
        });

        importDataButton.addEventListener('click', () => importFileInput.click());

        importFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedCourses = JSON.parse(e.target.result);
                    if (Array.isArray(importedCourses)) {
                        courses = importedCourses; // Overwrite with imported data
                        saveCourses();
                        renderCourses();
                        showToast('è®°å½•å·²æˆåŠŸå¯¼å…¥ï¼');
                    } else {
                        showToast('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶å†…å®¹æ ¼å¼ä¸æ­£ç¡®ã€‚', true);
                    }
                } catch (error) {
                    showToast('å¯¼å…¥è®°å½•å¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½å·²æŸåã€‚', true);
                } finally {
                    importFileInput.value = '';
                }
            };
            reader.readAsText(file);
        });

        // --- äº‹ä»¶ç›‘å¬å™¨ç»‘å®š ---
        confirmAddItemButton.addEventListener('click', handleAddItemConfirm);
        cancelAddItemButton.addEventListener('click', closeModal);
        addItemModal.querySelector('.close-button')?.addEventListener('click', closeModal);

        editModeButton.addEventListener('click', toggleEditMode);
        modalSaveButton.addEventListener('click', handleModalSave);
        confirmDeleteButton.addEventListener('click', handleDeleteConfirm);
        cancelDeleteButton.addEventListener('click', closeModal);
        closeButton.addEventListener('click', closeModal);
        deleteConfirmModal.querySelector('.close-button')?.addEventListener('click', closeModal);

        window.addEventListener('click', (event) => {
            if (event.target === mainModal || event.target === deleteConfirmModal || event.target === addItemModal) {
                closeModal();
            }
        });
        
        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal();
            }
            if (event.key === 'Enter') {
                 if (mainModal.style.display === 'flex') handleModalSave();
                 if (deleteConfirmModal.style.display === 'flex') handleDeleteConfirm();
                 if (addItemModal.style.display === 'flex') handleAddItemConfirm();
            }
        });

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            loadCourses(); 
            renderCourses(); 
        });
    </script>
</body>
</html>
