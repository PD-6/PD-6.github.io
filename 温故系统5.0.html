<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<title>å­¦ä¹ å¤ä¹ è®¡åˆ’è¡¨ï¼ˆçƒ­åŠ›å›¾å¢å¼ºç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<!-- å¼•å…¥ canvas-confetti åŠ¨ç”»åº“ -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<style>
:root {
  /* èƒŒæ™¯ä¸åŸºè‰² */
  --bg-start: #f5f7fa;
  --bg-end: #e8f0ff;
  --card-bg: #ffffffee;
  --card-border: #dfe6f3;
  --header-bg: #eef3ff;
  --text: #2c2c2e;
  --blue: #0a84ff;
  --green: #34c759;
  --red: #ff453a;
  --orange: #ff9500;
  --purple: #af52de;
  --teal: #5ac8fa;
  --gold: #ffcc00;
  --gold-dark: #e6b800;
  --gray: #8e8e93; 
  --gray-dark: #636366;
  --indigo: #5856d6;
  --pink: #ff2d55;


  /* å½©è‰²å­¦ç§‘æ ‡ç­¾ */
  --phys: #34c759;
  --chem: #ff9500;
  --math: #0a84ff;
  --bio:  #2ecc71;
  --chi:  #af52de;
  --eng:  #ff375f;
  --poli: #5856d6;
  --hist: #ff9500;
  --geo:  #2ecc71;
}

/* ä¼˜åŒ–ç§»åŠ¨ç«¯è§¦æ§ä½“éªŒï¼Œé˜²æ­¢åŒå‡»ç¼©æ”¾ï¼Œæé«˜åŒå‡»äº‹ä»¶å“åº”ç‡ */
html {
    touch-action: manipulation; 
    height: 100%;
    margin: 0;
}

body{
  display:flex;flex-direction:column;min-height:100%;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;font-size:14px;color:var(--text);background:linear-gradient(130deg,var(--bg-start) 0%,var(--bg-end) 100%);
  transition: background 0.5s ease;
  margin: 0;
}
body.science-mode{background:linear-gradient(130deg,#fff0e6 0%,#e6f7ff 100%);}
body.arts-mode{background:linear-gradient(130deg,#fff5e6 0%,#ffe6e6 100%);}

h2{margin:24px 24px 16px;font-weight:600;display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
main{flex:1;padding:0 24px 40px;box-sizing:border-box;}

#controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px;align-items:center;}
input,button, select {font-size:14px;border-radius:10px;outline:none;}
input[type="text"],input[type="datetime-local"], select {
  padding:8px 12px;
  border:1px solid var(--card-border);
  background:#fff;
  min-width:100px;
}
input:focus, select:focus {
  border-color:var(--blue);
  box-shadow:0 0 0 2px rgba(10,132,255,.25);
}

/* =========================================
   æœç´¢é¢æ¿æ ·å¼ (ä¿®å¤ç‰ˆï¼šæ¨æ‹‰å¼)
   ========================================= */

/* æœç´¢æŒ‰é’® */
#searchIconBtn {
    background: var(--blue);
    color: white;
    padding: 8px 16px;
    border-radius: 10px;
    min-width: auto;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 4px 10px rgba(10, 132, 255, 0.3);
    font-size: 14px; 
    font-weight: 600;
    transition: transform 0.2s, background 0.2s;
}
#searchIconBtn:hover {
    transform: translateY(-1px);
    background: #0073e6;
    opacity: 0.88;
}
/* ã€ä¿®æ”¹ç‚¹ã€‘è¿™é‡ŒæŠŠç°è‰² var(--gray-dark) æ”¹æˆäº†æ©™è‰² var(--orange) */
#searchIconBtn.active {
    background: var(--orange); 
    transform: none;
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.1); /* åŠ ä¸€ç‚¹å†…é˜´å½±æ›´æœ‰æŒ‰ä¸‹çš„æ„Ÿè§‰ */
}

/* ç­›é€‰é¢æ¿å®¹å™¨ - ç‹¬ç«‹å æ®ä¸€è¡Œï¼Œä¸é®æŒ¡è¡¨æ ¼ */
#filterPanel {
    display: none; /* é»˜è®¤éšè— */
    width: 100%;
    background: rgba(255, 255, 255, 0.6);
    border: 1px solid var(--card-border);
    box-shadow: inset 0 2px 6px rgba(0,0,0,0.03);
    padding: 15px;
    border-radius: 14px;
    margin-bottom: 20px; /* å¢åŠ åº•éƒ¨é—´è·ï¼Œæ¨å¼€è¡¨æ ¼ */
    box-sizing: border-box;
    
    /* å†…éƒ¨å¸ƒå±€ */
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
    
    /* åŠ¨ç”» */
    animation: slideDown 0.3s ease-out forwards;
}

#filterPanel.show {
    display: flex;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* -------------------------------------
   UI æ ·å¼
   ------------------------------------- */
#searchInput {
    flex: 1; /* è®©æœç´¢æ¡†ç¨å¾®é•¿ä¸€ç‚¹ */
    min-width: 200px;
    border: 1px solid var(--blue);
    background-color: #fff; 
    color: #333; /* å¼ºåˆ¶å­—ä½“é¢œè‰²ï¼Œé˜²æ­¢çœ‹ä¸è§ */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%230a84ff' width='18px' height='18px'%3E%3Cpath d='M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: 12px center;
    padding-left: 38px;
    border-radius: 20px;
}
#searchInput:focus {
    box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.2);
}

#yearFilterSelect, #monthFilterSelect, #importanceFilterSelect {
    border-radius: 8px;
    background-color: #f0f0f5; 
    border-color: #d1d1d6;
}

button {
  padding: 8px 16px;
  border: none;
  font-weight: 600;
  color: #fff;
  cursor: pointer;
  white-space: nowrap;
  transition: background-color 0.2s ease-in-out, opacity 0.2s ease-in-out, transform 0.1s ease;
  border-radius: 10px;
}
button:hover { opacity: 0.88; }
button:active { opacity: 0.75; transform: translateY(1px); }

#addBtn { background: var(--blue); }
#todayBtn { background: var(--blue); }
#next7DaysBtn { background: var(--teal); }
#next7DaysBtn:hover { background: #4cb8e0; opacity: 1;}
#next7DaysBtn:active { background: #3aa8d0; opacity: 1;}

#clearFilterBtn { background: var(--gold); color: #333; font-weight: 600;}
#clearFilterBtn:hover { background: var(--gold-dark); opacity: 1;}
#clearFilterBtn:active { background: #cca300; opacity: 1;}

#scrollToBottomBtn { background: var(--indigo); padding: 8px 12px; font-size: 16px; line-height: 1;}
#scrollToBottomBtn:hover { background: #4744b3; opacity: 1;}
#scrollToBottomBtn:active { background: #363399; opacity: 1;}

.modeBtn.science { background: var(--orange); }
.modeBtn.arts { background: var(--purple); }
#exportBtn { background: var(--green); }
#importBtn { background: var(--purple); }
#statsBtn { background: var(--indigo); }

#addBtn:hover, #todayBtn:hover { background: #0073e6; opacity: 1; }
#addBtn:active, #todayBtn:active { background: #005cb3; opacity: 1; }
.modeBtn.science:hover { background: #e68600; opacity: 1; }
.modeBtn.science:active { background: #cc7700; opacity: 1; }
.modeBtn.arts:hover { background: #9d3cce; opacity: 1; }
.modeBtn.arts:active { background: #8b2db4; opacity: 1; }
#exportBtn:hover { background: #2fa84f; opacity: 1; }
#exportBtn:active { background: #268540; opacity: 1; }
#importBtn:hover { background: #9d3cce; opacity: 1; }
#importBtn:active { background: #8b2db4; opacity: 1; }
#statsBtn:hover { background: #4744b3; opacity: 1; }


.table-wrap{overflow-x:auto; margin-top: 0px;}
table{width:100%;border-collapse:collapse;background:var(--card-bg);border:1px solid var(--card-border);border-radius:14px;box-shadow:0 8px 24px rgba(60,64,67,.1);}
th,td{padding:12px 8px;text-align:center;border-bottom:1px solid var(--card-border); font-size: 13px; vertical-align: middle;}
th{background:var(--header-bg);font-weight:600;white-space:nowrap; font-size: 14px;}

th:first-child,
td:first-child {
  border-right: 1px solid var(--card-border);
}
td:first-child {
    font-weight: 600;
}

th:nth-child(5),
td:nth-child(5) {
  border-right: 1px solid var(--card-border);
}

tr:last-child td{border-bottom:none;}
td:nth-child(2) { text-align: left; }
td:nth-child(4) { min-width: 100px; }

th.compact-date-header {
    min-width: 55px;
    padding-left: 4px;
    padding-right: 4px;
}
th.double-compact-header {
    min-width: 110px;
    padding-left: 4px;
    padding-right: 4px;
}
th.full-date-header {
    min-width: 120px;
    padding-left: 4px;
    padding-right: 4px;
}

.date-cell-container { line-height: 1.25; }
.date-month { font-size: 10px; color: var(--blue); font-weight: 600; display: block; }
.date-day { font-size: 16px; font-weight: 600; display: block; }

/* åŠ¨ç”»æ•ˆæœåº“ */
.anim-jello { animation: jello-horizontal var(--anim-duration, 0.9s) both; }
@keyframes jello-horizontal {
  11.1% { transform: none; } 22.2% { transform: skewX(-12.5deg) skewY(-12.5deg); } 33.3% { transform: skewX(6.25deg) skewY(6.25deg); } 44.4% { transform: skewX(-3.125deg) skewY(-3.125deg); } 55.5% { transform: skewX(1.5625deg) skewY(1.5625deg); } 66.6% { transform: skewX(-0.78125deg) skewY(-0.78125deg); } 77.7% { transform: skewX(0.390625deg) skewY(0.390625deg); } 88.8% { transform: skewX(-0.1953125deg) skewY(-0.1953125deg); } 100% { transform: none; }
}

.anim-pulse { animation: pulse var(--anim-duration, 0.7s) cubic-bezier(.36,.07,.19,.97) both; }
@keyframes pulse {
  0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); }
}

.anim-flash { animation: flash var(--anim-duration, 0.7s); }
@keyframes flash {
  0%, 100% { opacity: 1; } 50% { opacity: 0.2; }
}

.anim-fade-in { animation: fadeIn var(--anim-duration, 0.5s) ease-in-out; }
@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); }
}

.anim-wobble { animation: wobble-sm var(--anim-duration, 0.8s) ease-in-out; }
@keyframes wobble-sm {
    15% { transform: translateY(-4px); } 30% { transform: translateY(2px); } 45% { transform: translateY(-2px); } 60% { transform: translateY(1px); } 75% { transform: translateY(-1px); } 100% { transform: translateY(0); }
}

.anim-flip { animation: flip-h var(--anim-duration, 0.6s) ease-in-out; }
@keyframes flip-h {
    0% { transform: perspective(400px) rotate3d(0, 1, 0, -360deg); } 100% { transform: perspective(400px) rotate3d(0, 1, 0, 0); }
}


.label{display:inline-block;padding:3px 7px;border-radius:6px;font-size:11px;font-weight:600;color:#fff;margin:2px; line-height: 1.4;}
.label-ç‰©ç†{background:var(--phys);}
.label-åŒ–å­¦{background:var(--chem);}
.label-æ•°å­¦{background:var(--math);}
.label-ç”Ÿç‰©{background:var(--bio);}
.label-è¯­æ–‡{background:var(--chi);}
.label-è‹±è¯­{background:var(--eng);}
.label-æ”¿æ²»{background:var(--poli);}
.label-å†å²{background:var(--hist);}
.label-åœ°ç†{background:var(--geo);}
.label-gray{background:#a0a0a5;color:#fff;font-weight:500;}

.label-é‡è¦ { background: var(--red); }
.label-ä¸€èˆ¬ { background: #a0a0a5; }

td.clickable-cell { cursor: pointer; }
td.clickable-cell:hover { background-color: #f0f0f030; }


.deleteBtn{cursor:pointer;color:var(--red);font-weight:700;font-size:16px;} .deleteBtn:hover{opacity:.7;}

#reviewListContainer h3 { margin-bottom: 8px; }
#reviewList {
    list-style-type: none;
    padding-left: 0;
    margin-top: 10px;
}
#reviewList li {
    background-color: #f9f9f9;
    border: 1px solid #eee;
    padding: 8px 12px;
    margin-bottom: 5px;
    border-radius: 6px;
    font-size: 13px;
    cursor: pointer;
    transition: background-color 0.2s, transform 0.1s;
}
#reviewList li:hover {
    background-color: #eef3ff;
    transform: translateX(3px);
}

#reviewList li.overdue-item {
    border-left: 4px solid var(--red);
    background-color: #fff0f0;
}
#reviewList li.overdue-item .stage-info {
    color: var(--red);
    font-weight: 700;
}

@keyframes highlightRow {
    0% { background-color: rgba(255, 235, 59, 0.4); transform: scale(1.01); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    50% { background-color: rgba(255, 235, 59, 0.2); }
    100% { background-color: transparent; transform: scale(1); box-shadow: none; }
}
.highlight-row-anim {
    animation: highlightRow 2s ease-out forwards;
}

.group-separator {
  border-right: 2px solid #a9b8d3;
}

#toast-container {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}
.toast {
    padding: 12px 20px;
    background-color: rgba(44, 44, 46, 0.85);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: white;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: fadeInOut 4s ease-in-out forwards;
    opacity: 0;
}

.toast.special-final-toast {
    font-size: 1.15em;
    font-weight: 700;
    color: transparent;
    background: linear-gradient(45deg, #ffdd57, #ff375f, #af52de, #5ac8fa);
    background-size: 200% 200%;
    -webkit-background-clip: text;
    background-clip: text;
    animation: fadeInOut 4s ease-in-out forwards, gradient-animation 4s ease-in-out infinite;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(4px);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}
.modal-overlay.active {
    opacity: 1;
    pointer-events: auto;
}
.modal {
    background: var(--card-bg);
    width: 90%;
    max-width: 700px;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    transform: scale(0.95);
    transition: transform 0.3s ease;
    max-height: 85vh;
    overflow-y: auto;
    border: 1px solid rgba(255,255,255,0.8);
}
.modal-overlay.active .modal {
    transform: scale(1);
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}
.modal-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
}
.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--gray);
    cursor: pointer;
    padding: 0;
}
.modal-close:hover {
    color: var(--red);
}

/* ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}
.stat-card {
    background: #fff;
    padding: 15px;
    border-radius: 12px;
    border: 1px solid var(--card-border);
    text-align: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.03);
    transition: all 0.3s ease;
}
/* å¢åŠ ç»Ÿè®¡å¡ç‰‡åŠ¨æ€æ›´æ–°æ—¶çš„æ•ˆæœ */
.stat-card.updating {
    transform: scale(1.05);
    box-shadow: 0 8px 15px rgba(10, 132, 255, 0.15);
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--blue);
    margin-bottom: 5px;
}
.stat-label {
    font-size: 13px;
    color: var(--gray-dark);
}

.stats-section-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 15px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--card-border);
    color: var(--text);
    display: flex;
    justify-content: space-between;
    align-items: baseline;
}
.chart-container {
    margin-bottom: 25px;
}
.bar-row {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    font-size: 13px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 8px;
    transition: all 0.2s ease;
    user-select: none; /* é˜²æ­¢åŒå‡»æ—¶é€‰ä¸­æ–‡æœ¬ */
}
/* äº¤äº’æ ·å¼ï¼šæ‚¬åœã€é€‰ä¸­ã€æœªé€‰ä¸­å˜æš— */
.bar-row:hover {
    background-color: rgba(10, 132, 255, 0.05);
}
.bar-row.active-filter {
    background-color: rgba(10, 132, 255, 0.1);
    font-weight: 600;
    border: 1px solid rgba(10, 132, 255, 0.2);
}
.bar-row.dimmed {
    opacity: 0.4;
    filter: grayscale(0.5);
}
.bar-row.dimmed:hover {
    opacity: 0.8;
}

.bar-label {
    width: 80px;
    text-align: right;
    padding-right: 10px;
    color: var(--gray-dark);
    font-weight: 500;
}
.bar-track {
    flex: 1;
    background: #f0f0f5;
    height: 12px;
    border-radius: 6px;
    overflow: hidden;
    position: relative;
}
.bar-fill {
    height: 100%;
    border-radius: 6px;
    background: var(--blue);
    transition: width 0.6s cubic-bezier(0.2, 0.9, 0.4, 1);
}
.bar-value {
    margin-left: 10px;
    width: 40px;
    color: var(--gray);
}

/* å‚ç›´æŸ±çŠ¶å›¾ (é¢„æµ‹åŠŸèƒ½æ–°å¢) */
.forecast-chart {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    height: 120px;
    margin-top: 20px;
    padding-bottom: 5px;
    border-bottom: 1px solid var(--card-border);
}
.forecast-bar-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    height: 100%;
    justify-content: flex-end;
    gap: 5px;
}
.forecast-bar {
    width: 20px; 
    background-color: var(--blue);
    border-radius: 4px 4px 0 0;
    transition: height 0.5s ease;
    min-height: 2px;
}
.forecast-label {
    font-size: 10px;
    color: var(--gray-dark);
}
.forecast-value {
    font-size: 10px;
    font-weight: bold;
    color: var(--blue);
    margin-bottom: 2px;
}
/* ç»Ÿè®¡åŒºå°æ ‡é¢˜ */
.stats-section-header {
    margin-top: 30px;
    font-size: 15px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 15px;
    border-left: 4px solid var(--blue);
    padding-left: 10px;
}

/* =========================================
   Github é£æ ¼çƒ­åŠ›å›¾æ ·å¼
   ========================================= */
.heatmap-container {
    overflow-x: auto;
    padding: 15px; /* å¢åŠ å†…è¾¹è· */
    padding-bottom: 10px;
    background: #fcfcfc; /* å¢åŠ æµ…è‰²èƒŒæ™¯ */
    border: 1px solid #e1e4e8; /* å¢åŠ è¾¹æ¡† */
    border-radius: 8px; /* åœ†è§’ */
    /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™æ»šåŠ¨åŠŸèƒ½ */
    scrollbar-width: thin;
}
.heatmap-container::-webkit-scrollbar {
    height: 6px;
}
.heatmap-container::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 3px;
}

.heatmap-grid {
    display: grid;
    /* 7è¡Œä»£è¡¨å‘¨æ—¥åˆ°å‘¨å…­ */
    grid-template-rows: repeat(7, 12px);
    grid-auto-flow: column; /* è‡ªåŠ¨å‘å³æ’åˆ—åˆ— */
    gap: 4px; /* å¢åŠ é—´è· */
    width: max-content;
}

.heatmap-cell {
    width: 12px;
    height: 12px;
    border-radius: 2px;
    background-color: #ebedf0; /* é»˜è®¤ç©ºé¢œè‰² */
    cursor: pointer;
    transition: transform 0.1s;
    position: relative;
}
.heatmap-cell:hover {
    transform: scale(1.3);
    z-index: 10;
    border: 1px solid rgba(0,0,0,0.1);
}

/* è¿‡å» Activity é¢œè‰² (ç»¿è‰²) */
.color-scale-green-0 { background-color: #ebedf0; }
.color-scale-green-1 { background-color: #9be9a8; }
.color-scale-green-2 { background-color: #40c463; }
.color-scale-green-3 { background-color: #30a14e; }
.color-scale-green-4 { background-color: #216e39; }

/* æœªæ¥ Workload é¢œè‰² (ç°è‰²/è“è‰²) */
.color-scale-gray-0 { background-color: #ebedf0; }
.color-scale-gray-1 { background-color: #d1d5db; }
.color-scale-gray-2 { background-color: #9ca3af; }
.color-scale-gray-3 { background-color: #6b7280; }
.color-scale-gray-4 { background-color: #374151; }

/* çƒ­åŠ›å›¾å›¾ä¾‹ */
.heatmap-legend {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 4px;
    font-size: 11px;
    color: #586069;
    margin-top: 8px;
}
.legend-item {
    width: 10px;
    height: 10px;
    border-radius: 2px;
    display: inline-block;
}


@keyframes fadeInOut {
    0%, 100% { opacity: 0; transform: translateY(20px); }
    10%, 90% { opacity: 1; transform: translateY(0); }
}

@keyframes gradient-animation {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}


@media(max-width:720px){
    h2 { font-size: 1.25em; margin: 16px 16px 12px;}
    main { padding: 0 16px 24px; }
    #controls { gap: 8px; }
    input, button, select { font-size: 13px; padding: 8px 12px;}
    th, td { padding: 8px 4px; font-size: 12px; }
    .label { font-size: 10px; padding: 2px 5px; }
    .stats-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<h2>
  å­¦ä¹ å¤ä¹ è®¡åˆ’è¡¨
  <button id="scienceModeBtn" class="modeBtn science" title="ä»…æ˜¾ç¤ºç†ç§‘æ¡ç›®">ç†ç§‘æ¨¡å¼</button>
  <button id="artsModeBtn" class="modeBtn arts" title="ä»…æ˜¾ç¤ºæ–‡ç§‘æ¡ç›®">æ–‡ç§‘æ¨¡å¼</button>
</h2>
<main>
  <div id="controls">
    <!-- ç¬¬ä¸€è¡Œï¼šæ·»åŠ åŒºåŸŸ -->
    <input id="conceptInput" type="text" placeholder="å­¦ä¹ å†…å®¹ (ä¾‹å¦‚ï¼šç‰›é¡¿ç¬¬ä¸€å®šå¾‹)">
    <input id="tagsInput" type="text" placeholder="æ ‡ç­¾ (ä¾‹å¦‚ï¼šç‰©ç†,åŠ›å­¦)">
    <input id="dateInput" type="datetime-local">
    <select id="importanceSelect">
        <option value="ä¸€èˆ¬">ä¸€èˆ¬</option>
        <option value="é‡è¦">é‡è¦</option>
    </select>
    <button id="addBtn">æ·»åŠ å­¦ä¹ é¡¹</button>
    
    <!-- æœç´¢/ç­›é€‰åŒºåŸŸå¼€å…³ -->
    <button id="searchIconBtn" title="ç‚¹å‡»å±•å¼€æœç´¢ï¼Œå†æ¬¡ç‚¹å‡»æ¸…ç©ºå¹¶æ”¶èµ·">æœç´¢</button>

    <button id="scrollToBottomBtn" title="ç›´è¾¾åº•éƒ¨">â†“</button>
    <hr style="width:100%; border: none; border-top: 1px solid var(--card-border); margin: 5px 0;">
    <button id="todayBtn">ä»Šæ—¥å¤ä¹ </button>
    <button id="next7DaysBtn">æœªæ¥7æ—¥å¤ä¹ </button>
    <button id="exportBtn">å¯¼å‡ºæ•°æ®</button>
    <button id="importBtn">å¯¼å…¥æ•°æ®</button>
    <button id="statsBtn" title="æŸ¥çœ‹å­¦ä¹ æ•°æ®ç»Ÿè®¡">ğŸ“Š æ•°æ®ç»Ÿè®¡</button>

    <select id="animationSelect" title="é€‰æ‹©ç‚¹å‡»åŠ¨æ•ˆ">
        <option value="anim-pulse">åŠ¨æ•ˆ: è„‰å†²</option>
        <option value="anim-flash">åŠ¨æ•ˆ: é—ªçƒ</option>
        <option value="anim-fade-in">åŠ¨æ•ˆ: æµ®ç°</option>
        <option value="anim-wobble">åŠ¨æ•ˆ: å¾®æ‘†</option>
        <option value="anim-flip">åŠ¨æ•ˆ: ç¿»è½¬</option>
        <option value="anim-jello">åŠ¨æ•ˆ: æœå†»</option>
        <option value="none">æ— åŠ¨æ•ˆ</option>
    </select>
    <select id="animationSpeedSelect" title="é€‰æ‹©åŠ¨ç”»é€Ÿåº¦">
        <option value="0.2s">é€Ÿåº¦: å¿«</option>
        <option value="0.4s">é€Ÿåº¦: ä¸­</option>
        <option value="0.8s">é€Ÿåº¦: æ…¢</option>
    </select>
  </div>
  
  <!-- ç‹¬ç«‹çš„ç­›é€‰é¢æ¿ï¼ˆä¿®å¤é®æŒ¡é—®é¢˜ï¼‰ -->
  <div id="filterPanel">
        <input id="searchInput" type="text" placeholder="æœç´¢å†…å®¹æˆ–æ ‡ç­¾..." title="å®æ—¶ç­›é€‰">
        <select id="yearFilterSelect">
        <option value="">é€‰æ‹©å¹´ä»½</option>
    </select>
    <select id="monthFilterSelect">
        <option value="">é€‰æ‹©æœˆä»½</option>
        <option value="1">1æœˆ</option><option value="2">2æœˆ</option><option value="3">3æœˆ</option>
        <option value="4">4æœˆ</option><option value="5">5æœˆ</option><option value="6">6æœˆ</option>
        <option value="7">7æœˆ</option><option value="8">8æœˆ</option><option value="9">9æœˆ</option>
        <option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
    </select>
    <select id="importanceFilterSelect">
        <option value="">å…¨éƒ¨</option>
        <option value="é‡è¦">é‡è¦</option>
        <option value="ä¸€èˆ¬">ä¸€èˆ¬</option>
    </select>
    <button id="clearFilterBtn">æ¸…é™¤ç­›é€‰</button>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>åº</th><th>å­¦ä¹ å†…å®¹</th><th>é‡è¦æ€§</th><th>æ ‡ç­¾</th><th>åˆå­¦æ—¥æœŸ</th>
          <th class="compact-date-header">1å¤©</th><th class="compact-date-header group-separator">2å¤©</th>
          <th class="double-compact-header group-separator">3-4å¤©</th>
          <th class="compact-date-header">1å‘¨</th><th class="compact-date-header group-separator">2å‘¨</th>
          <th class="compact-date-header">1ä¸ªæœˆ</th><th class="compact-date-header group-separator">2ä¸ªæœˆ</th>
          <th class="full-date-header group-separator">3ä¸ªæœˆ</th>
          <th class="full-date-header group-separator">6ä¸ªæœˆ</th>
          <th class="full-date-header">1å¹´</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div id="reviewListContainer">
    <h3 id="reviewListTitle">ä»Šæ—¥å¾…å¤ä¹ </h3>
    <ul id="reviewList"></ul>
  </div>
  
  <div id="toast-container"></div>
</main>

<!-- ç»Ÿè®¡æ¨¡æ€æ¡† -->
<div id="statsModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">ğŸ“Š å­¦ä¹ æ•°æ®åˆ†æ</div>
            <button class="modal-close" id="closeStatsBtn">Ã—</button>
        </div>
        <div id="statsContent">
            <!-- åŠ¨æ€ç”Ÿæˆå†…å®¹ -->
        </div>
    </div>
</div>

<script>
/**************** å…¨å±€æ•°æ® ****************/
const sciences=["ç‰©ç†","åŒ–å­¦","æ•°å­¦","ç”Ÿç‰©"];
const arts=["è¯­æ–‡","è‹±è¯­","æ”¿æ²»","å†å²", "åœ°ç†"];
const colorSubjects = {
    "ç‰©ç†": "ç‰©ç†", "åŒ–å­¦": "åŒ–å­¦", "æ•°å­¦": "æ•°å­¦", "ç”Ÿç‰©": "ç”Ÿç‰©",
    "è¯­æ–‡": "è¯­æ–‡", "è‹±è¯­": "è‹±è¯­", "æ”¿æ²»": "æ”¿æ²»", "å†å²": "å†å²", "åœ°ç†": "åœ°ç†"
};

let scienceMode=false, artsMode=false;
let currentSelectedYear = "";
let currentSelectedMonth = "";
let currentImportanceFilter = "";
let currentSearchQuery = ""; // æ–°å¢ï¼šæœç´¢å…³é”®è¯
let lastAnimatedCell = null; 
let currentAnimationEffect = 'anim-pulse'; 
let currentAnimationSpeed = '0.4s'; 
let selectedStatsTags = new Set(); // å‡çº§ï¼šä½¿ç”¨ Set æ”¯æŒå¤šé€‰

const intervals=[1*24*60, 2*24*60, 4*24*60, 7*24*60, 14*24*60, 30*24*60, 60*24*60, 90*24*60, 180*24*60, 365*24*60];
const stageNames=["1å¤©å", "2å¤©å", "3-4å¤©å", "1å‘¨å", "2å‘¨å", "1ä¸ªæœˆå", "2ä¸ªæœˆå", "3ä¸ªæœˆå", "6ä¸ªæœˆå", "1å¹´å"];
const reviewGroups = [[0, 1], [2], [3, 4], [5, 6], [7], [8], [9]];
const groupColors = ['#FF3B30', '#FF9500', '#FFCC00', '#34C759', '#007AFF', '#5856D6', '#AF52DE'];

// ç¾¤ç»„åç§°ï¼ˆç”¨äºå¤ä¹ åˆ—è¡¨æ˜¾ç¤ºï¼‰
const groupDisplayNames = ["1-2å¤©", "3-4å¤©", "1-2å‘¨", "1-2æœˆ", "3ä¸ªæœˆ", "6ä¸ªæœˆ", "1å¹´"];

/**************** å·¥å…·å‡½æ•° ****************/
const pad=n=>String(n).padStart(2,'0');

// ä¿®å¤1ï¼šæ·»åŠ  HTML è½¬ä¹‰å‡½æ•°ï¼Œé˜²æ­¢ XSS æ”»å‡»
function escapeHtml(text) {
  if (!text) return text;
  return text.replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
}

function isValidDate(d) {
  return d instanceof Date && !isNaN(d.getTime());
}

function isoLocal(d){
  if (!isValidDate(d)) d = new Date();
  return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16);
}

function computeSchedule(baseDate, importance){
  if (!isValidDate(baseDate)) return [];
  const baseTimestamp = baseDate.getTime();
  return intervals.map((minutes, index) => {
      // å³ä½¿æ˜¯â€œä¸€èˆ¬â€é‡è¦æ€§çš„ç¬¬2é˜¶æ®µï¼Œä¹Ÿè®¡ç®—å‡ºæ—¥æœŸï¼Œé¿å…è¿”å› null å¯¼è‡´åç»­å´©æºƒã€‚
      // UI æ¸²æŸ“æ—¶ä¼šæ ¹æ®é‡è¦æ€§å†³å®šæ˜¯å¦æ˜¾ç¤ºã€‚
      return new Date(baseTimestamp + minutes * 60000);
  });
}

function fmtInit(d){
  if (!isValidDate(d)) return "æ—¥æœŸæ— æ•ˆ";
  return`${d.getFullYear()}å¹´${pad(d.getMonth()+1)}æœˆ${pad(d.getDate())}æ—¥ ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function fmtStage(d, stageIndex, initialYear){
  if (!isValidDate(d)) return "æ—¥æœŸæ— æ•ˆ";
  const year=d.getFullYear(), month=pad(d.getMonth()+1), day=pad(d.getDate());
  if(year !== initialYear) return`${year}å¹´${month}æœˆ${day}æ—¥`;
  return`${month}æœˆ${day}æ—¥`;
}

function fmtStageCompact(d) {
    if (!isValidDate(d)) return "æ—¥æœŸæ— æ•ˆ";
    const month = pad(d.getMonth() + 1);
    const day = pad(d.getDate());
    return `<div class="date-cell-container"><span class="date-month">${month}æœˆ</span><span class="date-day">${day}</span></div>`;
}

function fmtStageCompactRange(d1, d2) {
    if (!isValidDate(d1) || !isValidDate(d2)) return "æ—¥æœŸæ— æ•ˆ";

    const month1 = pad(d1.getMonth() + 1);
    const day1 = pad(d1.getDate());
    const month2 = pad(d2.getMonth() + 1);
    const day2 = pad(d2.getDate());

    let monthDisplay, dayDisplay;
    monthDisplay = `${month1}æœˆ`;
    if (month1 === month2) {
        dayDisplay = `${day1}-${day2}`;
    } else {
        dayDisplay = `${day1}-${month2}/${day2}`;
    }
    return `<div class="date-cell-container"><span class="date-month">${monthDisplay}</span><span class="date-day">${dayDisplay}</span></div>`;
}

function getCalendarDaysDiff(dateFrom, dateTo) {
    const oneDay = 1000 * 60 * 60 * 24;
    const d1 = new Date(dateFrom.getFullYear(), dateFrom.getMonth(), dateFrom.getDate());
    const d2 = new Date(dateTo.getFullYear(), dateTo.getMonth(), dateTo.getDate());
    const diffTime = d2 - d1;
    return Math.floor(diffTime / oneDay);
}

function generateUUID() {
    if (typeof crypto !== 'undefined' && crypto.randomUUID) {
        return crypto.randomUUID();
    }
    return Date.now().toString() + Math.random().toString(36).substr(2, 9);
}


/**************** åº†ç¥åŠ¨ç”»ä¸æç¤º ****************/
const toastContainer = document.getElementById('toast-container');

function showToast(message, isSpecial = false) {
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    
    if (isSpecial) {
        toast.classList.add('special-final-toast');
    }
    
    toastContainer.appendChild(toast);
    setTimeout(() => {
        toast.remove();
    }, 4000);
}

function triggerCelebration(groupIndex) {
    const messages = [
        [ "æ¸©æ•…è€ŒçŸ¥æ–°ï¼Œä¸é”™çš„ç¬¬ä¸€æ­¥ï¼", "å¼€ç«¯è‰¯å¥½ï¼ŒåšæŒä¸‹å»ï¼", "çŸ¥è¯†çš„ç§å­å·²ç»æ’­ä¸‹ï¼Œè®°å¾—æŒ‰æ—¶æµ‡æ°´å“¦ï¼", "ç¬¬ä¸€æ¬¡å¤ä¹ ï¼Œæ„Ÿè§‰å¾ˆæ£’ï¼" ],
        [ "çŸ­æœŸè®°å¿†å·©å›ºä¸­ï¼", "3-4å¤©äº†ï¼Œå°è±¡ä¾ç„¶æ¸…æ™°ï¼", "å¤ä¹ å°èƒ½æ‰‹å°±æ˜¯ä½ ï¼", "è¶çƒ­æ‰“é“ï¼Œæ•ˆæœåŠ å€ï¼" ], 
        [ "è®°å¿†æ­£åœ¨è¢«å·©å›ºï¼ŒåšæŒå°±æ˜¯èƒœåˆ©ï¼", "é‡å¤æ˜¯è®°å¿†ä¹‹æ¯ï¼Œä½ åšå¾—å¾ˆæ£’ï¼", "åˆå®Œæˆäº†ä¸€æ¬¡å¤ä¹ ï¼Œç¦»å­¦éœ¸åˆè¿‘äº†ä¸€æ­¥ï¼", "åšæŒå°±æ˜¯åŠ›é‡ï¼Œç»§ç»­åŠ æ²¹ï¼" ],
        [ "å¤ªæ£’äº†ï¼ä½ æ­£æŠŠçŸ¥è¯†å˜æˆé•¿æœŸè®°å¿†ï¼", "çŸ¥è¯†æ­£åœ¨å†…åŒ–ï¼Œä½ çš„åŠªåŠ›å“æœ‰æˆæ•ˆï¼", "æ„Ÿè§‰è®°ä¸œè¥¿è¶Šæ¥è¶Šè½»æ¾äº†ï¼Ÿè¿™æ˜¯ä½ åº”å¾—çš„ï¼", "å‰å®³äº†ï¼è¿™ä¸ªçŸ¥è¯†ç‚¹å¿«è¢«ä½ â€œç„Šâ€åœ¨è„‘å­é‡Œäº†ï¼" ],
        [ "äº†ä¸èµ·çš„æ¯…åŠ›ï¼çŸ¥è¯†å·²åœ¨ä½ è„‘ä¸­ç”Ÿæ ¹å‘èŠ½ï¼", "ç»è¿‡è¿™æ¬¡å¤ä¹ ï¼Œè¿™ä¸ªçŸ¥è¯†ç‚¹å·²ç»å¾ˆéš¾å¿˜è®°äº†ï¼", "ä½ çš„åšæŒä»¤äººä½©æœï¼Œç»§ç»­ä¿æŒï¼", "å­¦æµ·æ— æ¶¯ï¼Œä½†ä½ å·²ç»èˆªè¡Œäº†å¾ˆè¿œï¼" ],
        [ "ä½ å·²æ˜¯è¯¥é¢†åŸŸçš„â€œä¸“å®¶â€ï¼ç¦»æˆåŠŸä¸è¿œå•¦ï¼", "è¿™ä¸ªçŸ¥è¯†ç‚¹å¯¹ä½ æ¥è¯´å·²ç»æ˜¯è€æœ‹å‹äº†ï¼", "å¤ªç¨³äº†ï¼çŸ¥è¯†å¤§å¦çš„åœ°åŸºå·²ç»ç‰¢ä¸å¯ç ´ã€‚", "åŠå¹´äº†è¿˜è®°å¾—ï¼Œä½ å¤ªå¼ºäº†ï¼" ],
        [ { text: "æ­å–œä½ å·²ç»å®Œæˆäº†å¯¹è¿™ä¸ªçŸ¥è¯†ç‚¹æ‰€æœ‰é˜¶æ®µçš„å¤ä¹ ,èƒœåˆ©æŒ‡æ—¥å¯å¾…åŠ æ²¹ï¼", special: true } ]
    ];
    
    if (messages[groupIndex] && messages[groupIndex].length > 0) {
        const messageOptions = messages[groupIndex];
        const randomMessageData = messageOptions[Math.floor(Math.random() * messageOptions.length)];
        
        if (typeof randomMessageData === 'object' && randomMessageData.special) {
            showToast(randomMessageData.text, true);
        } else {
            showToast(randomMessageData, false);
        }
    }
    
    switch(groupIndex) {
        case 0: confetti({ particleCount: 60, spread: 70, origin: { y: 0.6 }, colors: ['#0a84ff', '#34c759', '#ff9500'] }); break;
        case 1: confetti({ particleCount: 80, spread: 80, origin: { y: 0.65 }, colors: ['#ffcc00', '#ff9500', '#34c759'] }); break; 
        case 2: confetti({ particleCount: 100, spread: 100, origin: { y: 0.7 }, colors: ['#0a84ff', '#34c759', '#ff9500', '#ff375f'] }); break; 
        case 3: confetti({ particleCount: 150, angle: 90, spread: 140, origin: { x: 0.5, y: 1 }, drift: 0, scalar: 1.2, colors: ['#0a84ff', '#5ac8fa', '#af52de', '#ffcc00']}); break; 
        case 4: case 5: 
            const duration = 1.5 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };
            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                const particleCount = 50 * (timeLeft / duration);
                confetti({ ...defaults, particleCount, origin: { x: Math.random(), y: Math.random() - 0.2 } });
            }, 250);
            break;
        case 6: 
            confetti({ particleCount: 150, angle: 60, spread: 65, origin: { x: 0 }, colors: ['#ffcc00', '#ff375f', '#af52de'] });
            confetti({ particleCount: 150, angle: 120, spread: 65, origin: { x: 1 }, colors: ['#ffcc00', '#ff375f', '#af52de'] });
            setTimeout(() => {
                confetti({ particleCount: 100, spread: 200, startVelocity: 25, shapes: ['star'], origin: { y: 0 }, colors: ['#ffcc00', '#ffffff'] });
            }, 300);
            break;
    }
}

/**************** æ•°æ®åŠ è½½ä¸å¤„ç† ****************/
function revive(arr) {
  if (!Array.isArray(arr)) { return []; }
  return arr.map(item => {
    if (typeof item !== 'object' || item === null) { return null; }
    item.id = String(item.id || generateUUID());
    item.concept = typeof item.concept === 'string' ? item.concept.trim() : "æœªå‘½åå†…å®¹";
    item.importance = typeof item.importance === 'string' ? item.importance : 'ä¸€èˆ¬';
    if (item.subject && !item.tags) {
      item.tags = Array.isArray(item.subject) ? item.subject : (typeof item.subject === 'string' ? [item.subject.trim()] : []);
      delete item.subject;
    } else {
      item.tags = Array.isArray(item.tags) ? item.tags : [];
    }
    item.tags = item.tags.map(t => String(t || '').trim()).filter(Boolean);
    const initialDate = new Date(item.initial);
    item.initial = initialDate;
    // é‡æ–°è®¡ç®— scheduleï¼Œç¡®ä¿æ²¡æœ‰ null
    item.schedule = isValidDate(initialDate) ? computeSchedule(initialDate, item.importance) : [];
    const newReviewed = Array(intervals.length).fill(false);
    if (Array.isArray(item.reviewed)) {
        for(let i = 0; i < Math.min(newReviewed.length, item.reviewed.length); i++) {
            newReviewed[i] = item.reviewed[i] || false;
        }
    }
    item.reviewed = newReviewed;

    // æ–°å¢ï¼šåˆå§‹åŒ– reviewLog (ç”¨äºçƒ­åŠ›å›¾ç»Ÿè®¡çœŸå®å¤ä¹ æ—¶é—´)
    // è¿™æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œkeyä¸ºé˜¶æ®µindexï¼Œvalueä¸ºæ—¶é—´æˆ³å­—ç¬¦ä¸²
    if (!item.reviewLog || typeof item.reviewLog !== 'object') {
        item.reviewLog = {};
    }

    return item;
  }).filter(item => item !== null && isValidDate(item.initial));
}

let data = [];
try {
  const storedData = localStorage.getItem('scheduleData');
  if (storedData) { data = revive(JSON.parse(storedData)); }
} catch (e) {
  console.error("Error parsing or reviving data from localStorage:", e);
  data = [];
  alert('åŠ è½½æœ¬åœ°æ•°æ®æ—¶å‡ºé”™ï¼Œéƒ¨åˆ†æ•°æ®å¯èƒ½æœªèƒ½æ­£ç¡®åŠ è½½ã€‚é”™è¯¯è¯¦æƒ…è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ã€‚');
}

function save(){
  try { 
      localStorage.setItem('scheduleData',JSON.stringify(data)); 
      localStorage.setItem('animationPreference', currentAnimationEffect);
      localStorage.setItem('animationSpeedPreference', currentAnimationSpeed); 
  }
  catch (e) { console.error("Error saving data to localStorage:", e); alert("ä¿å­˜æ•°æ®å¤±è´¥ï¼Œå¯èƒ½æ˜¯æœ¬åœ°å­˜å‚¨å·²æ»¡ã€‚"); }
}

/**************** DOMå¼•ç”¨ ****************/
const conceptInput=document.getElementById('conceptInput');
const tagsInput=document.getElementById('tagsInput');
const dateInput=document.getElementById('dateInput');
const importanceSelect = document.getElementById('importanceSelect');
const tableBody=document.getElementById('tableBody');
const reviewListTitle = document.getElementById('reviewListTitle');
const reviewList = document.getElementById('reviewList');
const scienceModeBtn = document.getElementById('scienceModeBtn');
const artsModeBtn = document.getElementById('artsModeBtn');
const addBtn = document.getElementById('addBtn');
const todayBtn = document.getElementById('todayBtn');
const next7DaysBtn = document.getElementById('next7DaysBtn');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn'); 
const yearFilterSelect = document.getElementById('yearFilterSelect');
const monthFilterSelect = document.getElementById('monthFilterSelect');
const importanceFilterSelect = document.getElementById('importanceFilterSelect');
const clearFilterBtn = document.getElementById('clearFilterBtn');
const scrollToBottomBtn = document.getElementById('scrollToBottomBtn'); 
const animationSelect = document.getElementById('animationSelect');
const animationSpeedSelect = document.getElementById('animationSpeedSelect'); 
const searchInput = document.getElementById('searchInput'); 
const statsBtn = document.getElementById('statsBtn'); 
const statsModal = document.getElementById('statsModal');
const closeStatsBtn = document.getElementById('closeStatsBtn');
const statsContent = document.getElementById('statsContent');
const searchIconBtn = document.getElementById('searchIconBtn');
const filterPanel = document.getElementById('filterPanel');


/**************** äº‹ä»¶ç»‘å®š ****************/

// ä¿®å¤2ï¼šæœç´¢æŒ‰é’®é€»è¾‘ä¼˜åŒ–ï¼ˆç¬¬äºŒæ¬¡ç‚¹å‡»æ¸…ç©ºå¹¶æ”¶èµ·ï¼‰
searchIconBtn.onclick = (e) => {
    e.stopPropagation(); 
    const isOpen = filterPanel.classList.contains('show');
    
    if (isOpen) {
        // å¦‚æœå·²ç»æ‰“å¼€ï¼Œå†æ¬¡ç‚¹å‡»åˆ™ï¼šæ¸…ç©ºç­›é€‰ã€æ¸…ç©ºè¾“å…¥ã€å…³é—­é¢æ¿
        currentSelectedYear = "";
        currentSelectedMonth = "";
        currentImportanceFilter = "";
        currentSearchQuery = ""; 
        yearFilterSelect.value = "";
        monthFilterSelect.value = "";
        importanceFilterSelect.value = "";
        searchInput.value = ""; 
        monthFilterSelect.disabled = true;
        
        // é‡æ–°æ¸²æŸ“ï¼ˆæ¢å¤æ˜¾ç¤ºæ‰€æœ‰æ•°æ®ï¼‰
        render();

        // å…³é—­ UI
        filterPanel.classList.remove('show');
        searchIconBtn.classList.remove('active');
    } else {
        // å¦‚æœæ˜¯å…³é—­çŠ¶æ€ï¼Œåˆ™æ‰“å¼€
        filterPanel.classList.add('show');
        searchIconBtn.classList.add('active');
        // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†ï¼Œæå‡ä½“éªŒ
        searchInput.focus();
    }
};

// ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­æœç´¢æ¡†
document.addEventListener('click', (e) => {
    // åªæœ‰å½“ç‚¹å‡»ä¸åœ¨ searchIconBtn ä¸”ä¸åœ¨ filterPanel å†…éƒ¨æ—¶æ‰å…³é—­
    if (!filterPanel.contains(e.target) && e.target !== searchIconBtn && !searchIconBtn.contains(e.target)) {
        if (filterPanel.classList.contains('show')) {
            filterPanel.classList.remove('show');
            searchIconBtn.classList.remove('active');
        }
    }
});

// é˜²æ­¢åœ¨panelå†…éƒ¨ç‚¹å‡»æ—¶å…³é—­
filterPanel.onclick = (e) => {
    e.stopPropagation();
};

/**************** å¤ä¹ åˆ—è¡¨æ ¸å¿ƒé€»è¾‘ ****************/

function isGroupFullyReviewed(item, groupIndex) {
    const indices = reviewGroups[groupIndex];
    return indices.every(i => item.reviewed[i]);
}

// ä¿®å¤3ï¼šä¼˜åŒ– checkReviewStatusï¼Œç§»é™¤ç¡¬ç¼–ç ï¼Œç»Ÿä¸€ä½¿ç”¨ intervals
function checkReviewStatus(item, groupIndex, diffDays) {
    if (isGroupFullyReviewed(item, groupIndex)) {
        return { due: false, overdue: false };
    }
    
    if (groupIndex === 1 && item.importance === 'ä¸€èˆ¬') {
        return { due: false, overdue: false };
    }

    let due = false;
    let overdue = false;

    // åŸºäº intervals æ•°ç»„åŠ¨æ€è®¡ç®—å¤©æ•°ï¼Œé¿å…ç¡¬ç¼–ç 
    // intervals å•ä½æ˜¯åˆ†é’Ÿï¼Œé™¤ä»¥ (24*60) å¾—åˆ°å¤©æ•°
    const firstStageIndex = reviewGroups[groupIndex][0];
    const targetMinutes = intervals[firstStageIndex];
    const targetDays = targetMinutes / (24 * 60); // 1, 2, 4, 7...

    // åŠ¨æ€åˆ¤æ–­é€»è¾‘
    if (targetDays <= 7) {
        // çŸ­æœŸè®°å¿†ï¼šåˆšå¥½åˆ°æ—¥å­ æˆ– æ™šäº†1å¤©éƒ½ç®— due
        if (diffDays >= targetDays && diffDays < targetDays + 2) due = true;
        // æ™šäº†2å¤©ä»¥ä¸Šç®— overdue
        if (diffDays >= targetDays + 2) { due = true; overdue = true; }
    } else {
        // é•¿æœŸè®°å¿†ï¼šæ”¾å®½èŒƒå›´
        // æ¯”å¦‚ 30å¤©åï¼Œåœ¨ 28-45å¤©å†…éƒ½ç®— due
        if (diffDays >= targetDays - 2 && diffDays < targetDays + (targetDays * 0.5)) due = true;
        if (diffDays >= targetDays + (targetDays * 0.5)) { due = true; overdue = true; }
    }

    return { due, overdue };
}

function getFilteredData() {
    let itemsToFilter = [...data];

    // æœç´¢è¿‡æ»¤é€»è¾‘
    if (currentSearchQuery) {
        itemsToFilter = itemsToFilter.filter(item => {
            const conceptMatch = item.concept.toLowerCase().includes(currentSearchQuery);
            // æ ‡ç­¾ä¹Ÿè¦è½¬ä¹‰åå†åŒ¹é…å—ï¼Ÿä¸ç”¨ï¼Œç›´æ¥åŒ¹é…åŸå§‹æ•°æ®å³å¯
            const tagMatch = item.tags.some(t => t.toLowerCase().includes(currentSearchQuery));
            return conceptMatch || tagMatch;
        });
    }

    if (currentSelectedYear) {
        itemsToFilter = itemsToFilter.filter(item =>
            isValidDate(item.initial) && item.initial.getFullYear() === parseInt(currentSelectedYear)
        );
    }

    if (currentSelectedMonth) {
        itemsToFilter = itemsToFilter.filter(item =>
            isValidDate(item.initial) && (item.initial.getMonth() + 1) === parseInt(currentSelectedMonth)
        );
    }

    if (currentImportanceFilter) {
        itemsToFilter = itemsToFilter.filter(item => item.importance === currentImportanceFilter);
    }

    if (scienceMode && !artsMode) {
        itemsToFilter = itemsToFilter.filter(item => item.tags.some(tag => sciences.includes(tag)));
    } else if (artsMode && !scienceMode) {
        itemsToFilter = itemsToFilter.filter(item => item.tags.some(tag => arts.includes(tag)));
    }

    return itemsToFilter.sort((a,b) => {
        if (!isValidDate(a.initial) || !isValidDate(b.initial)) return 0;
        return b.initial.getTime() - a.initial.getTime();
    });
}

function listToday(){
  reviewListTitle.textContent = 'ä»Šæ—¥å¾…å¤ä¹  (åŸºäºèŒƒå›´ç®—æ³•)'; reviewList.innerHTML='';
  const now = new Date();
  let foundItems = 0;
  const dataToFilter = getFilteredData();

  dataToFilter.forEach(item => {
    if (!isValidDate(item.initial)) return;

    const diffDays = getCalendarDaysDiff(item.initial, now);

    reviewGroups.forEach((group, groupIndex) => {
        const status = checkReviewStatus(item, groupIndex, diffDays);
        
        if (status.due) {
            const li = document.createElement('li');
            if (status.overdue) {
                li.classList.add('overdue-item');
            }

            const importanceTag = item.importance === 'é‡è¦' 
                ? '<span style="color:var(--red);font-weight:bold;">[é‡è¦]</span> ' 
                : '';
            const stageName = groupDisplayNames[groupIndex];
            const overdueText = status.overdue ? " <span style='color:var(--red);font-weight:bold;'>(å·²é€¾æœŸ)</span>" : "";
            
            // ä½¿ç”¨ escapeHtml ç¡®ä¿åˆ—è¡¨æ˜¾ç¤ºå®‰å…¨
            li.innerHTML = `
                <span class="stage-info">âœ ${stageName}</span>${overdueText}<br>
                <strong>${importanceTag}${escapeHtml(item.concept)}</strong> <span style="color:#666;font-size:0.9em;">(æ ‡ç­¾: ${renderTags(item.tags)})</span><br>
                <span style="color:#888;font-size:0.85em;">è·åˆå­¦å·²è¿‡ ${diffDays} å¤©</span>
            `;
            
            li.onclick = () => {
                const row = document.querySelector(`tr[data-item-id="${item.id}"]`);
                if (row) {
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    row.classList.remove('highlight-row-anim');
                    void row.offsetWidth; 
                    row.classList.add('highlight-row-anim');
                }
            };
            
            reviewList.appendChild(li);
            foundItems++;
        }
    });
  });
  
  if(foundItems === 0) { reviewList.innerHTML='<li>å¤ªæ£’äº†ï¼ä»Šæ—¥æ— å¾…å¤ä¹ é¡¹ç›®ã€‚</li>'; }
}

function listNext7Days() {
  reviewListTitle.textContent = 'æœªæ¥7æ—¥å¤ä¹ é¢„å‘Š'; reviewList.innerHTML = '';
  const now = new Date();
  let foundItems = 0;
  const dataToFilter = getFilteredData();

  dataToFilter.forEach(item => {
      if (!isValidDate(item.initial)) return;
      
      const currentDiff = getCalendarDaysDiff(item.initial, now);
      
      // æ ‡å¿—ä½ï¼Œç¡®ä¿æ¯ä¸ªæ¡ç›®åªæ˜¾ç¤ºæœ€è¿‘çš„ä¸€ä¸ªæœªæ¥å¤ä¹ é˜¶æ®µ
      let hasAddedForecast = false;

      reviewGroups.forEach((group, groupIndex) => {
          if (hasAddedForecast) return; 

          if (isGroupFullyReviewed(item, groupIndex)) return;
          if (groupIndex === 1 && item.importance === 'ä¸€èˆ¬') return;

          // åŒæ ·ä½¿ç”¨åŠ¨æ€è®¡ç®—çš„ç›®æ ‡å¤©æ•°
          const firstStageIndex = reviewGroups[groupIndex][0];
          const targetDays = intervals[firstStageIndex] / (24 * 60);
          
          const remaining = Math.floor(targetDays - currentDiff);
          
          // é¢„æµ‹æœªæ¥7å¤©
          if (remaining >= 1 && remaining <= 7) {
             const li = document.createElement('li');
             const importanceTag = item.importance === 'é‡è¦' 
                 ? '<span style="color:var(--red);font-weight:bold;">[é‡è¦]</span> ' 
                 : '';
             const stageName = groupDisplayNames[groupIndex];
             
             li.innerHTML = `
                <span style="color:var(--teal);font-weight:bold;">âœ ${remaining}å¤©åè¿›å…¥: ${stageName}</span><br>
                ${importanceTag}${escapeHtml(item.concept)} <span style="color:#888;">(æ ‡ç­¾: ${renderTags(item.tags)})</span>
             `;

             li.onclick = () => {
                 const row = document.querySelector(`tr[data-item-id="${item.id}"]`);
                 if (row) {
                     row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                     row.classList.remove('highlight-row-anim');
                     void row.offsetWidth;
                     row.classList.add('highlight-row-anim');
                 }
             };

             reviewList.appendChild(li);
             foundItems++;
             hasAddedForecast = true; 
          }
      });
  });

  if (foundItems === 0) { reviewList.innerHTML = '<li>æœªæ¥7å¤©å†…æ— æ–°è§¦å‘çš„å¤ä¹ é¡¹ç›®ã€‚</li>'; }
}

// ------------------------------------------------------------------------

function refreshModeStyles(){
  document.body.classList.toggle('science-mode', scienceMode && !artsMode);
  document.body.classList.toggle('arts-mode', artsMode && !scienceMode);
  scienceModeBtn.style.fontWeight = scienceMode ? 'bold' : 'normal';
  artsModeBtn.style.fontWeight = artsMode ? 'bold' : 'normal';
  const currentReviewListTitle = reviewListTitle.textContent;
  if (currentReviewListTitle.includes("æœªæ¥7æ—¥")) {
    listNext7Days();
  } else {
    listToday();
  }
}

scienceModeBtn.onclick=()=>{
  scienceMode=!scienceMode;
  if(scienceMode) artsMode=false;
  refreshModeStyles();
  render();
};
artsModeBtn.onclick=()=>{
  artsMode=!artsMode;
  if(artsMode) scienceMode=false;
  refreshModeStyles();
  render();
};

addBtn.onclick=addItem;
todayBtn.onclick = () => {
    listToday();
    reviewList.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
};
next7DaysBtn.onclick = () => {
    listNext7Days();
    reviewList.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
};
exportBtn.onclick=exportData; 
importBtn.onclick=importData; 

scrollToBottomBtn.onclick = () => {
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
};

yearFilterSelect.onchange = () => {
    currentSelectedYear = yearFilterSelect.value;
    if (currentSelectedYear) {
        monthFilterSelect.disabled = false;
    } else {
        currentSelectedMonth = "";
        monthFilterSelect.value = "";
        monthFilterSelect.disabled = true;
    }
    render();
};

monthFilterSelect.onchange = () => {
    currentSelectedMonth = monthFilterSelect.value;
    render();
};

importanceFilterSelect.onchange = () => {
    currentImportanceFilter = importanceFilterSelect.value;
    render();
};

// æœç´¢è¾“å…¥äº‹ä»¶
searchInput.oninput = () => {
    currentSearchQuery = searchInput.value.toLowerCase().trim();
    render();
};


clearFilterBtn.onclick = () => {
    currentSelectedYear = "";
    currentSelectedMonth = "";
    currentImportanceFilter = "";
    currentSearchQuery = ""; 
    yearFilterSelect.value = "";
    monthFilterSelect.value = "";
    importanceFilterSelect.value = "";
    searchInput.value = ""; 
    monthFilterSelect.disabled = true;
    render();
};

animationSelect.onchange = () => {
    currentAnimationEffect = animationSelect.value;
    save(); 
};

animationSpeedSelect.onchange = () => {
    currentAnimationSpeed = animationSpeedSelect.value;
    save();
};

// ç»Ÿè®¡åŠŸèƒ½äº‹ä»¶ç»‘å®š
statsBtn.onclick = openStats;
closeStatsBtn.onclick = closeStats;
statsModal.onclick = (e) => {
    if (e.target === statsModal) closeStats();
};

function addItem(){
  const conceptText = conceptInput.value.trim();
  if(!conceptText){ alert('å­¦ä¹ å†…å®¹ä¸èƒ½ä¸ºç©ºï¼'); conceptInput.focus(); return; }
  const tagsArray = tagsInput.value.split(/[ï¼Œ,ã€\s]+/).map(t=>t.trim()).filter(Boolean);
  const initialDateTime = dateInput.value ? new Date(dateInput.value) : new Date();
  if (!isValidDate(initialDateTime)) { alert('è¾“å…¥çš„åˆå§‹å­¦ä¹ æ—¥æœŸæ—¶é—´æ— æ•ˆï¼Œè¯·é‡æ–°è¾“å…¥ã€‚'); dateInput.focus(); return; }
  const importanceValue = importanceSelect.value;
  
  const newItem={
    id: generateUUID(),
    concept: conceptText, 
    initial: initialDateTime, 
    tags: tagsArray,
    importance: importanceValue,
    schedule: computeSchedule(initialDateTime, importanceValue), 
    reviewed: Array(intervals.length).fill(false),
    reviewLog: {} // æ–°å¢ï¼šè®°å½•çœŸå®å¤ä¹ æ—¶é—´
  };
  data.push(newItem);
  populateYearFilter();
  save(); render(); clearInputs();
}

function clearInputs(){
  conceptInput.value=''; tagsInput.value=''; dateInput.value=isoLocal(new Date()); importanceSelect.value = 'ä¸€èˆ¬'; conceptInput.focus();
}

function populateYearFilter() {
    const existingYears = new Set();
    while (yearFilterSelect.options.length > 1) {
        yearFilterSelect.remove(1);
    }
    data.forEach(item => {
        if (isValidDate(item.initial)) {
            existingYears.add(item.initial.getFullYear());
        }
    });
    const sortedYears = Array.from(existingYears).sort((a, b) => b - a);
    sortedYears.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = `${year}å¹´`;
        yearFilterSelect.appendChild(option);
    });
    if (currentSelectedYear && sortedYears.includes(parseInt(currentSelectedYear))) {
        yearFilterSelect.value = currentSelectedYear;
    } else {
        currentSelectedYear = "";
        yearFilterSelect.value = "";
        monthFilterSelect.value = "";
        monthFilterSelect.disabled = true;
    }
}

function exportData() {
  if (data.length === 0) { 
    alert('æ²¡æœ‰å­¦ä¹ è®°å½•å¯ä»¥å¯¼å‡ºã€‚'); 
    return; 
  }
  const jsonContent = JSON.stringify(data, null, 2);
  const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
  const link = document.createElement("a");
  const now = new Date();
  const timestamp = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}`;
  const filename = `å­¦ä¹ è®°å½•_å¤‡ä»½_${timestamp}.json`;
  const objectUrl = URL.createObjectURL(blob);
  link.setAttribute("href", objectUrl);
  link.setAttribute("download", filename);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(objectUrl);
  showToast('æ•°æ®å·²æˆåŠŸå¯¼å‡ºï¼');
}

function importData() {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.json';
    fileInput.style.display = 'none';

    fileInput.onchange = e => {
        const file = e.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const importedData = JSON.parse(event.target.result);
                
                // ç¨å¾®ä¼˜åŒ–æç¤ºè¯­ï¼Œå‘ŠçŸ¥è¿™æ˜¯å®Œå…¨è¦†ç›–
                if (confirm('æ³¨æ„ï¼šæ­¤æ“ä½œå°†å®Œå…¨ã€è¦†ç›–ã€‘å½“å‰çš„æ‰€æœ‰å­¦ä¹ è®°å½•ï¼\n\nå¦‚æœå½“å‰æœ‰æœªå¤‡ä»½çš„æ•°æ®ï¼Œè¯·å…ˆå–æ¶ˆå¹¶å¯¼å‡ºå¤‡ä»½ã€‚\nç¡®å®šè¦è¦†ç›–å—ï¼Ÿ')) {
                    data = revive(importedData);
                    save();
                    populateYearFilter();
                    render();
                    showToast('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                }
            } catch (error) {
                console.error("å¯¼å…¥å¤±è´¥:", error);
                alert('å¯¼å…¥å¤±è´¥ï¼è¯·ç¡®ä¿æ–‡ä»¶æ˜¯ä¹‹å‰å¯¼å‡ºçš„æœ‰æ•ˆ.jsonå¤‡ä»½æ–‡ä»¶ã€‚');
            }
        };
        reader.onerror = function() {
            alert('è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ã€‚');
        };
        reader.readAsText(file);
    };

    document.body.appendChild(fileInput);
    fileInput.click();
    document.body.removeChild(fileInput);
}

/**************** ç»Ÿè®¡é€»è¾‘ (å¢å¼ºç‰ˆ) ****************/
function openStats() {
    selectedStatsTags.clear(); // æ¯æ¬¡æ‰“å¼€æ—¶é‡ç½®ç­›é€‰
    calculateAndRenderStats();
    statsModal.classList.add('active');
}

function closeStats() {
    selectedStatsTags.clear(); // å…³é—­æ—¶é‡ç½®
    statsModal.classList.remove('active');
}

// å¤šé€‰äº¤äº’é€»è¾‘æ ¸å¿ƒ
let statsClickTimer = null;
let statsPreventClick = false;

// å•å‡»å¤„ç†ï¼šæ’ä»–æ€§é€‰æ‹© æˆ– å–æ¶ˆå½“å‰é€‰æ‹©
function handleTagClick(tag) {
    // ã€ä¿®æ”¹ç‚¹ã€‘ç‚¹å‡»ç­‰å¾…æ—¶é—´è°ƒæ•´ä¸º 200 æ¯«ç§’
    statsClickTimer = setTimeout(() => {
        if (!statsPreventClick) {
            // æ‰§è¡Œå•å‡»é€»è¾‘
            if (selectedStatsTags.has(tag)) {
                // å¦‚æœå·²ç»é€‰ä¸­ï¼Œåˆ™å–æ¶ˆè¯¥é€‰ä¸­ï¼ˆå¦‚æœåœ¨å¤šé€‰çŠ¶æ€ä¸‹ï¼Œç›¸å½“äºç§»é™¤è¿™ä¸€ä¸ªï¼‰
                selectedStatsTags.delete(tag);
                // æ­¤æ—¶å¦‚æœæ˜¯å•é€‰æ¨¡å¼ä¸‹ç‚¹å‡»å·²é€‰ä¸­çš„ï¼Œå°±å˜æˆäº†å…¨ä¸é€‰ï¼Œè¿™ç¬¦åˆé¢„æœŸ
            } else {
                // å¦‚æœæ²¡é€‰ä¸­ï¼Œåˆ™è¿›è¡Œæ’ä»–æ€§é€‰æ‹©ï¼ˆæ¸…ç©ºå…¶ä»–ï¼Œåªé€‰è¿™ä¸ªï¼‰
                selectedStatsTags.clear();
                selectedStatsTags.add(tag);
            }
            refreshStatsUI();
        }
        statsPreventClick = false;
    }, 200); 
}

// åŒå‡»å¤„ç†ï¼šè¿½åŠ é€‰æ‹©ï¼ˆå¤šé€‰ï¼‰
function handleTagDblClick(tag) {
    clearTimeout(statsClickTimer);
    statsPreventClick = true;
    
    // æ‰§è¡ŒåŒå‡»é€»è¾‘
    selectedStatsTags.add(tag); // åªæ˜¯æ·»åŠ åˆ°é›†åˆä¸­ï¼Œä¸æ¸…é™¤å…¶ä»–çš„
    refreshStatsUI();
}

function refreshStatsUI() {
    // è§¦å‘é‡ç»˜åŠ¨ç”»
    const cards = document.querySelectorAll('.stat-card');
    cards.forEach(card => {
        card.classList.remove('updating');
        void card.offsetWidth; // è§¦å‘é‡ç»˜
        card.classList.add('updating');
    });
    calculateAndRenderStats();
}

// æ–°å¢ï¼šçƒ­åŠ›å›¾æ—¥æœŸå·¥å…·
function getHeatmapDateRange() {
    const today = new Date();
    today.setHours(0,0,0,0); // æ ‡å‡†åŒ–ä¸ºåˆå¤œï¼Œé¿å…è·¨å¤©å·®å¼‚
    
    // å¾€å‰ 6 ä¸ªæœˆä½œä¸ºèµ·ç‚¹ (å¤§çº¦ 26 å‘¨)
    const startDate = new Date(today);
    startDate.setMonth(today.getMonth() - 6);
    // è°ƒæ•´åˆ°é‚£å‘¨çš„å‘¨æ—¥ (Gridå¸ƒå±€ä»å‘¨æ—¥å¼€å§‹)
    startDate.setDate(startDate.getDate() - startDate.getDay());

    // å¾€å 2 å‘¨
    const endDate = new Date(today);
    endDate.setDate(today.getDate() + 14);
    // è°ƒæ•´åˆ°é‚£å‘¨çš„å‘¨å…­
    endDate.setDate(endDate.getDate() + (6 - endDate.getDay()));

    const dates = [];
    let current = new Date(startDate);
    while (current <= endDate) {
        dates.push(new Date(current));
        current.setDate(current.getDate() + 1);
    }
    return dates;
}

function formatDateKey(date) {
    return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}`;
}

function calculateAndRenderStats() {
    if (data.length === 0) {
        statsContent.innerHTML = '<div style="text-align:center;color:#888;padding:20px;">æš‚æ— æ•°æ®ï¼Œè¯·æ·»åŠ å­¦ä¹ é¡¹åå†æŸ¥çœ‹ç»Ÿè®¡ã€‚</div>';
        return;
    }

    // 1. å…¨å±€ç»Ÿè®¡
    const globalTagCounts = {};
    data.forEach(item => {
        if (item.tags && item.tags.length > 0) {
            item.tags.forEach(tag => {
                globalTagCounts[tag] = (globalTagCounts[tag] || 0) + 1;
            });
        } else {
            globalTagCounts['æ— æ ‡ç­¾'] = (globalTagCounts['æ— æ ‡ç­¾'] || 0) + 1;
        }
    });
    const sortedTags = Object.entries(globalTagCounts).sort((a, b) => b[1] - a[1]);

    // 2. æ ¹æ® selectedStatsTags ç­›é€‰æ•°æ®
    let filteredDataForStats = data;
    if (selectedStatsTags.size > 0) {
        filteredDataForStats = data.filter(item => {
            const itemTags = (item.tags && item.tags.length > 0) ? item.tags : ['æ— æ ‡ç­¾'];
            return itemTags.some(t => selectedStatsTags.has(t));
        });
    }

    // 3. è®¡ç®—å¸¸è§„ç»Ÿè®¡æ•°æ®
    let totalItems = filteredDataForStats.length;
    let totalReviewPoints = 0;
    let completedReviewPoints = 0;
    let overdueCount = 0; 
    const now = new Date(); 

    const stageTotalCounts = Array(7).fill(0);
    const stageCompletedCounts = Array(7).fill(0);
    const forecastCounts = Array(7).fill(0); // æŸ±çŠ¶å›¾ç”¨
    
    // çƒ­åŠ›å›¾æ•°æ®å‡†å¤‡ (map: dateKey -> count)
    const heatmapActivityData = {}; // è¿‡å»ï¼šå®é™…å¤ä¹ æ•° (æ ¹æ® reviewLog)
    const heatmapWorkloadData = {}; // æœªæ¥ï¼šè®¡åˆ’å¤ä¹ æ•° (æ ¹æ® schedule)

    // A. å¡«å……çƒ­åŠ›å›¾æ•°æ® (ä¿®æ­£ç‰ˆï¼šæŒ‰ Group ç»Ÿè®¡ï¼Œå®Œå…¨éå†æ‰€æœ‰æ‰“å¡è®°å½•)
    filteredDataForStats.forEach(item => {
        // 1. ç»Ÿè®¡ Activity (è¿‡å»å®é™…ç‚¹å‡»)
        if (item.reviewLog) {
            reviewGroups.forEach((group, groupIndex) => {
                // æ”¶é›†è¯¥ç»„å†…æ‰€æœ‰æœ‰æ•ˆçš„æ‰“å¡æ—¥æœŸï¼ˆå»é‡ï¼‰
                // è¿™æ ·å¦‚æœåŒä¸€ç»„åœ¨ä¸åŒå¤©éƒ½æœ‰æ‰“å¡ï¼Œæ¯ä¸€å¤©éƒ½ä¼šè¢«ç»Ÿè®¡åˆ°
                // å¦‚æœåŒä¸€ç»„åœ¨åŒä¸€å¤©å¤šæ¬¡æ‰“å¡ï¼Œåªç®—ä¸€æ¬¡
                const uniqueDaysForGroup = new Set();
                
                group.forEach(idx => {
                    const logTime = item.reviewLog[idx];
                    if (logTime) {
                        const d = new Date(logTime);
                        if (isValidDate(d)) {
                            uniqueDaysForGroup.add(formatDateKey(d));
                        }
                    }
                });

                // å°†è¯¥ç»„è´¡çŒ®çš„æ‰€æœ‰æ´»è·ƒå¤©æ•°åŠ åˆ°å…¨å±€çƒ­åŠ›å›¾ä¸­
                uniqueDaysForGroup.forEach(dateKey => {
                    heatmapActivityData[dateKey] = (heatmapActivityData[dateKey] || 0) + 1;
                });
            });
        }

        // 2. ç»Ÿè®¡ Workload (æœªæ¥è®¡åˆ’)
        // åŒæ ·ä»¥ Group ä¸ºå•ä½ã€‚å¦‚æœ Group æ•´ä½“æœªå®Œæˆï¼Œå– Group çš„èµ·å§‹æ—¥æœŸä½œä¸ºè®¡åˆ’æ—¥æœŸã€‚
        reviewGroups.forEach((group, groupIndex) => {
            if (groupIndex === 1 && item.importance === 'ä¸€èˆ¬') return;
            
            // æ£€æŸ¥æ•´ä¸ª Group æ˜¯å¦å·²å®Œæˆ
            const isDone = group.every(i => i < item.reviewed.length && item.reviewed[i]);
            
            if (!isDone) {
                // æŸ¥æ‰¾è¯¥ Group ä¸­ç¬¬ä¸€ä¸ªåœ¨è¿™ä¸ªæ—¶åˆ»ä¹‹åçš„æ—¶é—´ç‚¹
                let targetDate = null;
                for (const idx of group) {
                    if (item.schedule[idx] && item.schedule[idx] > now) {
                        targetDate = item.schedule[idx];
                        break; 
                    }
                }
                
                if (targetDate && isValidDate(targetDate)) {
                    const key = formatDateKey(targetDate);
                    heatmapWorkloadData[key] = (heatmapWorkloadData[key] || 0) + 1;
                }
            }
        });
    });

    const forecastDates = Array(7).fill(0).map((_, i) => {
        const d = new Date(now);
        d.setDate(now.getDate() + i + 1);
        return d; 
    });

    filteredDataForStats.forEach(item => {
        const groupsToCheck = reviewGroups.length;
        let itemTotalPoints = groupsToCheck;
        let itemCompletedPoints = 0;
        
        if (item.importance === 'ä¸€èˆ¬') {
            itemTotalPoints -= 1; 
        }

        reviewGroups.forEach((group, index) => {
             if (item.importance === 'ä¸€èˆ¬' && index === 1) {
             } else {
                 stageTotalCounts[index]++;
                 const isDone = group.every(i => i < item.reviewed.length && item.reviewed[i]);
                 if (isDone) {
                     itemCompletedPoints++;
                     stageCompletedCounts[index]++;
                 } else {
                     group.forEach(subIndex => {
                         const scheduleDate = item.schedule[subIndex];
                         if (scheduleDate && isValidDate(scheduleDate) && !item.reviewed[subIndex]) {
                             forecastDates.forEach((fDay, fIndex) => {
                                 if (scheduleDate.getDate() === fDay.getDate() && 
                                     scheduleDate.getMonth() === fDay.getMonth() && 
                                     scheduleDate.getFullYear() === fDay.getFullYear()) {
                                     forecastCounts[fIndex]++;
                                 }
                             });
                         }
                     });
                 }
             }
        });

        totalReviewPoints += itemTotalPoints;
        completedReviewPoints += itemCompletedPoints;

        if (item.initial && isValidDate(item.initial)) {
             const diffDays = getCalendarDaysDiff(item.initial, now);
             reviewGroups.forEach((group, index) => {
                 const status = checkReviewStatus(item, index, diffDays);
                 if (status.overdue) {
                     overdueCount++;
                 }
             });
        }
    });

    const completionRate = totalReviewPoints > 0 ? Math.round((completedReviewPoints / totalReviewPoints) * 100) : 0;
    
    let filterSuffix = '';
    if (selectedStatsTags.size > 0) {
        filterSuffix = Array.from(selectedStatsTags).map(t => 
            `<span style="font-size:14px;color:var(--blue);background:rgba(10,132,255,0.1);padding:2px 8px;border-radius:10px;margin-left:5px;">${escapeHtml(t)}</span>`
        ).join('');
        if (selectedStatsTags.size > 1) {
             filterSuffix += `<span style="font-size:12px;color:#999;margin-left:5px;">(ç»„åˆ)</span>`;
        }
    }


    // 4. ç”Ÿæˆ HTML
    let html = `
        <div class="stats-grid">
            <div class="stat-card updating">
                <div class="stat-value">${totalItems}</div>
                <div class="stat-label">æ€»å­¦ä¹ æ¡ç›®${selectedStatsTags.size > 0 ? '(ç­›é€‰)' : ''}</div>
            </div>
            <div class="stat-card updating">
                <div class="stat-value">${completedReviewPoints}</div>
                <div class="stat-label">ç´¯è®¡å¤ä¹ å®Œæˆæ¬¡</div>
            </div>
            <div class="stat-card updating">
                <div class="stat-value" style="color:var(--red)">${overdueCount}</div>
                <div class="stat-label">é€¾æœŸä»»åŠ¡</div>
            </div>
            <div class="stat-card updating">
                <div class="stat-value">${completionRate}%</div>
                <div class="stat-label">æ€»ä½“å¤ä¹ è¿›åº¦</div>
            </div>
        </div>

        <!-- çƒ­åŠ›å›¾åŒºåŸŸ -->
        <div class="stats-section-header">å­¦ä¹ æ´»åŠ›çƒ­åŠ›å›¾ (Activity & Workload)</div>
        <div style="font-size:12px; color:#666; margin-bottom:10px; display:flex; justify-content:space-between;">
            <span>ç»¿è‰²: å½“å¤©å®é™…å¤ä¹ æ•° (è¶Šæ·±è¶Šå‹¤å¥‹)</span>
            <span>ç°è‰²: æœªæ¥è®¡åˆ’ä»»åŠ¡æ•° (è¶Šæ·±è¶Šç¹é‡)</span>
        </div>
        <div class="heatmap-container">
            <div class="heatmap-grid">
    `;

    // æ¸²æŸ“çƒ­åŠ›å›¾ç½‘æ ¼
    const heatmapDates = getHeatmapDateRange();
    const todayStr = formatDateKey(new Date());
    
    heatmapDates.forEach(date => {
        const key = formatDateKey(date);
        const isPastOrToday = date <= now;
        
        let colorClass = '';
        let title = `${key}\n`;
        let count = 0;

        if (isPastOrToday) {
            // è¿‡å»æ¨¡å¼ï¼šä½¿ç”¨ Activity Data (ç»¿è‰²)
            count = heatmapActivityData[key] || 0;
            title += `å®Œæˆå¤ä¹ : ${count} æ¬¡`;
            if (count === 0) colorClass = 'color-scale-green-0';
            else if (count <= 2) colorClass = 'color-scale-green-1';
            else if (count <= 4) colorClass = 'color-scale-green-2';
            else if (count <= 6) colorClass = 'color-scale-green-3';
            else colorClass = 'color-scale-green-4';
        } else {
            // æœªæ¥æ¨¡å¼ï¼šä½¿ç”¨ Workload Data (ç°è‰²)
            count = heatmapWorkloadData[key] || 0;
            title += `è®¡åˆ’å¤ä¹ : ${count} é¡¹`;
            if (count === 0) colorClass = 'color-scale-gray-0';
            else if (count <= 2) colorClass = 'color-scale-gray-1';
            else if (count <= 4) colorClass = 'color-scale-gray-2';
            else if (count <= 6) colorClass = 'color-scale-gray-3';
            else colorClass = 'color-scale-gray-4';
        }

        // ä»Šå¤©åŠ ä¸€ä¸ªç‰¹æ®Šè¾¹æ¡†æˆ–æ ‡è¯†? å…¶å®é¢œè‰²åˆ†ç•Œå·²ç»å¾ˆæ˜æ˜¾äº†
        // å¦‚æœæ˜¯ä»Šå¤©ï¼Œé¢å¤–åŠ ä¸€ç‚¹ border
        let style = "";
        if (key === todayStr) {
            style = "border: 1px solid var(--blue);";
            title += " (ä»Šå¤©)";
        }

        html += `<div class="heatmap-cell ${colorClass}" title="${title}" style="${style}"></div>`;
    });

    html += `
            </div>
        </div>
        <div class="heatmap-legend">
            <span>Less</span>
            <span class="legend-item color-scale-green-0"></span>
            <span class="legend-item color-scale-green-2"></span>
            <span class="legend-item color-scale-green-4"></span>
            <span>More</span>
        </div>


        <div class="stats-section-header">æœªæ¥7æ—¥å¤ä¹ é‡é¢„æµ‹</div>
        <div class="forecast-chart">
            ${forecastCounts.map((count, i) => {
                const dayLabel = `+${i+1}å¤©`;
                const maxVal = Math.max(...forecastCounts, 5); // è‡³å°‘ä¸º5
                const height = Math.max((count / maxVal) * 80, 2); // æœ€å°2px
                return `
                <div class="forecast-bar-container">
                    <div class="forecast-value">${count > 0 ? count : ''}</div>
                    <div class="forecast-bar" style="height: ${height}%; opacity: ${count > 0 ? 1 : 0.3}"></div>
                    <div class="forecast-label">${dayLabel}</div>
                </div>`;
            }).join('')}
        </div>

        <div class="stats-section-header">é˜¶æ®µå¤ä¹ ç•™å­˜ç‡</div>
        <div class="chart-container">
            ${groupDisplayNames.map((name, i) => {
                const total = stageTotalCounts[i];
                const completed = stageCompletedCounts[i];
                const rate = total > 0 ? Math.round((completed / total) * 100) : 0;
                let color = 'var(--green)';
                if(rate < 50) color = 'var(--red)';
                else if(rate < 80) color = 'var(--orange)';
                
                return `
                <div class="bar-row" style="cursor:default;">
                    <div class="bar-label" style="width:60px;">${name}</div>
                    <div class="bar-track">
                        <div class="bar-fill" style="width: ${rate}%; background: ${color};"></div>
                    </div>
                    <div class="bar-value" style="width:50px;text-align:right;">${rate}%</div>
                </div>`;
            }).join('')}
        </div>

        <div class="stats-section-title">
            <div style="display:flex;align-items:center;flex-wrap:wrap;">
                <span>å­¦ç§‘/æ ‡ç­¾åˆ†å¸ƒ</span>${filterSuffix}
            </div>
            <span style="font-weight:normal;font-size:11px;color:#888;">å•å‡»æ›¿æ¢ / åŒå‡»å¤šé€‰</span>
        </div>
        <div class="chart-container">
    `;

    // ç»˜åˆ¶æ ‡ç­¾æ¡å½¢å›¾
    const maxTagCount = sortedTags.length > 0 ? sortedTags[0][1] : 1;
    sortedTags.slice(0, 10).forEach(([tag, count]) => {
        const percent = (count / maxTagCount) * 100;
        let color = '#8e8e93'; 
        if (colorSubjects[tag]) {
             const subjectVarMap = {
                 'ç‰©ç†': 'var(--phys)', 'åŒ–å­¦': 'var(--chem)', 'æ•°å­¦': 'var(--math)', 'ç”Ÿç‰©': 'var(--bio)',
                 'è¯­æ–‡': 'var(--chi)', 'è‹±è¯­': 'var(--eng)', 'æ”¿æ²»': 'var(--poli)', 'å†å²': 'var(--hist)', 'åœ°ç†': 'var(--geo)'
             };
             if(subjectVarMap[tag]) color = subjectVarMap[tag];
             else color = 'var(--blue)';
        } else {
             color = 'var(--blue)';
        }

        const isSelected = selectedStatsTags.has(tag);
        const isAnySelected = (selectedStatsTags.size > 0);
        
        let rowClass = 'bar-row';
        if (isSelected) rowClass += ' active-filter';
        if (isAnySelected && !isSelected) rowClass += ' dimmed';
        
        const safeTagStr = tag.replace(/'/g, "\\'"); 

        html += `
            <div class="${rowClass}" 
                 onclick="handleTagClick('${safeTagStr}')" 
                 ondblclick="handleTagDblClick('${safeTagStr}')"
                 title="${isSelected ? 'å•å‡»ç§»é™¤ï¼Œä¿ç•™å…¶ä»–' : 'å•å‡»é€‰ä¸­(æ›¿æ¢)ï¼ŒåŒå‡»é€‰ä¸­(è¿½åŠ )'}">
                <div class="bar-label" title="${escapeHtml(tag)}">${escapeHtml(tag)}</div>
                <div class="bar-track">
                    <div class="bar-fill" style="width: ${percent}%; background: ${color};"></div>
                </div>
                <div class="bar-value">${count}</div>
            </div>
        `;
    });
    html += `</div>`;
    
    statsContent.innerHTML = html;
}


function render(){
  const cellToAnimate = lastAnimatedCell;
  lastAnimatedCell = null;
    
  tableBody.innerHTML='';
  const rowsToRender = getFilteredData();
  if (rowsToRender.length === 0) {
      const tr = tableBody.insertRow(); const td = tr.insertCell();
      td.colSpan = stageNames.length + 5;
      
      // å¢åŠ æœç´¢åé¦ˆ (escapeHtml é˜²æ­¢ XSS)
      if (currentSearchQuery) {
          td.innerHTML = `<span style="color:#666">æ²¡æœ‰æ‰¾åˆ°åŒ…å« â€œ<b style="color:var(--blue)">${escapeHtml(currentSearchQuery)}</b>â€ çš„å­¦ä¹ è®°å½•ã€‚</span><br><span style="font-size:12px;color:#999">è¯·å°è¯•æ¸…é™¤ç­›é€‰æˆ–ä½¿ç”¨å…¶ä»–å…³é”®è¯ã€‚</span>`;
      } else {
          td.textContent = "æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å­¦ä¹ è®°å½•ã€‚å°è¯•æ·»åŠ æ–°çºªå½•æˆ–æ›´æ”¹ç­›é€‰æ¡ä»¶ã€‚";
      }
      
      td.style.textAlign = "center"; td.style.padding = "30px"; td.style.color = "#555";
      const currentReviewListTitle = reviewListTitle.textContent;
      if (currentReviewListTitle.includes("æœªæ¥7æ—¥")) {
          listNext7Days();
      } else {
          listToday();
      }
      return;
  }
  rowsToRender.forEach((item, index)=>{
    const tr=document.createElement('tr'); tr.dataset.itemId = item.id;
    tr.insertAdjacentHTML('beforeend',`<td>${index+1}</td>`);
    
    // ä¿®å¤ï¼šä½¿ç”¨ escapeHtml
    const tdConcept=document.createElement('td'); tdConcept.textContent=item.concept;
    tdConcept.title='åŒå‡»ç¼–è¾‘å­¦ä¹ å†…å®¹'; tdConcept.style.cursor='pointer';
    tdConcept.ondblclick=(e)=>editCell(e.currentTarget, item, 'concept'); tr.appendChild(tdConcept);
    
    const tdImportance = document.createElement('td');
    tdImportance.innerHTML = renderImportance(item.importance);
    tdImportance.title = 'åŒå‡»ç¼–è¾‘é‡è¦æ€§';
    tdImportance.style.cursor = 'pointer';
    tdImportance.ondblclick = (e) => editCell(e.currentTarget, item, 'importance');
    tr.appendChild(tdImportance);

    const tdTags=document.createElement('td'); tdTags.innerHTML=renderTags(item.tags);
    tdTags.title='åŒå‡»ç¼–è¾‘æ ‡ç­¾'; tdTags.style.cursor='pointer';
    tdTags.ondblclick=(e)=>editCell(e.currentTarget, item, 'tags'); tr.appendChild(tdTags);

    // ä¿®å¤4ï¼šå®Œå–„æ—¥æœŸä¿®æ”¹é€»è¾‘ï¼ˆæç¤ºé‡ç½®è¿›åº¦ï¼‰
    const tdInitial = document.createElement('td');
    tdInitial.textContent = fmtInit(item.initial);
    tdInitial.title = 'åŒå‡»ä¿®æ”¹åˆå­¦æ—¶é—´';
    tdInitial.style.cursor = 'pointer';
    tdInitial.ondblclick = (e) => {
        const currentVal = isoLocal(item.initial);
        const input = document.createElement('input');
        input.type = 'datetime-local';
        input.value = currentVal;
        input.style.fontSize = '12px';
        // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢æ„å¤–
        input.onclick = (ev) => ev.stopPropagation(); 
        
        const saveDate = () => {
            const newDate = new Date(input.value);
            if (isValidDate(newDate)) {
                // æ£€æŸ¥æ—¥æœŸæ˜¯å¦çœŸçš„å˜äº†
                if (newDate.getTime() !== item.initial.getTime()) {
                    item.initial = newDate;
                    item.schedule = computeSchedule(item.initial, item.importance);
                    
                    // è¯¢é—®æ˜¯å¦é‡ç½®æ‰“é’©çŠ¶æ€
                    if (confirm("ä½ ä¿®æ”¹äº†åˆå­¦æ—¥æœŸï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´ç°æœ‰çš„å¤ä¹ è¿›åº¦ä¸å†å‡†ç¡®ã€‚\n\næ˜¯å¦è¦ã€é‡ç½®ã€‘è¿™æ¡è®°å½•çš„æ‰€æœ‰æ‰“é’©çŠ¶æ€ï¼Ÿ\n(æ¨èé€‰'ç¡®å®š'ä»¥é‡æ–°å¼€å§‹è®¡ç®—å¤ä¹ èŠ‚ç‚¹)")) {
                        item.reviewed = Array(intervals.length).fill(false);
                        item.reviewLog = {}; // é‡ç½®æ—¥æœŸä¹Ÿé‡ç½®æ—¥å¿—
                    }
                    
                    save();
                    render();
                } else {
                    // æ—¥æœŸæ²¡å˜ï¼Œä»…ä»…æ˜¯å¤±ç„¦
                    render();
                }
            } else {
                render(); // å–æ¶ˆæˆ–æ— æ•ˆåˆ™è¿˜åŸ
            }
        };

        input.onblur = saveDate;
        input.onkeydown = (ev) => { if(ev.key === 'Enter') saveDate(); };
        
        e.currentTarget.innerHTML = '';
        e.currentTarget.appendChild(input);
        input.focus();
    };
    tr.appendChild(tdInitial);
    
    let processedStageIndex = 0;
    while (processedStageIndex < intervals.length) {
        const group = reviewGroups.find(g => g.includes(processedStageIndex));
        if (!group) {
            processedStageIndex++;
            continue;
        }
        
        const groupSize = group.length;
        const groupIndex = reviewGroups.findIndex(g => g.includes(processedStageIndex));
        
        if (groupIndex === 1 && item.importance === 'ä¸€èˆ¬') {
            const td = document.createElement('td');
            td.colSpan = group.length;
            td.innerHTML = 'â€”'; 

            const isPrevGroupReviewed = reviewGroups[0].every(i => i < item.reviewed.length && item.reviewed[i]);
            const isNextGroupReviewed = reviewGroups[2].every(i => i < item.reviewed.length && item.reviewed[i]);

            if (isPrevGroupReviewed && isNextGroupReviewed) {
                td.style.backgroundColor = groupColors[groupIndex];
                td.style.color = '#fff';
                td.style.fontWeight = '700';
            } else {
                td.style.color = '#ccc';
                td.style.fontWeight = '600';
            }
            
            const lastIndexOfGroup = group[group.length - 1];
            if ([1, 2, 4, 6, 7, 8, 9].includes(lastIndexOfGroup)) {
                td.classList.add('group-separator');
            }
            tr.appendChild(td);
            processedStageIndex += group.length;
            continue;
        }
        
        const isGroupReviewed = group.every(i => i < item.reviewed.length && item.reviewed[i]);

        if (isGroupReviewed) {
            const td = document.createElement('td');
            td.colSpan = groupSize;
            td.textContent = 'å·²å¤ä¹ ';
            td.style.fontWeight = '700';
            td.style.color = '#fff';
            const color = groupIndex !== -1 ? groupColors[groupIndex] : '#ccc';
            td.style.backgroundColor = color;
            td.classList.add('clickable-cell');
            
            if (groupSize === 1) {
                if (groupIndex === 1) {
                    td.style.minWidth = '110px';
                } else {
                    td.style.minWidth = '120px';
                }
            }

            if (cellToAnimate && cellToAnimate.itemId === item.id && cellToAnimate.groupIndex === groupIndex) {
                if(currentAnimationEffect !== 'none') {
                    td.style.setProperty('--anim-duration', currentAnimationSpeed); 
                    td.classList.add(currentAnimationEffect);
                }
            }

            const lastIndexOfGroup = group[group.length - 1];
            if ([1, 2, 4, 6, 7, 8, 9].includes(lastIndexOfGroup)) {
                td.classList.add('group-separator');
            }
            
            td.onclick = () => {
                // å–æ¶ˆå¤ä¹ æ—¶ï¼Œéœ€è¦åˆ é™¤æ—¥å¿—å—ï¼Ÿ
                // é€»è¾‘ï¼šå¦‚æœå–æ¶ˆäº†ï¼Œé‚£è¿™æ¬¡å¤ä¹ å°±ä¸ç®—æ•°äº†ã€‚åˆ é™¤ç›¸å…³æ—¥å¿—ã€‚
                group.forEach(i => { 
                    if (i < item.reviewed.length) {
                        item.reviewed[i] = false;
                        if (item.reviewLog) delete item.reviewLog[i];
                    } 
                });
                save();
                render();
            };
            tr.appendChild(td);
        } else {
            group.forEach(i => {
                const td = document.createElement('td');
                td.classList.add('clickable-cell');
                
                if (groupSize === 1) {
                    if (groupIndex === 1) {
                        td.style.minWidth = '110px';
                    } else {
                        td.style.minWidth = '120px';
                    }
                }

                if (group.indexOf(i) === group.length - 1) {
                    if ([1, 2, 4, 6, 7, 8, 9].includes(i)) {
                        td.classList.add('group-separator');
                    }
                }

                const dateOfReview = item.schedule && item.schedule[i] ? item.schedule[i] : null; 
                
                if (!dateOfReview) {
                    td.innerHTML = "?";
                } else if(groupIndex === 1) { 
                    const day3 = new Date(item.initial.getTime() + 3 * 24 * 60 * 60000); 
                    const day4 = dateOfReview; 
                    if (isValidDate(day3) && isValidDate(day4)) {
                        td.innerHTML = fmtStageCompactRange(day3, day4);
                    } else {
                        td.innerHTML = "æ—¥æœŸæ— æ•ˆ";
                    }
                }
                else if(groupIndex <= 3) { 
                    td.innerHTML = fmtStageCompact(dateOfReview);
                } else {
                    td.textContent = fmtStage(dateOfReview, i, item.initial.getFullYear());
                }
                
                td.onclick = () => {
                    const wasAlreadyReviewed = group.every(idx => item.reviewed[idx]);
                    if (!wasAlreadyReviewed) {
                        triggerCelebration(groupIndex);
                    }
                    
                    lastAnimatedCell = { itemId: item.id, groupIndex: groupIndex };

                    // è®°å½•å½“å‰æ—¶é—´ä½œä¸ºå¤ä¹ æ—¶é—´
                    const nowISO = new Date().toISOString();

                    group.forEach(indexInGroup => {
                        if (indexInGroup < item.reviewed.length) {
                            item.reviewed[indexInGroup] = true;
                            // è®°å½•æ—¥å¿—ï¼šå“ªä¸ªé˜¶æ®µ -> ä»€ä¹ˆæ—¶å€™å¤ä¹ çš„
                            if (!item.reviewLog) item.reviewLog = {};
                            item.reviewLog[indexInGroup] = nowISO;
                        }
                    });

                    save();
                    render();
                };
                tr.appendChild(td);
            });
        }
        processedStageIndex += groupSize;
    }

    const deleteCell=document.createElement('td');
    deleteCell.innerHTML='<span class="deleteBtn" title="åˆ é™¤æ­¤æ¡è®°å½•">âœ•</span>';
    deleteCell.onclick=()=>{
      // escapeHtml é˜²æ­¢æç¤ºæ¡†ä¸­å‡ºç°å¥‡æ€ªä»£ç 
      if(confirm(`ç¡®å®šè¦åˆ é™¤å­¦ä¹ å†…å®¹ï¼šâ€œ${item.concept}â€å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`)){
        data=data.filter(x=>x.id !== item.id);
        populateYearFilter();
        save(); render();
      }
    };
    tr.appendChild(deleteCell); tableBody.appendChild(tr);
  });
  const currentReviewListTitle = reviewListTitle.textContent;
  if (currentReviewListTitle.includes("æœªæ¥7æ—¥")) {
      listNext7Days();
  } else {
      listToday();
  }
}

// ä¿®å¤ï¼šä½¿ç”¨ escapeHtml å®‰å…¨æ¸²æŸ“æ ‡ç­¾
function renderTags(tagsArray){
  if (!Array.isArray(tagsArray) || tagsArray.length === 0) { return '<span class="label label-gray">æ— æ ‡ç­¾</span>'; }
  return tagsArray.map(tag=>{
    const tagName = String(tag || '').trim(); if (!tagName) return '';
    const safeTagName = escapeHtml(tagName); // XSS é˜²æŠ¤
    const cssClassSuffix = colorSubjects[tagName] || 'gray';
    const labelClass = `label label-${cssClassSuffix}`;
    return`<span class="${labelClass}">${safeTagName}</span>`;
  }).join('');
}

function renderImportance(importance) {
    const className = importance === 'é‡è¦' ? 'label-é‡è¦' : 'label-ä¸€èˆ¬';
    return `<span class="label ${className}">${importance}</span>`;
}


/**************** ç¼–è¾‘å‡½æ•° ****************/
function editCell(cell, item, propertyKey) {
    if (propertyKey === 'importance') {
        const select = document.createElement('select');
        select.innerHTML = `
            <option value="ä¸€èˆ¬">ä¸€èˆ¬</option>
            <option value="é‡è¦">é‡è¦</option>
        `;
        select.value = item.importance;
        cell.innerHTML = '';
        cell.appendChild(select);
        select.focus();

        const saveEdit = () => {
            const newImportance = select.value;
            item.importance = newImportance;
            
            item.schedule = computeSchedule(item.initial, newImportance);
            if (newImportance === 'ä¸€èˆ¬') {
                item.reviewed[2] = false; 
                // åŒæ—¶ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—¥å¿—
                if (item.reviewLog) delete item.reviewLog[2];
            }
            
            save();
            render();
        };

        select.onblur = saveEdit;
        select.onkeydown = (e) => {
            if (e.key === 'Enter') select.blur();
            else if (e.key === 'Escape') { render(); }
        };
        return;
    }
    
    const originalValue = propertyKey === 'tags' ? item.tags.join(', ') : item[propertyKey];
    const input = document.createElement('input'); input.type = 'text'; input.value = originalValue;
    input.style.width = '95%'; input.style.padding = '5px'; input.style.boxSizing = 'border-box'; input.style.fontSize = 'inherit';
    cell.innerHTML = ''; cell.appendChild(input); input.focus(); input.select();
    const saveEdit = () => {
        const newValue = input.value.trim();
        if (propertyKey === 'tags') {
            item.tags = newValue.split(/[ï¼Œ,ã€\s]+/).map(t => t.trim()).filter(Boolean);
        } else {
            if (newValue || propertyKey !== 'concept') { item[propertyKey] = newValue; }
            else if (propertyKey === 'concept' && !newValue) { alert("å­¦ä¹ å†…å®¹ä¸èƒ½ä¸ºç©ºã€‚"); }
        }
        save(); render();
    };
    input.onblur = saveEdit;
    input.onkeydown = (e) => {
        if (e.key === 'Enter') input.blur();
        else if (e.key === 'Escape') { input.blur(); render(); }
    };
}


/**************** åˆå§‹åŒ– ****************/
(function init(){
  if(!dateInput.value) dateInput.value = isoLocal(new Date());

  const savedAnimation = localStorage.getItem('animationPreference');
  if (savedAnimation) {
      currentAnimationEffect = savedAnimation;
      animationSelect.value = savedAnimation;
  }
  const savedSpeed = localStorage.getItem('animationSpeedPreference');
    if (savedSpeed) {
      currentAnimationSpeed = savedSpeed;
      animationSpeedSelect.value = savedSpeed;
  }
  
  populateYearFilter();
  monthFilterSelect.disabled = true;
  refreshModeStyles();
  render();
  conceptInput.focus();
})();
</script>
</body>
</html>