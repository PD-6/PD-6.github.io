<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ä¹ è¿›åº¦è¡¨ (UIä¼˜åŒ–ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            transition: background-color 0.5s ease, background 0.5s ease;
            overflow-x: hidden; /* Prevent horizontal scroll from animations */
        }
        .main-container, #statisticsView, #planToDoModal, #todayTaskView {
            transition: background-color 0.5s ease, background 0.5s ease;
        }
        /* æ»šåŠ¨æ¡æ ·å¼ */
        #modalBody::-webkit-scrollbar,
        #planModalBody::-webkit-scrollbar,
        .table-container::-webkit-scrollbar,
        #todayToDoListDisplayContainer::-webkit-scrollbar,
        #todayCompletedHistoryContainer::-webkit-scrollbar,
        #todayTaskContent::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        #modalBody::-webkit-scrollbar-track,
        #planModalBody::-webkit-scrollbar-track,
        .table-container::-webkit-scrollbar-track,
        #todayToDoListDisplayContainer::-webkit-scrollbar-track,
        #todayCompletedHistoryContainer::-webkit-scrollbar-track,
        #todayTaskContent::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #modalBody::-webkit-scrollbar-thumb,
        #planModalBody::-webkit-scrollbar-thumb,
        .table-container::-webkit-scrollbar-thumb,
        #todayToDoListDisplayContainer::-webkit-scrollbar-thumb,
        #todayCompletedHistoryContainer::-webkit-scrollbar-thumb,
        #todayTaskContent::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        #modalBody::-webkit-scrollbar-thumb:hover,
        #planModalBody::-webkit-scrollbar-thumb:hover,
        .table-container::-webkit-scrollbar-thumb:hover,
        #todayToDoListDisplayContainer::-webkit-scrollbar-thumb:hover,
        #todayCompletedHistoryContainer::-webkit-scrollbar-thumb:hover,
        #todayTaskContent::-webkit-scrollbar-thumb {
            background: #555;
        }
        /* è‡ªå®šä¹‰å¤é€‰æ¡†æ ·å¼ */
        .form-checkbox { appearance: none; -webkit-appearance: none; -moz-appearance: none; width: 1.25rem; height: 1.25rem; border-width: 1px; border-color: #d1d5db; border-radius: 0.25rem; display: inline-block; vertical-align: middle; background-origin: border-box; user-select: none; flex-shrink: 0; color: #3b82f6; background-color: #fff; }
        .form-checkbox:checked { background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e"); border-color: transparent; background-color: currentColor; background-size: 100% 100%; background-position: center; background-repeat: no-repeat; }
        .form-checkbox:focus { outline: 2px solid transparent; outline-offset: 2px; --tw-ring-inset: var(--tw-empty,/*!*/ /*!*/); --tw-ring-offset-width: 2px; --tw-ring-offset-color: #fff; --tw-ring-color: #3b82f6; --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color); --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(1px + var(--tw-ring-offset-width)) var(--tw-ring-color); box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000); }
        /* è¡Œå†…ç¼–è¾‘è¾“å…¥æ¡†æ ·å¼ */
        .inline-edit-input { width: 100%; padding: 0.125rem 0.25rem; border: 1px solid #60a5fa; border-radius: 0.25rem; font-size: 0.875rem; box-sizing: border-box; }
        .inline-edit-input:focus { outline: none; ring-width: 1px; ring-color: #3b82f6; }
        
        /* éšè—åŸç”Ÿæ•°å­—è¾“å…¥æ¡†çš„ä¸Šä¸‹ç®­å¤´ */
        .no-spinner::-webkit-inner-spin-button, 
        .no-spinner::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        .no-spinner {
            -moz-appearance: textfield;
        }

        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        .io-button, .action-button, .view-mode-button { padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500; border-radius: 0.375rem; transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform; transition-duration: 150ms; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .io-button-green { background-color: #10b981; color: white; } .io-button-green:hover { background-color: #059669; }
        .io-button-blue { background-color: #3b82f6; color: white; } .io-button-blue:hover { background-color: #2563eb; }
        .action-button-red { background-color: #ef4444; color:white; } .action-button-red:hover { background-color: #dc2626; }
        .action-button-orange { background-color: #f97316; color:white; } .action-button-orange:hover { background-color: #ea580c; }
        /* æ¨¡å¼åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .mode-button { padding: 0.625rem 1.25rem; font-size: 0.875rem; font-weight: 500; border-radius: 0.375rem; transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; border: 1px solid transparent; }
        .mode-button-active { background-color: #3b82f6; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .mode-button-inactive { background-color: #e5e7eb; color: #374151; border-color: #d1d5db; }
        .mode-button:hover:not(.mode-button-active) { background-color: #d1d5db; border-color: #9ca3af; }
        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-bar-container { width: 100%; height: 1.25rem; background-color: #e5e7eb; border-radius: 0.375rem; overflow: hidden; display: flex; align-items: center; position: relative; }
        .progress-bar-fill { height: 100%; background-color: #3b82f6; transition: width 0.3s ease-in-out; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; }
        .progress-bar-text { font-size: 0.875rem; margin-left: 0.5rem; color: #4b5563; white-space: nowrap; }
        .completion-rate-cell { display: flex; align-items: center; min-width: 150px; }
        /* ç»Ÿè®¡è§†å›¾è¿›åº¦æ¡èƒŒæ™¯ */
        .stats-progress-bar-bg { background-color: #e5e7eb; border-radius: 0.375rem; height: 1.5rem; }
        .stats-progress-bar-fill { height: 100%; border-radius: 0.375rem; transition: width 0.3s ease-in-out; }
        /* æ¨¡æ€æ¡†è¾“å…¥æ¡†æ ·å¼ */
        .modal-input { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; box-shadow: inset 0 1px 2px 0 rgba(0,0,0,0.05); }
        .modal-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        .modal-label { font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem; display: block; }
        /* é¢œè‰²é€‰æ‹©å™¨æ ·å¼ */
        .color-selector-container { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; }
        .color-selector-group { display: flex; align-items: center; gap: 0.5rem; }
        .color-selector-group label { font-size: 0.875rem; color: #374151; font-weight: 500; }
        .color-selector-group select { padding: 0.5rem 0.75rem; border-radius: 0.375rem; border: 1px solid #d1d5db; background-color: white; font-size: 0.875rem; min-width: 120px; }
        /* è§†å›¾æ¨¡å¼æŒ‰é’®æ¿€æ´»/éæ¿€æ´»çŠ¶æ€ */
        .view-mode-button-active { background-color: #3b82f6; color: white; }
        .view-mode-button-inactive { background-color: #e5e7eb; color: #374151; border-color: #d1d5db; }
        .view-mode-button:hover:not(.view-mode-button-active) { background-color: #d1d5db; }
        /* è¡¨æ ¼æ“ä½œæŒ‰é’®é—´è· */
        .table-action-button-spacing button + button { margin-left: 0.5rem; }
        /* å¾…åŠäº‹é¡¹å¤é€‰æ¡†é—´è· */
        .todo-item-checkbox { margin-left: 0.75rem; }
        /* å†å²è®°å½•åˆ é™¤æŒ‰é’® */
        .delete-history-button { background-color: transparent; border: none; color: #ef4444; cursor: pointer; padding: 0.25rem; margin-left: 0.5rem; border-radius: 0.25rem; transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out; }
        .delete-history-button:hover { background-color: #fee2e2; color: #dc2626; }
        .delete-history-button svg { width: 1rem; height: 1rem; display: inline-block; vertical-align: middle; }
        
        /* ç»Ÿè®¡èŒƒå›´æŒ‰é’®æ ·å¼ (æ–°) */
        .stats-range-btn {
            transition: all 0.2s ease;
        }
        .stats-range-btn-active {
            background-color: #3b82f6 !important;
            color: white !important;
            border-color: #3b82f6 !important;
        }

        /* --- é¼“åŠ±æ¨¡å¼æ ·å¼ --- */
        #encouragementToast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #374151; color: white; padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; opacity: 0; transition: opacity 0.5s ease-in-out, bottom 0.5s ease-in-out; pointer-events: none; }
        #encouragementToast.show { opacity: 1; bottom: 40px; }
        #moduleCompletionCelebration { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background: white; padding: 20px 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 101; transition: bottom 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #moduleCompletionCelebration.show { bottom: 50px; }
        #moduleCompletionCelebration p { font-size: 1.125rem; font-weight: 600; background: linear-gradient(to right, #8A2BE2, #FF1493); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes flash { 0%, 50%, 100% { opacity: 1; } 25%, 75% { opacity: 0.6; } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes sway { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(1deg); } 75% { transform: rotate(-1deg); } }
        @keyframes flip { 0% { transform: perspective(400px) rotateY(0); } 100% { transform: perspective(400px) rotateY(360deg); } }
        @keyframes jelly { 0%, 100% { transform: scale(1, 1); } 25% { transform: scale(1.1, 0.9); } 50% { transform: scale(0.9, 1.1); } 75% { transform: scale(1.05, 0.95); } }
        
        .animate-pulse { animation-name: pulse; }
        .animate-flash { animation-name: flash; }
        .animate-float { animation-name: float; }
        .animate-sway { animation-name: sway; }
        .animate-flip { animation-name: flip; }
        .animate-jelly { animation-name: jelly; }

        .anim-fast { animation-duration: 0.5s; }
        .anim-medium { animation-duration: 1s; }
        .anim-slow { animation-duration: 1.5s; }
    </style>
</head>
<body id="pageBody">
    <div class="mt-6 mb-6 flex flex-wrap justify-center gap-2 sm:gap-3">
        <button id="todayTaskButton" class="mode-button">ä»Šæ—¥å¾…åŠ</button>
        <button id="chineseModeButton" class="mode-button">è¯­æ–‡æ¨¡å¼</button>
        <button id="englishModeButton" class="mode-button">è‹±è¯­æ¨¡å¼</button>
        <button id="mathModeButton" class="mode-button">æ•°å­¦æ¨¡å¼</button>
        <button id="physicsModeButton" class="mode-button">ç‰©ç†æ¨¡å¼</button>
        <button id="biologyModeButton" class="mode-button">ç”Ÿç‰©æ¨¡å¼</button>
        <button id="chemistryModeButton" class="mode-button">åŒ–å­¦æ¨¡å¼</button>
    </div>

    <div id="mainContainer" class="container mx-auto bg-white shadow-xl rounded-lg p-6 md:p-8 main-container">
        <h1 id="mainTitle" class="text-3xl font-bold text-center text-gray-800 mb-4">è¯­æ–‡è¿›åº¦è¡¨</h1>

        <div class="mb-6 flex justify-center gap-2 sm:gap-3">
            <button id="tableViewButton" class="view-mode-button">è¡¨æ ¼è§†å›¾</button>
            <button id="pieChartViewButton" class="view-mode-button">é¥¼å›¾è§†å›¾</button>
        </div>

        <div id="tableViewContainer" class="overflow-x-auto shadow-md rounded-lg table-container">
            <table id="progressTable" class="min-w-full divide-y divide-gray-200 border border-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">#</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">æ¨¡å—</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">è¯¾ç¨‹æ€»æ•°</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">âœ… å·²å®Œæˆ</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">â³ å¾…å®Œæˆ</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">å®Œæˆç‡</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>

        <div id="subjectPieChartContainer" class="mt-6 hidden flex flex-col items-center">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">å½“å‰ç§‘ç›®å®Œæˆæƒ…å†µ</h3>
            <div class="w-full max-w-md h-64 md:h-80">
                 <canvas id="subjectPieChart"></canvas>
            </div>
        </div>

        <div id="totalProgress" class="mt-6 text-right text-lg text-gray-700 font-medium">
            æ­£åœ¨åŠ è½½è¿›åº¦...
        </div>

        <div class="mt-8 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 sm:space-x-3">
            <div class="flex space-x-3">
                <button id="toggleViewButton" class="io-button bg-purple-600 hover:bg-purple-700 text-white">åˆ‡æ¢è§†å›¾: æ•°å­—</button>
                <button id="openAddModuleModalButton" class="action-button bg-green-500 hover:bg-green-600 text-white">æ·»åŠ æ–°æ¨¡å—</button>
            </div>
            <div class="flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-3">
                <button id="exportDataButton" class="w-full sm:w-auto io-button io-button-green">å¯¼å‡ºæ•°æ®</button>
                <button id="importDataButton" class="w-full sm:w-auto io-button io-button-blue">å¯¼å…¥æ•°æ®</button>
                <button id="backupAllButton" class="w-full sm:w-auto io-button bg-indigo-600 hover:bg-indigo-700 text-white">ğŸ’¾ å…¨å±€å¤‡ä»½(é˜²ä¸¢)</button>
            </div>
            <input type="file" id="fileImporter" accept=".json" style="display: none;">
            <input type="file" id="backupImporter" accept=".json" style="display: none;">
        </div>
        <div id="ioStatusMessage" class="mt-3 text-right text-sm text-gray-600 h-5"></div>

        <div id="encouragementSettings" class="mt-6 pt-4 border-t border-gray-200 flex flex-col sm:flex-row justify-center items-center gap-4">
             <div class="color-selector-group">
                <label for="animationEffectSelector">åŠ¨æ•ˆ:</label>
                <select id="animationEffectSelector" class="p-2 border rounded-md"></select>
            </div>
            <div class="color-selector-group">
                <label for="animationSpeedSelector">é€Ÿåº¦:</label>
                <select id="animationSpeedSelector" class="p-2 border rounded-md"></select>
            </div>
        </div>

        <div class="mt-2 flex flex-col sm:flex-row justify-center items-center gap-4">
            <button id="showOverallStatsButton" class="io-button bg-sky-500 hover:bg-sky-600 text-white px-6 py-3 text-base">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 001 1h14a1 1 0 001-1V4a1 1 0 00-1-1H3zm10 2a1 1 0 10-2 0v8a1 1 0 102 0V5zm-4 2a1 1 0 10-2 0v6a1 1 0 102 0V7zm-4 2a1 1 0 10-2 0v4a1 1 0 102 0V9z" clip-rule="evenodd" /></svg>
                æŸ¥çœ‹æ€»ç»Ÿè®¡
            </button>
        </div>

        <div class="color-selector-container">
            <div class="color-selector-group"><label for="pageBgColorSelector">é¡µé¢èƒŒæ™¯:</label><select id="pageBgColorSelector"></select></div>
            <div class="color-selector-group"><label for="contentBgColorSelector">å†…å®¹èƒŒæ™¯:</label><select id="contentBgColorSelector"></select></div>
        </div>
    </div>

    <!-- ä»Šæ—¥å¾…åŠè§†å›¾ -->
    <div id="todayTaskView" class="container mx-auto bg-white shadow-xl rounded-lg p-6 md:p-8 hidden mt-8">
        <!-- å¤´éƒ¨åŒºåŸŸä¼˜åŒ–ï¼šå°†æŒ‰é’®ç§»è‡³æ ‡é¢˜æ— -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 pb-4 border-b border-gray-300 gap-4">
            <div class="flex flex-wrap items-center gap-4">
                <h2 class="text-3xl font-bold text-gray-800 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 inline-block mr-3 text-teal-600" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                    </svg>
                    ä»Šæ—¥å¾…åŠ
                </h2>
                <!-- ç§»åŠ¨åˆ°è¿™é‡Œçš„æŒ‰é’® -->
                <button id="goToStatsFromTaskButton" class="io-button bg-sky-500 hover:bg-sky-600 text-white px-4 py-2 text-sm shadow-md transition-transform transform hover:scale-105 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 001 1h14a1 1 0 001-1V4a1 1 0 00-1-1H3zm10 2a1 1 0 10-2 0v8a1 1 0 102 0V5zm-4 2a1 1 0 10-2 0v6a1 1 0 102 0V7zm-4 2a1 1 0 10-2 0v4a1 1 0 102 0V9z" clip-rule="evenodd" /></svg>
                    æŸ¥çœ‹æ€»ç»Ÿè®¡
                </button>
            </div>
            
            <div class="flex space-x-3">
                <button id="backToSubjectViewButton" class="io-button bg-gray-500 hover:bg-gray-600 text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>è¿”å›å­¦ä¹ è§†å›¾</button>
            </div>
        </div>

        <div id="todayTaskContent" class="max-h-[calc(100vh-200px)] overflow-y-auto pr-2">
            <div>
                <h3 id="todayToDoListTitle" class="text-2xl font-semibold text-gray-700 mb-4 text-center">ä»Šæ—¥å¾…åŠåˆ—è¡¨</h3>
                <p class="text-center text-xs text-gray-400 mb-2">ğŸ’¡ åŒå‡»ä»»åŠ¡æ¡ç›®å¯å°†å…¶ç§»é™¤è§„åˆ’</p>
                <div id="todayToDoListDisplayContainer" class="bg-white p-4 rounded-lg shadow-md max-h-60 overflow-y-auto mb-6">
                     <div id="todayToDoListDisplay" class="space-y-3"></div>
                </div>
            </div>
            <div class="mt-8 pt-6 border-t border-gray-300">
                <h3 id="todayCompletedHistoryTitle" class="text-xl font-semibold text-gray-600 mb-4 text-center">ä»Šæ—¥å·²å®Œæˆå†å²è®°å½•</h3>
                <div id="todayCompletedHistoryContainer" class="bg-slate-50 p-4 rounded-lg shadow-inner max-h-60 overflow-y-auto">
                     <div id="todayCompletedHistoryDisplay" class="space-y-2"></div>
                </div>
            </div>
            <div class="mt-8 pt-6 border-t border-gray-300">
                <h3 class="text-xl font-semibold text-gray-600 mb-4 text-center">æ¯æ—¥å®Œæˆä»»åŠ¡æ•°ç»Ÿè®¡</h3>
                
                <!-- æ–°å¢ï¼šç»Ÿè®¡èŒƒå›´ç­›é€‰å™¨ -->
                <div class="mb-4 flex flex-col md:flex-row justify-center items-center gap-4 flex-wrap">
                    <!-- é¢„è®¾èŒƒå›´æŒ‰é’® -->
                    <div class="flex gap-2 flex-wrap justify-center">
                        <button class="stats-range-btn px-3 py-1 bg-white border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-100" data-range="7">1å‘¨</button>
                        <button class="stats-range-btn px-3 py-1 bg-white border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-100" data-range="14">2å‘¨</button>
                        <button class="stats-range-btn px-3 py-1 bg-white border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-100" data-range="30">1ä¸ªæœˆ</button>
                        <button class="stats-range-btn px-3 py-1 bg-white border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-100" data-range="90">3ä¸ªæœˆ</button>
                        <button class="stats-range-btn px-3 py-1 bg-white border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-100" data-range="180">6ä¸ªæœˆ</button>
                        <button class="stats-range-btn px-3 py-1 bg-white border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-100" data-range="365">1å¹´</button>
                        <button class="stats-range-btn px-3 py-1 bg-blue-50 border border-blue-200 text-blue-700 rounded-md text-sm font-medium stats-range-btn-active" data-range="all">å…¨éƒ¨</button>
                    </div>
                    <!-- è‡ªå®šä¹‰èŒƒå›´ -->
                    <div class="flex items-center gap-2">
                        <input type="date" id="statsStartDate" class="border border-gray-300 rounded-md px-2 py-1 text-sm text-gray-700">
                        <span class="text-gray-400">-</span>
                        <input type="date" id="statsEndDate" class="border border-gray-300 rounded-md px-2 py-1 text-sm text-gray-700">
                        <button id="statsCustomRangeBtn" class="px-3 py-1 bg-indigo-500 text-white rounded-md text-sm hover:bg-indigo-600 transition-colors">åº”ç”¨</button>
                    </div>
                </div>
                <!-- ç»“æŸæ–°å¢ -->

                <div class="w-full max-w-3xl mx-auto bg-white p-4 rounded-lg shadow">
                    <canvas id="dailyCompletionChartCanvas" style="height: 300px;"></canvas>
                </div>
            </div>
        </div>
        <div class="color-selector-container">
            <div class="color-selector-group"><label for="todayTaskPageBgColorSelector">é¡µé¢èƒŒæ™¯:</label><select id="todayTaskPageBgColorSelector"></select></div>
            <div class="color-selector-group"><label for="todayTaskContentBgColorSelector">å†…å®¹èƒŒæ™¯:</label><select id="todayTaskContentBgColorSelector"></select></div>
        </div>
    </div>

    <div id="addModuleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold text-gray-800">æ·»åŠ æ–°æ¨¡å—</h3><button id="closeAddModuleModalButton" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button></div><div class="space-y-4"><div><label for="modalNewModuleName" class="modal-label">æ¨¡å—åç§°:</label><input type="text" id="modalNewModuleName" class="modal-input" placeholder="ä¾‹å¦‚: å…‰å­¦å®éªŒ"></div><div><label for="modalNewModuleTotal" class="modal-label">è¯¾ç¨‹æ€»æ•°:</label><input type="number" id="modalNewModuleTotal" class="modal-input" placeholder="ä¾‹å¦‚: 10" min="0"></div></div><div id="modalAddModuleStatusMessage" class="mt-3 text-sm h-5 text-left"></div><div class="mt-6 flex justify-end space-x-3"><button id="cancelAddModuleButton" class="action-button bg-gray-200 hover:bg-gray-300 text-gray-700">å–æ¶ˆ</button><button id="confirmAddModuleButton" class="action-button bg-green-500 hover:bg-green-600 text-white">ç¡®è®¤æ·»åŠ </button></div></div>
    </div>

    <div id="editProgressModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-5 sm:p-6 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200">
                <h2 id="modalTitle" class="text-xl font-semibold text-gray-800">æ›´æ–°è¿›åº¦</h2>
                <button id="closeEditProgressModalButton" class="text-gray-400 hover:text-gray-600 text-3xl leading-none transition-colors duration-150">&times;</button>
            </div>
            <div id="modalBody" class="overflow-y-auto mb-4 pr-2 flex-grow">
                </div>
            <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                <div><button id="deleteModuleButton" class="action-button action-button-red">åˆ é™¤æ¨¡å—</button></div>
                <div class="space-x-3">
                    <button id="cancelEditProgressButton" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-150">å–æ¶ˆ</button>
                    <button id="saveEditProgressButton" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-150">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <div id="planToDoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-5 sm:p-6 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200">
                <h2 id="planModalTitle" class="text-xl font-semibold text-gray-800">è§„åˆ’ä»Šæ—¥å¾…åŠ</h2>
                <button id="closePlanToDoModalButton" class="text-gray-400 hover:text-gray-600 text-3xl leading-none transition-colors duration-150">&times;</button>
            </div>
            <div id="planModalBody" class="overflow-y-auto mb-4 pr-2 flex-grow">
                </div>
            <div class="mt-6 flex justify-end space-x-3 pt-4 border-t border-gray-200">
                <button id="cancelPlanToDoButton" class="action-button bg-gray-200 hover:bg-gray-300 text-gray-700">å–æ¶ˆ</button>
                <button id="confirmPlanToDoButton" class="action-button bg-orange-500 hover:bg-orange-600 text-white">æ›´æ–°ä»Šæ—¥è®¡åˆ’</button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ï¼šåˆ é™¤å¾…åŠç¡®è®¤å¼¹çª— -->
    <div id="deleteTodoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">å–æ¶ˆä»»åŠ¡è§„åˆ’</h3>
            <p class="text-gray-600 mb-6">ç¡®å®šè¦å°†æ­¤ä»»åŠ¡ä»ä»Šæ—¥å¾…åŠä¸­ç§»é™¤å—ï¼Ÿ</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelDeleteTodoButton" class="action-button bg-gray-200 hover:bg-gray-300 text-gray-700">å–æ¶ˆ</button>
                <button id="confirmDeleteTodoButton" class="action-button bg-red-500 hover:bg-red-600 text-white">ç¡®è®¤ç§»é™¤</button>
            </div>
        </div>
    </div>

    <!-- æ€»ä½“å­¦ä¹ ç»Ÿè®¡è§†å›¾ -->
    <div id="statisticsView" class="container mx-auto bg-white shadow-xl rounded-lg p-6 md:p-8 hidden mt-8">
        <!-- å¤´éƒ¨åŒºåŸŸä¼˜åŒ–ï¼šå°†æŒ‰é’®ç§»è‡³æ ‡é¢˜æ— -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 pb-4 border-b border-gray-300 gap-4">
            <div class="flex flex-wrap items-center gap-4">
                <h2 class="text-3xl font-bold text-gray-800 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 inline-block mr-3 text-sky-600" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" /><path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" /></svg>
                    <span id="statisticsViewTitle">æ€»ä½“å­¦ä¹ ç»Ÿè®¡</span>
                </h2>
                <!-- ç§»åŠ¨åˆ°è¿™é‡Œçš„æŒ‰é’® -->
                 <button id="goToTaskFromStatsButton" class="io-button bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 text-sm shadow-md transition-transform transform hover:scale-105 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                    </svg>
                    æŸ¥çœ‹ä»Šæ—¥å¾…åŠ
                </button>
            </div>

            <div class="flex space-x-3">
                <button id="backToMainViewButton" class="io-button bg-gray-500 hover:bg-gray-600 text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>è¿”å›å­¦ä¹ è§†å›¾</button>
            </div>
        </div>

        <div id="overallStatsContentContainer">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-gray-700">
                <div class="bg-slate-50 p-6 rounded-xl shadow-lg border border-slate-200"><h3 class="text-xl font-semibold text-slate-800 mb-2">æ¨¡å—æ€»æ•° (æ‰€æœ‰ç§‘ç›®)</h3><p id="statsTotalModules" class="text-4xl font-bold text-sky-600">0</p></div>
                <div class="bg-slate-50 p-6 rounded-xl shadow-lg border border-slate-200"><h3 class="text-xl font-semibold text-slate-800 mb-2">è¯¾ç¨‹æ€»æ•° (æ‰€æœ‰ç§‘ç›®)</h3><p id="statsTotalCourses" class="text-4xl font-bold text-sky-600">0</p></div>
                <div class="bg-green-50 p-6 rounded-xl shadow-lg border border-green-200 col-span-1 md:col-span-2">
                    <h3 class="text-xl font-semibold text-green-800 mb-3">âœ… å·²å®Œæˆè¯¾ç¨‹</h3>
                    <div id="statsCompletedCoursesDisplay"></div>
                </div>
                <div class="bg-amber-50 p-6 rounded-xl shadow-lg border border-amber-200 col-span-1 md:col-span-2">
                    <h3 class="text-xl font-semibold text-amber-800 mb-3">â³ å¾…å®Œæˆè¯¾ç¨‹</h3>
                    <div id="statsPendingCoursesDisplay"></div>
                </div>
                <div class="bg-sky-50 p-6 rounded-xl shadow-lg border border-sky-200 col-span-1 md:col-span-2 relative">
                    <h3 class="text-xl font-semibold text-sky-800 mb-2 text-center">æ€»ä½“å®Œæˆæƒ…å†µå›¾ç¤º</h3>
                    <div class="w-full max-w-lg mx-auto h-64 md:h-80">
                        <canvas id="overallPieChart"></canvas>
                    </div>
                    <!-- æ–°å¢ï¼šæ¸…é™¤æ¯æ—¥ç»Ÿè®¡æ•°æ®æŒ‰é’® (ä½äºå³ä¸‹è§’) -->
                    <div class="absolute bottom-4 right-6">
                        <button id="clearDailyStatsButton" class="text-xs text-red-400 hover:text-red-600 transition-colors duration-200 flex items-center gap-1" title="æ¸…é™¤æ¯æ—¥å®Œæˆä»»åŠ¡æ•°çš„ç»Ÿè®¡å›¾è¡¨æ•°æ®">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            æ¸…é™¤æ¯æ—¥ç»Ÿè®¡
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="encouragementToast"></div>
    <div id="moduleCompletionCelebration"><p>æ­å–œä½ å·²ç»å®Œæˆäº†å¯¹è¿™ä¸ªçŸ¥è¯†ç‚¹æ‰€æœ‰é˜¶æ®µçš„å¤ä¹ ,èƒœåˆ©æŒ‡æ—¥å¯å¾…åŠ æ²¹!</p></div>

<script>
    // åˆå§‹æ•°æ®
    const initialMathData = [ { id: 1, name: 'è¡”æ¥', total: 3, completedRaw: '2, 3' },{ id: 2, name: 'é›†åˆ', total: 6, completedRaw: '1â€“6' },{ id: 3, name: 'ä¸ç­‰å¼', total: 5, completedRaw: '1â€“5' },{ id: 4, name: 'å‡½æ•°', total: 20, completedRaw: '1' },{ id: 5, name: 'ä¸‰è§’å‡½æ•°', total: 11, completedRaw: 'â€”' },{ id: 6, name: 'å’Œå‘é‡è§£ä¸‰è§’å½¢', total: 21, completedRaw: 'â€”' },{ id: 7, name: 'ç«‹ä½“å‡ ä½•', total: 10, completedRaw: 'â€”' },{ id: 8, name: 'è§£æå‡ ä½•', total: 20, completedRaw: 'â€”' },{ id: 9, name: 'æ•°åˆ—', total: 7, completedRaw: 'â€”' },{ id: 10, name: 'å¯¼æ•°', total: 10, completedRaw: 'â€”' },{ id: 11, name: 'æ’åˆ—ç»„åˆæ¦‚ç‡ç»Ÿè®¡', total: 2, completedRaw: 'â€”' }];
    const initialBiologyData = [ { id: 1, name: 'èµ°è¿›ç»†èƒ', total: 2, completedRaw: '1â€“2' },{ id: 2, name: 'åˆ†å­', total: 9, completedRaw: '1â€“7' },{ id: 3, name: 'ç»†èƒ', total: 4, completedRaw: 'â€”' },{ id: 4, name: 'ç‰©è´¨è¿è¾“', total: 3, completedRaw: 'â€”' },{ id: 5, name: 'ç»†èƒä»£è°¢', total: 10, completedRaw: 'â€”' },{ id: 6, name: 'ç»†èƒç”Ÿå‘½å†ç¨‹', total: 12, completedRaw: 'â€”' },{ id: 7, name: 'é—ä¼ ', total: 19, completedRaw: 'â€”' },{ id: 8, name: 'åŸºå› çš„æœ¬è´¨', total: 7, completedRaw: 'â€”' },{ id: 9, name: 'å˜å¼‚', total: 8, completedRaw: 'â€”' },{ id: 10, name: 'è¿›åŒ–', total: 5, completedRaw: 'â€”' },{ id: 11, name: 'å†…ç¯å¢ƒ', total: 4, completedRaw: 'â€”' },{ id: 12, name: 'ç¥ç»è°ƒèŠ‚', total: 6, completedRaw: 'â€”' },{ id: 13, name: 'ä½“æ¶²è°ƒèŠ‚', total: 5, completedRaw: 'â€”' },{ id: 14, name: 'å…ç–«', total: 5, completedRaw: 'â€”' },{ id: 15, name: 'æ¤ç‰©æ¿€ç´ ', total: 4, completedRaw: 'â€”' },{ id: 16, name: 'ç”Ÿæ€', total: 13, completedRaw: 'â€”' },{ id: 17, name: 'å‘é…µå·¥ç¨‹', total: 5, completedRaw: 'â€”' },{ id: 18, name: 'ç»†èƒå·¥ç¨‹', total: 7, completedRaw: 'â€”' },{ id: 19, name: 'åŸºå› å·¥ç¨‹', total: 7, completedRaw: 'â€”' }];
    const initialChemistryData = [ { id: 1, name: 'ç‰©è´¨çš„åˆ†ç±»åŠè½¬åŒ–', total: 4, completedRaw: '1-4' },{ id: 2, name: 'ç¦»å­ååº”', total: 7, completedRaw: '1-5' },{ id: 3, name: 'æ°§åŒ–è¿˜åŸ', total: 8, completedRaw: 'â€”' },{ id: 4, name: 'é’ åŠé’ åŒ–åˆç‰©', total: 6, completedRaw: 'â€”' },{ id: 5, name: 'æ°¯åŠæ°¯åŒ–ç‰©', total: 3, completedRaw: 'â€”' },{ id: 6, name: 'åˆæ­¥æœ‰æœºï¼ˆåŸºç¡€çƒƒè¡ç”Ÿç‰©ï¼‰', total: 11, completedRaw: 'â€”' },{ id: 7, name: 'é’¾åŠé’¾åŒ–åˆç‰©', total: 6, completedRaw: 'â€”' },{ id: 8, name: 'é‡‘å±ææ–™', total: 1, completedRaw: 'â€”' },{ id: 9, name: 'é•åŠé•åŒ–åˆç‰©', total: 3, completedRaw: 'â€”' },{ id: 10, name: 'å…ƒç´ å‘¨æœŸå¾‹', total: 12, completedRaw: 'â€”' },{ id: 11, name: 'ç¡…åŠç¡…åŒ–ç‰©', total: 7, completedRaw: 'â€”' },{ id: 12, name: 'æ°®åŠå…¶åŒ–åˆç‰©', total: 7, completedRaw: 'â€”' },{ id: 13, name: 'ç¡«åŠå…¶åŒ–åˆç‰©', total: 1, completedRaw: 'â€”' },{ id: 14, name: 'ç£·åŠå…¶åŒ–åˆç‰©', total: 2, completedRaw: 'â€”' },{ id: 15, name: 'ååº”ä¸èƒ½é‡', total: 6, completedRaw: 'â€”' },{ id: 16, name: 'æœ‰æœºåŸºç¡€ç»¼åˆ', total: 7, completedRaw: 'â€”' },{ id: 17, name: 'åŒ–å­¦ä¸å¯æŒç»­å‘å±•', total: 2, completedRaw: 'â€”' },{ id: 18, name: 'çƒ­æ•ˆåº”', total: 4, completedRaw: 'â€”' },{ id: 19, name: 'ååº”é€Ÿç‡', total: 5, completedRaw: 'â€”' },{ id: 20, name: 'åŒ–å­¦å¹³è¡¡', total: 12, completedRaw: 'â€”' },{ id: 21, name: 'ç¦»å­å¹³è¡¡ï¼ˆé…¸ç¢±å¹³è¡¡ï¼‰', total: 24, completedRaw: 'â€”' },{ id: 22, name: 'åŸç”µæ± ', total: 6, completedRaw: 'â€”' },{ id: 23, name: 'ç”µè§£æ± ', total: 6, completedRaw: 'â€”' },{ id: 24, name: 'é‡‘å±è…èš€ä¸é˜²æŠ¤', total: 2, completedRaw: 'â€”' },{ id: 25, name: 'åŸå­ç»“æ„', total: 8, completedRaw: 'â€”' },{ id: 26, name: 'åˆ†å­ç»“æ„', total: 9, completedRaw: 'â€”' },{ id: 27, name: 'æ™¶ä½“', total: 9, completedRaw: 'â€”' },{ id: 28, name: 'æœ‰æœº', total: 20, completedRaw: 'â€”' }];
    const initialChineseData = [ { id: 1, name: 'å­¦ä¹ æŠ€å·§', total: 9, completedRaw: 'â€”' },{ id: 2, name: 'å™è¿°', total: 27, completedRaw: 'â€”' },{ id: 3, name: 'è®®è®º', total: 7, completedRaw: 'â€”' },{ id: 4, name: 'å¤è¯—æ­Œ', total: 9, completedRaw: 'â€”' },{ id: 5, name: 'å°è¯´æ•£æ–‡', total: 27, completedRaw: 'â€”' },{ id: 6, name: 'ä¿¡æ¯ç±»', total: 7, completedRaw: 'â€”' },{ id: 7, name: 'è¯­è¨€æ–‡å­—è¿ç”¨', total: 14, completedRaw: 'â€”' },{ id: 8, name: 'æŠ±ä½›è„š', total: 7, completedRaw: 'â€”' },{ id: 9, name: 'æ¨¡æ‹Ÿé¢˜', total: 11, completedRaw: 'â€”' },{ id: 10, name: 'åœ°æ¯¯å¼', total: 2, completedRaw: 'â€”' }];
    const initialPhysicsData = [ { id: 1, name: 'è¿åŠ¨çš„æè¿°', total: 14, completedRaw: '1-14' }, { id: 2, name: 'åŒ€å˜é€Ÿç›´çº¿è¿åŠ¨', total: 16, completedRaw: 'â€”' }, { id: 3, name: 'ç›¸äº’ä½œç”¨åŠ›', total: 26, completedRaw: 'â€”' }, { id: 4, name: 'è¿åŠ¨å’ŒåŠ›çš„å…³ç³»', total: 24, completedRaw: 'â€”' }, { id: 5, name: 'æ›²çº¿è¿åŠ¨', total: 9, completedRaw: 'â€”' }, { id: 6, name: 'åœ†å‘¨è¿åŠ¨', total: 11, completedRaw: 'â€”' }, { id: 7, name: 'å¤©ä½“è¿åŠ¨', total: 17, completedRaw: 'â€”' }, { id: 8, name: 'æœºæ¢°èƒ½å®ˆæ’å®šå¾‹', total: 25, completedRaw: 'â€”' }, { id: 9, name: 'åŠ¨é‡ä¸å†²é‡', total: 16, completedRaw: 'â€”' }, { id: 10, name: 'åŠ¨é‡å®ˆæ’å®šå¾‹', total: 12, completedRaw: 'â€”' }, { id: 11, name: 'ç®€è°è¿åŠ¨', total: 5, completedRaw: 'â€”' }, { id: 12, name: 'æ³¢åŠ¨', total: 14, completedRaw: 'â€”' }, { id: 13, name: 'åŠ¨é‡', total: 24, completedRaw: 'â€”' },  { id: 14, name: 'æœºæ¢°æŒ¯åŠ¨', total: 8, completedRaw: 'â€”' }, { id: 15, name: 'æœºæ¢°æ³¢', total: 11, completedRaw: 'â€”' }, { id: 16, name: 'å…‰', total: 11, completedRaw: 'â€”' }, { id: 17, name: 'ç”µç£æ„Ÿåº”', total: 30, completedRaw: 'â€”' }, { id: 18, name: 'äº¤æµç”µæµ', total: 16, completedRaw: 'â€”' }, { id: 19, name: 'çƒ­å­¦', total: 22, completedRaw: 'â€”' }, { id: 20, name: 'è¿‘ä»£ç‰©ç†', total: 14, completedRaw: 'â€”' }];
    const initialEnglishData = [
        { id: 1, name: 'è¯æ±‡ç§¯ç´¯', total: 20, completedRaw: '1-5' },
        { id: 2, name: 'è¯­æ³•åŸºç¡€', total: 15, completedRaw: 'â€”' },
        { id: 3, name: 'é˜…è¯»ç†è§£', total: 25, completedRaw: 'â€”' },
        { id: 4, name: 'å†™ä½œç»ƒä¹ ', total: 10, completedRaw: 'â€”' },
        { id: 5, name: 'å¬åŠ›è®­ç»ƒ', total: 18, completedRaw: 'â€”' }
    ];

    // å…¨å±€æ•°æ®ç»“æ„
    let allData = {
        Chinese: { modules: [], title: 'è¯­æ–‡è¿›åº¦è¡¨', fileName: 'chinese_progress_data.json', initialRawData: initialChineseData, color: 'rgba(255, 99, 132, 0.7)' },
        English: { modules: [], title: 'è‹±è¯­è¿›åº¦è¡¨', fileName: 'english_progress_data.json', initialRawData: initialEnglishData, color: 'rgba(255, 159, 64, 0.7)' },
        Math: { modules: [], title: 'æ•°å­¦è¿›åº¦è¡¨', fileName: 'math_progress_data.json', initialRawData: initialMathData, color: 'rgba(54, 162, 235, 0.7)' },
        Physics: { modules: [], title: 'ç‰©ç†è¿›åº¦è¡¨', fileName: 'physics_progress_data.json', initialRawData: initialPhysicsData, color: 'rgba(255, 206, 86, 0.7)' },
        Biology: { modules: [], title: 'ç”Ÿç‰©è¿›åº¦è¡¨', fileName: 'biology_progress_data.json', initialRawData: initialBiologyData, color: 'rgba(75, 192, 192, 0.7)' },
        Chemistry: { modules: [], title: 'åŒ–å­¦è¿›åº¦è¡¨', fileName: 'chemistry_progress_data.json', initialRawData: initialChemistryData, color: 'rgba(153, 102, 255, 0.7)' }
    };
    // å½“å‰çŠ¶æ€å˜é‡
    let currentAppView = 'subject';
    let currentSubject = 'Chinese';
    let currentProgressViewInTable = localStorage.getItem('tableProgressViewMode') || 'percentage';
    let currentMainDisplayMode = 'table';
    let currentEditingModuleInternalId = null;
    let currentPlanningModuleInternalId = null;
    let currentTodoIdToDelete = null; // æ–°å¢ï¼šå½“å‰è¦åˆ é™¤çš„å¾…åŠID

    // ä»Šæ—¥å¾…åŠä¸å†å²è®°å½•ç›¸å…³
    let todayToDoList = [];
    let todayCompletedHistoryList = [];
    let dailyCompletionStats = [];

    // Chart.js å®ä¾‹
    let subjectPieChartInstance = null;
    let overallPieChartInstance = null;
    let dailyCompletionChartInstance = null;

    // é¢œè‰²é€‰é¡¹
    const colorOptions = [ { name: "æ— èƒŒæ™¯", value: "transparent", pageDefault: "#f3f4f6", contentDefault: "#ffffff" }, { name: "é›ªè‰² (Snow)", value: "#FFFAFA" }, { name: "èŠ±ç™½è‰² (FloralWhite)", value: "#FFFAF0" }, { name: "è±¡ç‰™ç™½ (Ivory)", value: "#FFFFF0" }, { name: "æµ·è´è‰² (Seashell)", value: "#FFF5EE" }, { name: "æ—§è•¾ä¸ (OldLace)", value: "#FDF5E6" }, { name: "è–„è·å¥¶æ²¹ (MintCream)", value: "#F5FFFA" }, { name: "æ·¡è“ (AliceBlue)", value: "#F0F8FF" }, { name: "è–°è¡£è‰ç´«çº¢ (LavenderBlush)", value: "#FFF0F5" }, { name: "è”šè“ (Azureish White)", value: "#F0FFFF" }, { name: "å¹½çµç™½ (GhostWhite)", value: "#F8F8FF" }, { name: "ç™½çƒŸ (WhiteSmoke)", value: "#F5F5F5" }, { name: "äºšéº»è‰² (Linen)", value: "#FAF0E6" }, { name: "å¤è‘£ç™½ (AntiqueWhite)", value: "#FAEBD7" }, { name: "èœœç“œç»¿ (Honeydew)", value: "#F0FFF0" }, { name: "æµ…ç²‰çº¢ (LightPink)", value: "#FFB6C1" }, { name: "æ·¡çŠç‘šè‰² (LightCoral)", value: "#F08080" }, { name: "æ·¡é’è‰² (PaleTurquoise)", value: "#AFEEEE" }, { name: "æ·¡é‡‘è‰² (PaleGoldenrod)", value: "#EEE8AA" }, { name: "æ·¡ç° (Gainsboro)", value: "#DCDCDC" }, { name: "æµ…é’¢è“ (LightSteelBlue)", value: "#B0C4DE" }, { name: "çº¢ç™½å‚åŠ (æ¸å˜)", value: "linear-gradient(to right, #ffcccb 50%, #ffffff 50%)" }, { name: "è“ç»¿æ¸…æ–° (æ¸å˜)", value: "linear-gradient(to right, #e0f2f1, #b2dfdb)" }, { name: "æ´»åŠ›æ©™é»„ (æ¸å˜)", value: "linear-gradient(to right, #ffebcc, #ffd8a8)" }, { name: "å®é™è“ç´« (æ¸å˜)", value: "linear-gradient(to right, #e6e6fa, #d8bfd8)" }, { name: "ç´«ç²‰æ¢¦å¹» (æ¸å˜)", value: "linear-gradient(135deg, #dab3ff, #ffb3d9)" }, { name: "æµ·æ´‹å¾®é£ (æ¸å˜)", value: "linear-gradient(135deg, #a0c4ff, #b6e2d3)" }, { name: "æ—¥å‡ºä¹‹å…‰ (æ¸å˜)", value: "linear-gradient(135deg, #ffcc33, #ff9966)" }, { name: "è–„é›¾ç«ç‘° (æ¸å˜)", value: "linear-gradient(135deg, #e6dee9, #f0d9e7)" }, { name: "æ·±ç©ºå¥¥ç§˜ (æ¸å˜)", value: "linear-gradient(135deg, #2c3e50, #4ca1af)" }, { name: "ç†”å²©ä¹‹çº¢ (æ¸å˜)", value: "linear-gradient(135deg, #ff416c, #ff4b2b)" } ];

    // --- é¼“åŠ±æ¨¡å¼å˜é‡ ---
    let currentAnimationEffect = 'pulse';
    let currentAnimationSpeed = 'anim-medium';
    const encouragementQuotes = [
        "è®°å¿†æ­£åœ¨è¢«å·©å›º, åšæŒå°±æ˜¯èƒœåˆ©!", "æ¯ä¸€æ¬¡ç‚¹å‡»ï¼Œéƒ½æ˜¯å‘ç›®æ ‡è¿ˆè¿›çš„ä¸€å¤§æ­¥ã€‚", "ä½ çš„åŠªåŠ›ï¼Œæ—¶é—´éƒ½çŸ¥é“ã€‚", "å­¦æ— æ­¢å¢ƒï¼Œæ°”æœ‰æµ©ç„¶ã€‚", "ä¸ç§¯è·¬æ­¥ï¼Œæ— ä»¥è‡³åƒé‡Œã€‚", "ä¹¦å±±æœ‰è·¯å‹¤ä¸ºå¾„ï¼Œå­¦æµ·æ— æ¶¯è‹¦ä½œèˆŸã€‚", "çŸ¥è¯†æ”¹å˜å‘½è¿ï¼Œå­¦ä¹ æˆå°±æœªæ¥ã€‚", "ä¸šç²¾äºå‹¤ï¼Œè’äºå¬‰ï¼›è¡Œæˆäºæ€ï¼Œæ¯äºéšã€‚", "å¤©æ‰å°±æ˜¯ç™¾åˆ†ä¹‹ä¹åä¹çš„æ±—æ°´åŠ ç™¾åˆ†ä¹‹ä¸€çš„çµæ„Ÿã€‚", "å¿—ä¸å¼ºè€…æ™ºä¸è¾¾ã€‚", "ä¸–ä¸Šæ— éš¾äº‹ï¼Œåªè¦è‚¯æ”€ç™»ã€‚", "ä¸ºä¸­åä¹‹å´›èµ·è€Œè¯»ä¹¦ã€‚", "è¯»ä¸‡å·ä¹¦ï¼Œè¡Œä¸‡é‡Œè·¯ã€‚", "é»‘å‘ä¸çŸ¥å‹¤å­¦æ—©ï¼Œç™½é¦–æ–¹æ‚”è¯»ä¹¦è¿Ÿã€‚", "å¾ç”Ÿä¹Ÿæœ‰æ¶¯ï¼Œè€ŒçŸ¥ä¹Ÿæ— æ¶¯ã€‚", "è·¯æ¼«æ¼«å…¶ä¿®è¿œå…®ï¼Œå¾å°†ä¸Šä¸‹è€Œæ±‚ç´¢ã€‚", "éå­¦æ— ä»¥å¹¿æ‰ï¼Œéå¿—æ— ä»¥æˆå­¦ã€‚", "é”²è€Œèˆä¹‹ï¼Œæœ½æœ¨ä¸æŠ˜ï¼›é”²è€Œä¸èˆï¼Œé‡‘çŸ³å¯é•‚ã€‚", "å°‘å£®ä¸åŠªåŠ›ï¼Œè€å¤§å¾’ä¼¤æ‚²ã€‚", "å®å‰‘é”‹ä»ç£¨ç ºå‡ºï¼Œæ¢…èŠ±é¦™è‡ªè‹¦å¯’æ¥ã€‚", "ä¸‰äººè¡Œï¼Œå¿…æœ‰æˆ‘å¸ˆç„‰ã€‚", "æ¸©æ•…è€ŒçŸ¥æ–°ï¼Œå¯ä»¥ä¸ºå¸ˆçŸ£ã€‚", "ç»³é”¯æœ¨æ–­ï¼Œæ°´æ»´çŸ³ç©¿ã€‚", "åƒé‡Œä¹‹è¡Œï¼Œå§‹äºè¶³ä¸‹ã€‚", "ä¸é£åˆ™å·²ï¼Œä¸€é£å†²å¤©ï¼›ä¸é¸£åˆ™å·²ï¼Œä¸€é¸£æƒŠäººã€‚", "æ˜æ—¥å¤æ˜æ—¥ï¼Œæ˜æ—¥ä½•å…¶å¤šã€‚æˆ‘ç”Ÿå¾…æ˜æ—¥ï¼Œä¸‡äº‹æˆè¹‰è·ã€‚", "ç››å¹´ä¸é‡æ¥ï¼Œä¸€æ—¥éš¾å†æ™¨ã€‚åŠæ—¶å½“å‹‰åŠ±ï¼Œå²æœˆä¸å¾…äººã€‚", "è¯»ä¹¦ç ´ä¸‡å·ï¼Œä¸‹ç¬”å¦‚æœ‰ç¥ã€‚", "åšå­¦ä¹‹ï¼Œå®¡é—®ä¹‹ï¼Œæ…æ€ä¹‹ï¼Œæ˜è¾¨ä¹‹ï¼Œç¬ƒè¡Œä¹‹ã€‚", "ç«‹å¿—å®œæ€çœŸå“æ ¼ï¼Œè¯»ä¹¦é¡»å°½è‹¦åŠŸå¤«ã€‚", "éæ·¡æ³Šæ— ä»¥æ˜å¿—ï¼Œéå®é™æ— ä»¥è‡´è¿œã€‚", "çŸ¥ä¹‹è€…ä¸å¦‚å¥½ä¹‹è€…ï¼Œå¥½ä¹‹è€…ä¸å¦‚ä¹ä¹‹è€…ã€‚", "ç‰ä¸ç¢ï¼Œä¸æˆå™¨ï¼›äººä¸å­¦ï¼Œä¸çŸ¥é“ã€‚", "å­¦è€Œä¸æ€åˆ™ç½”ï¼Œæ€è€Œä¸å­¦åˆ™æ®†ã€‚", "ä¹¦åˆ°ç”¨æ—¶æ–¹æ¨å°‘ï¼Œäº‹éç»è¿‡ä¸çŸ¥éš¾ã€‚", "è«ç­‰é—²ï¼Œç™½äº†å°‘å¹´å¤´ï¼Œç©ºæ‚²åˆ‡ã€‚", "å¿—å½“å­˜é«˜è¿œã€‚"
    ];

    // DOM å…ƒç´ ç¼“å­˜
    let pageBody, mainContainer, mainTitleElement,
        tableBody, tableViewContainer, subjectPieChartContainer, tableViewButton, pieChartViewButton, subjectPieChartCanvas, totalProgress,
        toggleViewButton, openAddModuleModalButton, exportDataButton, importDataButton, fileImporter, ioStatusMessage,
        chineseModeButton, englishModeButton, mathModeButton, physicsModeButton, biologyModeButton, chemistryModeButton, todayTaskButton,
        addModuleModal, closeAddModuleModalButton, cancelAddModuleButton, confirmAddModuleButton, modalNewModuleNameInput, modalNewModuleTotalInput, modalAddModuleStatusMessage,
        editProgressModal, modalTitle, modalBodyEl, closeEditProgressModalButton, cancelEditProgressButton, saveEditProgressButton, deleteModuleButton,
        planToDoModal, planModalTitle, planModalBodyEl, closePlanToDoModalButton, cancelPlanToDoButton, confirmPlanToDoButton,
        pageBgColorSelector, contentBgColorSelector,
        statisticsView, statisticsViewTitle, backToMainViewButton, goToTaskFromStatsButton, // Added new button ref
        statsTotalModules, statsTotalCourses, statsCompletedCoursesDisplay, statsPendingCoursesDisplay, overallPieChartCanvas, overallStatsContentContainer,
        todayTaskView, todayTaskContent, backToSubjectViewButton, goToStatsFromTaskButton, // Added new button ref
        todayToDoListTitle, todayToDoListDisplayContainer, todayToDoListDisplay,
        todayCompletedHistoryTitle, todayCompletedHistoryContainer, todayCompletedHistoryDisplay,
        dailyCompletionChartCanvas,
        todayTaskPageBgColorSelector, todayTaskContentBgColorSelector,
        // é¼“åŠ±æ¨¡å¼DOM
        animationEffectSelector, animationSpeedSelector, encouragementToast, moduleCompletionCelebration,
        // Global Backup DOM
        backupAllButton, backupImporter,
        // ç»Ÿè®¡èŒƒå›´ç­›é€‰ DOM
        statsRangeBtns, statsStartDateInput, statsEndDateInput, statsCustomRangeBtn,
        // åˆ é™¤å¾…åŠæ¨¡æ€æ¡† DOM
        deleteTodoModal, cancelDeleteTodoButton, confirmDeleteTodoButton;


    // --- è¾…åŠ©å‡½æ•° ---
    function getTodayDateString() { const now = new Date(); return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`; }
    
    function getDateStringFromTimestamp(timestamp) {
        if (!timestamp) return null;
        const d = new Date(timestamp);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    }

    // ID ç”Ÿæˆå™¨
    function generateUniqueId() { 
        if (typeof crypto !== 'undefined' && crypto.randomUUID) {
            return crypto.randomUUID();
        }
        return Date.now().toString(36) + Math.random().toString(36).substring(2); 
    }
    
    function parseNumbersString(str) { if (!str || str.trim() === 'â€”' || str.trim() === '') return new Set(); const numbers = new Set(); const parts = str.split(','); parts.forEach(part => { part = part.trim(); if (part.includes('â€“') || part.includes('-')) { const range = part.split(/[-â€“]/); const start = parseInt(range[0]); const end = parseInt(range[1]); if (!isNaN(start) && !isNaN(end) && start <= end) { for (let i = start; i <= end; i++) numbers.add(i); } } else { const num = parseInt(part); if (!isNaN(num)) numbers.add(num); } }); return numbers; }
    function formatNumberSet(numberSet) { if (numberSet.size === 0) return 'â€”'; const sortedNumbers = Array.from(numberSet).sort((a, b) => a - b); const ranges = []; let i = 0; while (i < sortedNumbers.length) { let start = sortedNumbers[i]; let end = start; while (i + 1 < sortedNumbers.length && sortedNumbers[i+1] === end + 1) { end = sortedNumbers[i+1]; i++; } ranges.push(start === end ? String(start) : `${start}â€“${end}`); i++; } return ranges.join(', '); }
    function showStatusMessage(message, isError = false, element = ioStatusMessage) { element.textContent = message; element.className = `text-sm h-5 ${isError ? 'text-red-600' : 'text-green-600'} ${element === modalAddModuleStatusMessage ? 'text-left mt-2' : 'text-right mt-3'}`; setTimeout(() => { element.textContent = ''; }, 3000); }

    // --- æ•°æ®å­˜å‚¨å‡½æ•° ---
    function saveAllDataToStorage() {
        try {
            const dataToSave = {};
            for (const subject in allData) {
                dataToSave[subject] = {
                    ...allData[subject],
                    modules: allData[subject].modules.map(module => ({
                        ...module,
                        completedTasks: Array.from(module.completedTasks) // å°†Setè½¬æ¢ä¸ºArrayä»¥ä¾¿å­˜å‚¨
                    }))
                };
            }
            localStorage.setItem('allProgressData', JSON.stringify(dataToSave));
        } catch (e) {
            console.error("ä¿å­˜è¿›åº¦æ•°æ®å¤±è´¥:", e);
        }
    }

    // --- åˆå§‹åŒ– ---
    function initializeSubjectData(subjectKey) {
        const subjectData = allData[subjectKey];
        if (subjectData && subjectData.initialRawData) {
            subjectData.modules = subjectData.initialRawData.map((item, index) => ({
                internalId: generateUniqueId(),
                originalId: item.id,
                name: item.name,
                total: item.total,
                completedTasks: parseNumbersString(item.completedRaw),
                link: '' // åˆå§‹åŒ–é“¾æ¥å­—æ®µ
            }));
        } else {
            console.warn(`è­¦å‘Š: æœªæ‰¾åˆ°ç§‘ç›® "${subjectKey}" çš„åˆå§‹åŸå§‹æ•°æ®ã€‚`);
            subjectData.modules = [];
        }
    }

    // å†å²è®°å½•æ¸…ç†é€»è¾‘ - ä¿ç•™æœ€è¿‘365å¤© (ä¸ºäº†é…åˆä¸€å¹´ç»Ÿè®¡ï¼Œå»¶é•¿ä¿å­˜æ—¶é—´)
    function cleanupOldHistory() {
        const now = new Date();
        const oneYearAgo = now.getTime() - (365 * 24 * 60 * 60 * 1000); 
        
        const initialCount = todayCompletedHistoryList.length;
        todayCompletedHistoryList = todayCompletedHistoryList.filter(item => {
            if (!item.completedTimestamp) return false;
            return item.completedTimestamp >= oneYearAgo;
        });
        
        if (initialCount > todayCompletedHistoryList.length) {
            console.log(`[ç³»ç»Ÿç»´æŠ¤] è‡ªåŠ¨æ¸…ç†äº† ${initialCount - todayCompletedHistoryList.length} æ¡è¶…è¿‡1å¹´çš„è¿‡æœŸè¯¦ç»†å†å²è®°å½•ã€‚`);
            saveTodayCompletedHistoryToStorage();
        }
    }

    function initializeAllData() {
        const savedData = localStorage.getItem('allProgressData');
        if (savedData) {
            try {
                const parsedData = JSON.parse(savedData);
                for (const subject in parsedData) {
                    if (allData[subject]) {
                        allData[subject] = {
                            ...allData[subject],
                            ...parsedData[subject],
                            modules: parsedData[subject].modules.map(module => ({
                                ...module,
                                internalId: (module.internalId === undefined || typeof module.internalId === 'number') ? generateUniqueId() : module.internalId,
                                completedTasks: new Set(module.completedTasks),
                                link: module.link || '' 
                            }))
                        };
                    }
                }
            } catch (e) {
                console.error("è§£æå·²å­˜æ•°æ®å¤±è´¥ï¼Œå°†åŠ è½½åˆå§‹æ•°æ®ã€‚", e);
                Object.keys(allData).forEach(key => initializeSubjectData(key));
            }
        } else {
            Object.keys(allData).forEach(key => initializeSubjectData(key));
        }
    }

    function loadAndRefreshAllData() {
        const storedToDoList = localStorage.getItem('todayToDoList');
        if (storedToDoList) { try { todayToDoList = JSON.parse(storedToDoList); if (!Array.isArray(todayToDoList)) todayToDoList = []; } catch (e) { todayToDoList = []; console.error("è§£æ todayToDoList æ—¶å‡ºé”™", e); } } else { todayToDoList = []; }
        const storedCompletedHistory = localStorage.getItem('todayCompletedHistoryList');
        if (storedCompletedHistory) { try { todayCompletedHistoryList = JSON.parse(storedCompletedHistory); if (!Array.isArray(todayCompletedHistoryList)) todayCompletedHistoryList = []; } catch (e) { todayCompletedHistoryList = []; console.error("è§£æ todayCompletedHistoryList æ—¶å‡ºé”™", e); } } else { todayCompletedHistoryList = []; }
        const storedDailyStats = localStorage.getItem('dailyCompletionStats');
        if (storedDailyStats) { try { dailyCompletionStats = JSON.parse(storedDailyStats); if (!Array.isArray(dailyCompletionStats)) dailyCompletionStats = []; dailyCompletionStats.sort((a, b) => new Date(a.date) - new Date(b.date)); } catch (e) { dailyCompletionStats = []; console.error("è§£æ dailyCompletionStats æ—¶å‡ºé”™", e); } } else { dailyCompletionStats = []; }
        
        cleanupOldHistory(); 
    }

    function saveTodayToDoListToStorage() { localStorage.setItem('todayToDoList', JSON.stringify(todayToDoList)); }
    function saveTodayCompletedHistoryToStorage() { localStorage.setItem('todayCompletedHistoryList', JSON.stringify(todayCompletedHistoryList));}
    function saveDailyCompletionStatsToStorage() { localStorage.setItem('dailyCompletionStats', JSON.stringify(dailyCompletionStats)); }

    // --- è¡Œå†…ç¼–è¾‘ (ç”¨äºè¡¨æ ¼å•å…ƒæ ¼) ---
    function makeCellEditable(cell, module, propertyToEdit, inputType = 'text', validationFn = null, placeholderText = '') { 
        const originalValue = module[propertyToEdit]; 
        const originalText = cell.textContent; 
        cell.innerHTML = ''; 
        const input = document.createElement('input'); 
        input.type = inputType; 
        input.className = 'inline-edit-input'; 
        input.value = originalValue; 
        if (placeholderText) input.placeholder = placeholderText; 
        if (inputType === 'number' && propertyToEdit === 'total') { 
            const maxCompleted = module.completedTasks.size > 0 ? Math.max(...module.completedTasks) : 0; 
            input.min = Math.max(0, maxCompleted); 
        } 
        cell.appendChild(input); 
        input.focus(); 
        input.select(); 
        
        let saved = false; 
        const saveValue = () => { 
            if (saved) return; 
            saved = true; 
            let newValue = input.value; 
            
            if (validationFn && !validationFn(newValue, module)) { 
                if (propertyToEdit === 'name') { 
                    cell.textContent = originalText; 
                    const tempErrorSpan = document.createElement('span'); 
                    tempErrorSpan.textContent = ' (åç§°æ— æ•ˆ)'; 
                    tempErrorSpan.className = 'text-red-500 text-xs italic ml-1'; 
                    cell.appendChild(tempErrorSpan); 
                    setTimeout(() => { if(cell.contains(tempErrorSpan)) cell.removeChild(tempErrorSpan); renderAppView(); }, 2000); 
                } 
                return; 
            } 
            
            if (inputType === 'number') newValue = parseInt(newValue); 
            
            if (propertyToEdit === 'total') { 
                if (newValue < originalValue) { 
                    let tasksLost = 0;
                    module.completedTasks.forEach(t => {
                        if (t > newValue) tasksLost++;
                    });

                    if (tasksLost > 0) {
                        const confirmDelete = confirm(`âš ï¸ å±é™©è­¦å‘Šï¼\n\nä½ å°†è¯¾ç¨‹æ€»æ•°ä» ${originalValue} å‡å°‘åˆ°äº† ${newValue}ã€‚\nè¿™æ„å‘³ç€ç¬¬ ${newValue + 1} è¯¾ä¹‹åçš„ ã€${tasksLost} æ¡ã€‘å®Œæˆè®°å½•å°†è¢«æ°¸ä¹…åˆ é™¤ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`);
                        
                        if (!confirmDelete) {
                            cell.textContent = originalText; // æ¢å¤æ˜¾ç¤º
                            return; // ç»ˆæ­¢æ“ä½œ
                        }

                        // --- å…³é”®ä¿®å¤ï¼šå‡å°‘è¯¾ç¨‹æ€»æ•°æ—¶ï¼ŒåŒæ­¥æ‰£å‡æ¯æ—¥ç»Ÿè®¡æ•°æ® ---
                        const tasksToRemove = [];
                        module.completedTasks.forEach(t => { if (t > newValue) tasksToRemove.push(t); });

                        tasksToRemove.forEach(taskNum => {
                             // åœ¨å†å²è®°å½•ä¸­æŸ¥æ‰¾
                             const historyIndex = todayCompletedHistoryList.findIndex(item => 
                                 item.moduleInternalId === module.internalId && 
                                 item.taskNumber === taskNum
                             );
                             
                             if (historyIndex !== -1) {
                                  const removed = todayCompletedHistoryList.splice(historyIndex, 1)[0];
                                  if (removed.completedTimestamp) {
                                       updateDailyCompletionCount(getDateStringFromTimestamp(removed.completedTimestamp), -1);
                                  }
                             }
                        });
                        saveTodayCompletedHistoryToStorage();
                        saveDailyCompletionStatsToStorage();
                        // --- ä¿®å¤ç»“æŸ ---
                    }
                    
                    const tasksRemovedFromToDo = todayToDoList.filter(item => 
                        item.subject === currentSubject && 
                        item.moduleInternalId === module.internalId && 
                        item.taskNumber > newValue
                    ).length;

                    if (tasksRemovedFromToDo > 0) {
                        todayToDoList = todayToDoList.filter(item => 
                            !(item.subject === currentSubject && 
                              item.moduleInternalId === module.internalId && 
                              item.taskNumber > newValue)
                        );
                        saveTodayToDoListToStorage(); 
                        showStatusMessage(`åŒæ—¶ä¹Ÿæ¸…ç†äº† ${tasksRemovedFromToDo} ä¸ªè¶…å‡ºèŒƒå›´çš„å¾…åŠä»»åŠ¡`, false);
                    }
                    
                    const newCompleted = new Set(); 
                    module.completedTasks.forEach(taskNum => { if (taskNum <= newValue) newCompleted.add(taskNum); }); 
                    module.completedTasks = newCompleted; 

                } else if (newValue === 0) { 
                    if (module.completedTasks.size > 0 && !confirm("ç¡®å®šè¦å°†è¯¾ç¨‹æ€»æ•°è®¾ä¸º 0 å—ï¼Ÿè¿™å°†æ¸…ç©ºè¯¥æ¨¡å—æ‰€æœ‰è¿›åº¦ï¼")) {
                        cell.textContent = originalText;
                        return;
                    }
                    // æ¸…ç©ºæ—¶ä¹Ÿè¦æ›´æ–°ç»Ÿè®¡
                    module.completedTasks.forEach(taskNum => {
                        const historyIndex = todayCompletedHistoryList.findIndex(item => item.moduleInternalId === module.internalId && item.taskNumber === taskNum);
                        if (historyIndex !== -1) {
                             const removed = todayCompletedHistoryList.splice(historyIndex, 1)[0];
                             if (removed.completedTimestamp) {
                                  updateDailyCompletionCount(getDateStringFromTimestamp(removed.completedTimestamp), -1);
                             }
                        }
                    });
                    
                    module.completedTasks.clear(); 
                     todayToDoList = todayToDoList.filter(item => 
                        !(item.subject === currentSubject && 
                          item.moduleInternalId === module.internalId)
                    );
                    saveTodayToDoListToStorage();
                    saveTodayCompletedHistoryToStorage();
                    saveDailyCompletionStatsToStorage();
                } 
            }
            
            module[propertyToEdit] = newValue; 
            saveAllDataToStorage(); 
            renderAppView(); 
        }; 
        
        input.addEventListener('blur', saveValue); 
        input.addEventListener('keydown', (event) => { 
            if (event.key === 'Enter') { event.preventDefault(); saveValue(); } 
            else if (event.key === 'Escape') { if (saved) return; saved = true; renderAppView(); } 
        }); 
    }
    
    function makeLinkEditable(cell, module) {
        if(cell.querySelector('input')) return;
        const originalContent = cell.innerHTML;
        cell.innerHTML = '';
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'inline-edit-input';
        input.value = module.link || '';
        input.placeholder = 'ç²˜è´´ç½‘è¯¾é“¾æ¥ (http://...)';
        cell.appendChild(input);
        input.focus();
        let saved = false;
        const save = () => {
            if (saved) return;
            saved = true;
            const val = input.value.trim();
            module.link = val;
            saveAllDataToStorage();
            renderAppView();
        };
        input.addEventListener('blur', save);
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { e.preventDefault(); save(); }
            if (e.key === 'Escape') { saved = true; cell.innerHTML = originalContent; renderAppView(); }
        });
    }

    function validateModuleName(name, elementForStatus = modalAddModuleStatusMessage) { if (!name || name.trim() === "") { showStatusMessage("æ¨¡å—åç§°ä¸èƒ½ä¸ºç©ºï¼", true, elementForStatus); return false; } return true; }
    function validateInlineModuleName(name, cellToUpdate) { if (!name || name.trim() === "") { const tempMsg = document.createElement('span'); tempMsg.textContent = 'åç§°ä¸èƒ½ä¸ºç©º!'; tempMsg.className = 'text-red-500 text-xs italic whitespace-normal block'; const currentInput = cellToUpdate.querySelector('input'); if (currentInput && currentInput.parentNode) currentInput.parentNode.insertBefore(tempMsg, currentInput.nextSibling); setTimeout(() => { if (tempMsg.parentNode) tempMsg.parentNode.removeChild(tempMsg); }, 2500); return false; } return true; }

    // --- å›¾è¡¨æ¸²æŸ“ ---
    function renderPieChart(canvasElement, existingChartInstance, chartData, chartTitle) { if (existingChartInstance) { existingChartInstance.destroy(); } const ctx = canvasElement.getContext('2d'); return new Chart(ctx, { type: 'pie', data: { labels: ['å·²å®Œæˆ', 'å¾…å®Œæˆ'], datasets: [{ label: chartTitle, data: chartData, backgroundColor: ['#10B981', '#F59E0B'], borderColor: ['#ffffff', '#ffffff'], borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { font: { size: 14 } } }, tooltip: { callbacks: { label: function(context) { let label = context.label || ''; if (label) { label += ': '; } if (context.parsed !== null) { label += context.parsed + ' (' + ((context.parsed / (context.dataset.data.reduce((a, b) => a + b, 0))) * 100).toFixed(1) + '%)'; } return label; } } } } } }); }
    
    // --- ä¿®æ”¹åçš„æ¸²æŸ“å‡½æ•°ï¼šæ”¯æŒæ•°æ®è¿‡æ»¤ ---
    function renderDailyCompletionChart(dataToRender = null) { 
        if (dailyCompletionChartInstance) { dailyCompletionChartInstance.destroy(); } 
        
        // å¦‚æœæœªä¼ å…¥ç‰¹å®šæ•°æ®ï¼Œé»˜è®¤ä½¿ç”¨å…¨éƒ¨æ•°æ®
        const sourceData = dataToRender || dailyCompletionStats;
        
        const statsToDisplay = [...sourceData].sort((a, b) => new Date(a.date) - new Date(b.date)); 
        const labels = statsToDisplay.map(stat => stat.date); 
        const dataCounts = statsToDisplay.map(stat => stat.count); 
        
        if (!dailyCompletionChartCanvas) { console.error("dailyCompletionChartCanvas æœªæ‰¾åˆ°ã€‚"); return; } 
        const ctx = dailyCompletionChartCanvas.getContext('2d'); 
        
        dailyCompletionChartInstance = new Chart(ctx, { 
            type: 'line', 
            data: { 
                labels: labels, 
                datasets: [{ 
                    label: 'æ¯æ—¥å®Œæˆä»»åŠ¡æ•°', 
                    data: dataCounts, 
                    fill: true, 
                    backgroundColor: 'rgba(59, 130, 246, 0.15)', 
                    borderColor: 'rgba(59, 130, 246, 0.8)', 
                    borderWidth: 2, 
                    tension: 0.35, 
                    pointBackgroundColor: 'rgba(59, 130, 246, 1)', 
                    pointBorderColor: '#fff', 
                    pointHoverBackgroundColor: '#fff', 
                    pointHoverBorderColor: 'rgba(59, 130, 246, 1)', 
                    pointRadius: 4, 
                    pointHoverRadius: 7, 
                    pointBorderWidth: 2, 
                    pointHoverBorderWidth: 2 
                }] 
            }, 
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { 
                    x: { 
                        type: 'time', 
                        time: { 
                            unit: 'day', 
                            tooltipFormat: 'yyyy-MM-dd', 
                            displayFormats: { day: 'MM-dd' } 
                        }, 
                        title: { display: true, text: 'æ—¥æœŸ', font: { size: 14, weight: '500' }, color: '#4b5563' }, 
                        grid: { display: false }, 
                        ticks: { color: '#6b7280', font: { size: 12 }, maxRotation: 0, autoSkipPadding: 20 } 
                    }, 
                    y: { 
                        beginAtZero: true, 
                        title: { display: true, text: 'å®Œæˆæ•°é‡', font: { size: 14, weight: '500' }, color: '#4b5563' }, 
                        grid: { color: '#e5e7eb', borderDash: [3, 5] }, 
                        ticks: { stepSize: 1, color: '#6b7280', font: { size: 12 }, precision: 0 } 
                    } 
                }, 
                plugins: { 
                    legend: { display: true, position: 'top', align: 'end', labels: { font: { size: 13 }, color: '#374151', usePointStyle: true, pointStyle: 'rectRounded', padding: 20 }}, 
                    tooltip: { mode: 'index', intersect: false, backgroundColor: 'rgba(0,0,0,0.8)', titleFont: { size: 14, weight: 'bold' }, bodyFont: { size: 12 }, padding: 12, cornerRadius: 6, displayColors: false, callbacks: { title: (tooltipItems) => `æ—¥æœŸ: ${tooltipItems[0].label}`, label: (context) => `${context.dataset.label}: ${context.parsed.y}` } }, 
                    zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, drag: { enabled: true, backgroundColor: 'rgba(0, 123, 255, 0.25)' }, mode: 'x' } } 
                } 
            } 
        }); 
    }

    // --- ä¸»å†…å®¹æ¸²æŸ“ (ç§‘ç›®è¡¨æ ¼/é¥¼å›¾) ---
    function renderSubjectContentView() { tableViewContainer.classList.add('hidden'); subjectPieChartContainer.classList.add('hidden'); [tableViewButton, pieChartViewButton].forEach(btn => { if (btn) { btn.classList.add('view-mode-button-inactive'); btn.classList.remove('view-mode-button-active'); } }); if (currentMainDisplayMode === 'table') { tableViewContainer.classList.remove('hidden'); tableViewButton.classList.add('view-mode-button-active'); tableViewButton.classList.remove('view-mode-button-inactive'); renderTable(); } else if (currentMainDisplayMode === 'pie') { subjectPieChartContainer.classList.remove('hidden'); pieChartViewButton.classList.add('view-mode-button-active'); pieChartViewButton.classList.remove('view-mode-button-inactive'); renderCurrentSubjectPieChart(); } }
    
    function renderCurrentSubjectPieChart() { 
        const currentModules = allData[currentSubject].modules; 
        let totalCompletedCount = 0; 
        let grandTotalTasks = 0; 
        currentModules.forEach(module => { 
            totalCompletedCount += module.completedTasks.size; 
            grandTotalTasks += module.total; 
        }); 
        
        updateTotalProgress(totalCompletedCount, grandTotalTasks);
        
        const pendingTasks = grandTotalTasks - totalCompletedCount; 
        subjectPieChartInstance = renderPieChart(subjectPieChartCanvas, subjectPieChartInstance, [totalCompletedCount, pendingTasks], allData[currentSubject].title.replace('è¿›åº¦è¡¨','') + ' å®Œæˆæƒ…å†µ'); 
    }

    function renderTable() { 
        tableBody.innerHTML = ''; 
        let totalCompletedCount = 0; 
        let grandTotalTasks = 0; 
        const currentModules = allData[currentSubject].modules; 
        
        currentModules.forEach((module, index) => { 
            module.originalId = index + 1; 
        }); 
        
        currentModules.forEach(module => { 
            const row = tableBody.insertRow(); 
            row.className = "hover:bg-gray-50 transition-colors duration-150"; 
            row.dataset.internalId = module.internalId; 
            
            const tdId = row.insertCell(); 
            tdId.textContent = module.originalId;
            tdId.addEventListener('dblclick', function() {
                if (this.querySelector('input')) return;
                const currentOriginalId = module.originalId;
                const maxId = currentModules.length;
                this.innerHTML = '';
                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-center border border-blue-500 rounded overflow-hidden bg-white shadow-sm';
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'w-12 text-center outline-none text-sm no-spinner py-1 text-gray-700';
                input.value = currentOriginalId;
                input.min = 1;
                input.max = maxId;
                const spinnerContainer = document.createElement('div');
                spinnerContainer.className = 'flex flex-col border-l border-gray-200';
                const createBtn = (text, delta) => {
                    const btn = document.createElement('button');
                    btn.className = 'px-1.5 hover:bg-gray-100 active:bg-gray-200 leading-none text-[9px] h-3.5 flex items-center justify-center text-gray-500 transition-colors';
                    btn.innerHTML = text;
                    btn.tabIndex = -1; 
                    btn.addEventListener('mousedown', (e) => e.preventDefault());
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        let val = parseInt(input.value) || currentOriginalId;
                        val += delta; 
                        if (val < 1) val = 1;
                        if (val > maxId) val = maxId;
                        input.value = val;
                        input.focus();
                    });
                    return btn;
                };
                const upBtn = createBtn('â–²', -1); 
                const downBtn = createBtn('â–¼', 1);
                spinnerContainer.appendChild(upBtn);
                spinnerContainer.appendChild(downBtn);
                wrapper.appendChild(input);
                wrapper.appendChild(spinnerContainer);
                this.appendChild(wrapper);
                input.focus();
                input.select();
                let saved = false;
                const saveOrder = () => {
                    if (saved) return;
                    saved = true;
                    let newOrderVal = parseInt(input.value);
                    if (isNaN(newOrderVal) || newOrderVal < 1 || newOrderVal > currentModules.length) { renderAppView(); return; }
                    if (newOrderVal === currentOriginalId) { renderAppView(); return; }
                    const modules = allData[currentSubject].modules;
                    const fromIndex = modules.indexOf(module); 
                    const toIndex = newOrderVal - 1;
                    const element = modules[fromIndex];
                    modules.splice(fromIndex, 1); 
                    modules.splice(toIndex, 0, element); 
                    modules.forEach((m, idx) => m.originalId = idx + 1);
                    saveAllDataToStorage();
                    renderAppView();
                    showStatusMessage(`æ¨¡å—å·²ç§»åŠ¨åˆ°ç¬¬ ${newOrderVal} ä½`, false);
                };
                input.addEventListener('blur', saveOrder);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') { e.preventDefault(); saveOrder(); } else if (e.key === 'Escape') { if (saved) return; saved = true; renderAppView(); }
                });
            });

            const tdName = row.insertCell(); 
            tdName.textContent = module.name; 
            let clickTimer = null; 
            if (module.link && module.link.trim() !== '') {
                tdName.classList.add('cursor-pointer', 'hover:text-blue-600', 'transition-colors');
                tdName.title = "å•å‡»è·³è½¬åˆ°ç½‘è¯¾ï¼ŒåŒå‡»ç¼–è¾‘åç§°";
                tdName.addEventListener('click', (e) => {
                    if (tdName.querySelector('input')) return;
                    if (clickTimer) clearTimeout(clickTimer);
                    clickTimer = setTimeout(() => {
                        const url = module.link.startsWith('http') ? module.link : 'http://' + module.link;
                        window.open(url, '_blank');
                        clickTimer = null;
                    }, 200); 
                });
            }
            tdName.addEventListener('dblclick', function(e) { 
                if (clickTimer) { clearTimeout(clickTimer); clickTimer = null; }
                if (this.querySelector('input')) return; 
                makeCellEditable(this, module, 'name', 'text', (newName) => validateInlineModuleName(newName, this)); 
            }); 
            
            const tdTotal = row.insertCell(); tdTotal.textContent = module.total; tdTotal.addEventListener('dblclick', function() { if (this.querySelector('input')) return; makeCellEditable(this, module, 'total', 'number', (newTotalStr, currentModule) => { const newTotal = parseInt(newTotalStr); if (isNaN(newTotal) || newTotal < 0) { showTemporaryMessageInCell(this, 'è¯·è¾“å…¥æœ‰æ•ˆçš„éè´Ÿæ•°å­—ï¼'); return false; } const maxCompleted = currentModule.completedTasks.size > 0 ? Math.max(...currentModule.completedTasks) : 0; if (newTotal === 0 && currentModule.completedTasks.size > 0) { showTemporaryMessageInCell(this, `æ€»æ•°ä¸èƒ½ä¸º0ï¼Œå› ä¸ºå·²æœ‰å·²å®Œæˆè¯¾ç¨‹ï¼`); return false; } if (newTotal > 0 && newTotal < maxCompleted && currentModule.completedTasks.size > 0) { showTemporaryMessageInCell(this, `æ€»æ•° (${newTotal}) ä¸èƒ½å°‘äºæœ€å¤§å·²å®Œæˆ (${maxCompleted})ï¼`); return false; } return true; }); }); function showTemporaryMessageInCell(cell, message) { const tempMsg = document.createElement('span'); tempMsg.textContent = message; tempMsg.className = 'text-red-500 text-xs italic whitespace-normal block absolute -bottom-5 left-0 w-full text-center'; const currentInput = cell.querySelector('input'); cell.style.position = 'relative'; if(currentInput && currentInput.parentNode) { currentInput.parentNode.appendChild(tempMsg); setTimeout(() => { if (tempMsg.parentNode) tempMsg.parentNode.removeChild(tempMsg); cell.style.position = ''; }, 2500); } else { cell.innerHTML = ''; cell.appendChild(tempMsg); setTimeout(() => { renderAppView(); cell.style.position = '';}, 2500); } } const tdCompleted = row.insertCell(); tdCompleted.textContent = formatNumberSet(module.completedTasks); tdCompleted.addEventListener('dblclick', () => openEditProgressModal(module.internalId)); const pendingTasksSet = new Set(); for (let i = 1; i <= module.total; i++) { if (!module.completedTasks.has(i)) pendingTasksSet.add(i); } row.insertCell().textContent = formatNumberSet(pendingTasksSet);
            
            const completionCell = row.insertCell();
            const rateDiv = document.createElement('div');
            rateDiv.className = 'flex-grow'; 
            const completionPercentage = module.total > 0 ? (module.completedTasks.size / module.total) * 100 : 0;
            if (currentProgressViewInTable === 'progressBar') { rateDiv.innerHTML = createTableProgressBarHTML(completionPercentage); } else { rateDiv.textContent = `${completionPercentage.toFixed(1)}%`; rateDiv.className = 'flex-grow text-gray-700'; }
            completionCell.appendChild(rateDiv);
            completionCell.title = "åŒå‡»ç¼–è¾‘ç½‘è¯¾é“¾æ¥";
            completionCell.addEventListener('dblclick', function(e) { makeLinkEditable(this, module); });

            const actionsCell = row.insertCell(); actionsCell.className = 'px-4 py-3 text-sm text-gray-700 text-center whitespace-nowrap table-action-button-spacing'; const progressButton = document.createElement('button'); progressButton.textContent = 'è¿›åº¦'; progressButton.className = 'px-3 py-1 bg-green-500 text-white text-xs sm:text-sm rounded-md hover:bg-green-600 transition duration-150 shadow-sm'; progressButton.onclick = () => advanceProgress(module.internalId); actionsCell.appendChild(progressButton); const editButton = document.createElement('button'); editButton.textContent = 'ç¼–è¾‘'; editButton.className = 'px-3 py-1 bg-indigo-500 text-white text-xs sm:text-sm rounded-md hover:bg-indigo-600 transition duration-150 shadow-sm'; editButton.onclick = () => openEditProgressModal(module.internalId); actionsCell.appendChild(editButton); const planButton = document.createElement('button'); planButton.textContent = 'è§„åˆ’'; planButton.className = 'px-3 py-1 bg-orange-500 text-white text-xs sm:text-sm rounded-md hover:bg-orange-600 transition duration-150 shadow-sm'; planButton.onclick = () => openPlanToDoModal(module.internalId); actionsCell.appendChild(planButton); totalCompletedCount += module.completedTasks.size; grandTotalTasks += module.total; Array.from(row.cells).forEach((cell, index) => { cell.className = 'px-4 py-3 text-sm text-gray-700 whitespace-nowrap'; if (index === 0 || index === 1 || index === 2 || index === 3) cell.classList.add('cursor-pointer', 'hover:bg-gray-100'); if (index === 1) cell.classList.remove('whitespace-nowrap'); if (index === 2 && cell.querySelector('.text-red-500')) { cell.classList.remove('whitespace-nowrap'); } if (index === 5 && currentProgressViewInTable === 'progressBar') { cell.classList.remove('whitespace-nowrap'); } }); actionsCell.className = 'px-4 py-3 text-sm text-gray-700 text-center whitespace-nowrap table-action-button-spacing'; }); updateTotalProgress(totalCompletedCount, grandTotalTasks); }
    function createTableProgressBarHTML(percentage) { const percentageFixed = percentage.toFixed(1); return ` <div class="completion-rate-cell"> <div class="progress-bar-container flex-grow"> <div class="progress-bar-fill" style="width: ${percentage}%;"></div> </div> <span class="progress-bar-text">${percentageFixed}%</span> </div> `; }
    function updateTotalProgress(completed, total) { totalProgress.textContent = `æ€»å®Œæˆè¯¾ç¨‹: ${completed} / ${total} (${(total > 0 ? (completed / total) * 100 : 0).toFixed(1)}%)`; }

    // --- ç¼–è¾‘è¿›åº¦æ¨¡æ€æ¡† ---
    function openEditProgressModal(moduleInternalId) { currentEditingModuleInternalId = moduleInternalId; const module = allData[currentSubject].modules.find(m => m.internalId === moduleInternalId); if (!module) { console.error("æœªæ‰¾åˆ°è¦ç¼–è¾‘çš„æ¨¡å—:", moduleInternalId); return; } modalTitle.textContent = `æ›´æ–°è¿›åº¦: ${module.name} (${allData[currentSubject].title.replace('è¿›åº¦è¡¨','')})`; modalBodyEl.innerHTML = ''; const checkboxContainer = document.createElement('div'); checkboxContainer.className = 'grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-x-3 gap-y-2 sm:gap-x-4 sm:gap-y-3'; if (module.total === 0) { checkboxContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">è¯¥æ¨¡å—æ²¡æœ‰è¯¾ç¨‹ã€‚è¯·å…ˆè®¾ç½®è¯¾ç¨‹æ€»æ•°ã€‚</p>'; } else { for (let i = 1; i <= module.total; i++) { const label = document.createElement('label'); label.className = 'flex items-center space-x-2 p-1.5 rounded-md hover:bg-gray-100 cursor-pointer transition-colors duration-150'; const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.value = i; checkbox.checked = module.completedTasks.has(i); checkbox.className = 'form-checkbox h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500 focus:ring-offset-0'; const text = document.createElement('span'); text.textContent = `è¯¾ç¨‹ ${i}`; text.className = 'text-sm text-gray-700 select-none'; label.appendChild(checkbox); label.appendChild(text); checkboxContainer.appendChild(label); } } modalBodyEl.appendChild(checkboxContainer); editProgressModal.classList.remove('hidden'); document.body.style.overflow = 'hidden'; }
    function closeEditProgressModal() { editProgressModal.classList.add('hidden'); currentEditingModuleInternalId = null; document.body.style.overflow = ''; }
    
    // --- å…³é”®ä¿®å¤ï¼šä¿å­˜æ¨¡å—è¿›åº¦æ—¶åŒæ­¥æ‰£å‡ç»Ÿè®¡æ•°æ® ---
    function saveModuleProgress() { 
        if (currentEditingModuleInternalId === null) return; 
        const module = allData[currentSubject].modules.find(m => m.internalId === currentEditingModuleInternalId); 
        if (!module) return; 
        
        const newCompletedTasks = new Set(); 
        modalBodyEl.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => { newCompletedTasks.add(parseInt(checkbox.value)); }); 
        const oldCompletedTasks = new Set(module.completedTasks); 
        
        module.completedTasks = newCompletedTasks; 
        const today = getTodayDateString(); 

        // å¤„ç†æ–°å¢çš„å®Œæˆä»»åŠ¡
        newCompletedTasks.forEach(taskNumber => { 
            if (!oldCompletedTasks.has(taskNumber)) { 
                const toDoIndex = todayToDoList.findIndex(item => item.subject === currentSubject && item.moduleInternalId === module.internalId && item.taskNumber === taskNumber); 
                if (toDoIndex !== -1) { 
                    const completedItem = todayToDoList.splice(toDoIndex, 1)[0]; 
                    completedItem.completedTimestamp = Date.now(); 
                    todayCompletedHistoryList.push(completedItem); 
                    updateDailyCompletionCount(getDateStringFromTimestamp(completedItem.completedTimestamp), 1); 
                } else { 
                    const completedDate = getTodayDateString(); 
                    const isAlreadyCompletedTodayInHistory = todayCompletedHistoryList.some(histItem => histItem.subject === currentSubject && histItem.moduleInternalId === module.internalId && histItem.taskNumber === taskNumber && histItem.completedTimestamp && getDateStringFromTimestamp(histItem.completedTimestamp) === completedDate); 
                    if (!isAlreadyCompletedTodayInHistory) { 
                        todayCompletedHistoryList.push({ id: generateUniqueId(), subject: currentSubject, subjectTitle: allData[currentSubject].title.replace('è¿›åº¦è¡¨', ''), moduleName: module.name, moduleInternalId: module.internalId, taskNumber: taskNumber, addedDate: completedDate, completedTimestamp: Date.now() }); 
                        updateDailyCompletionCount(completedDate, 1); 
                    } 
                } 
            } 
        }); 

        // å¤„ç†è¢«å–æ¶ˆçš„å®Œæˆä»»åŠ¡ (ä¿®å¤ç»Ÿè®¡ä¸å‡å°‘çš„é—®é¢˜)
        oldCompletedTasks.forEach(taskNumber => { 
            if (!newCompletedTasks.has(taskNumber)) { 
                // æŸ¥æ‰¾è¯¥ä»»åŠ¡å¯¹åº”çš„å†å²è®°å½•
                const historyIndex = todayCompletedHistoryList.findIndex(item => 
                    item.moduleInternalId === module.internalId && 
                    item.taskNumber === taskNumber
                ); 

                if (historyIndex !== -1) { 
                    const revertedItem = todayCompletedHistoryList.splice(historyIndex, 1)[0]; 
                    if (revertedItem.completedTimestamp) { 
                        // å…³é”®ï¼šå‡å°‘å½“å¤©çš„ç»Ÿè®¡è®¡æ•°
                        updateDailyCompletionCount(getDateStringFromTimestamp(revertedItem.completedTimestamp), -1); 
                    } 
                    
                    const isAlreadyInToDo = todayToDoList.some(todo => todo.id === revertedItem.id); 
                    if (!isAlreadyInToDo) { 
                        revertedItem.completedTimestamp = null; 
                        todayToDoList.push(revertedItem); 
                    } 
                } 
            } 
        }); 
        
        saveAllDataToStorage(); 
        saveTodayToDoListToStorage(); 
        saveTodayCompletedHistoryToStorage(); 
        saveDailyCompletionStatsToStorage(); 
        closeEditProgressModal(); 
        renderAppView(); 
    }
    
    // --- å…³é”®ä¿®å¤ï¼šåˆ é™¤æ¨¡å—æ—¶åŒæ­¥æ¸…ç†ç»Ÿè®¡æ•°æ® ---
    function handleDeleteModule() { 
        if (currentEditingModuleInternalId === null) return; 
        
        const moduleIndex = allData[currentSubject].modules.findIndex(m => m.internalId === currentEditingModuleInternalId); 
        if (moduleIndex === -1) return; 
        
        const moduleName = allData[currentSubject].modules[moduleIndex].name; 
        if (confirm(`æ‚¨ç¡®å®šè¦åˆ é™¤æ¨¡å— "${moduleName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚\n\næ³¨æ„ï¼šè¯¥æ¨¡å—è´¡çŒ®çš„æ‰€æœ‰â€œæ¯æ—¥å®Œæˆä»»åŠ¡ç»Ÿè®¡â€ä¹Ÿå°†è¢«ç§»é™¤ã€‚`)) { 
            allData[currentSubject].modules.splice(moduleIndex, 1); 
            
            todayToDoList = todayToDoList.filter(item => !(item.subject === currentSubject && item.moduleInternalId === currentEditingModuleInternalId)); 
            
            // æ‰¾å‡ºå¹¶å¤„ç†è¯¥æ¨¡å—ç›¸å…³çš„å†å²è®°å½•ï¼Œä»¥æ‰£å‡ç»Ÿè®¡æ•°æ®
            const historyItemsToRemove = todayCompletedHistoryList.filter(item => 
                item.subject === currentSubject && item.moduleInternalId === currentEditingModuleInternalId
            );

            historyItemsToRemove.forEach(item => {
                if (item.completedTimestamp) {
                    updateDailyCompletionCount(getDateStringFromTimestamp(item.completedTimestamp), -1);
                }
            });

            // ä»å†å²åˆ—è¡¨ä¸­å½»åº•ç§»é™¤
            todayCompletedHistoryList = todayCompletedHistoryList.filter(item => 
                !(item.subject === currentSubject && item.moduleInternalId === currentEditingModuleInternalId)
            ); 
            
            saveAllDataToStorage(); 
            saveTodayToDoListToStorage(); 
            saveTodayCompletedHistoryToStorage(); 
            saveDailyCompletionStatsToStorage(); // åˆ«å¿˜äº†ä¿å­˜æ›´æ–°åçš„ç»Ÿè®¡
            closeEditProgressModal(); 
            renderAppView(); 
            showStatusMessage(`æ¨¡å— "${moduleName}" å·²åˆ é™¤ï¼Œç›¸å…³ç»Ÿè®¡å·²æ¸…ç†ã€‚`, false, ioStatusMessage); 
        } 
    }

    // --- â€œè¿›åº¦â€æŒ‰é’®ä¸é¼“åŠ±æ¨¡å¼åŠŸèƒ½ ---
    function advanceProgress(moduleInternalId) { const module = allData[currentSubject].modules.find(m => m.internalId === moduleInternalId); if (!module) { console.error("æœªæ‰¾åˆ°è¦æ¨è¿›è¿›åº¦çš„æ¨¡å—:", moduleInternalId); return; } let nextTask = -1; for (let i = 1; i <= module.total; i++) { if (!module.completedTasks.has(i)) { nextTask = i; break; } } if (nextTask !== -1) { module.completedTasks.add(nextTask); const today = getTodayDateString(); const toDoIndex = todayToDoList.findIndex(item => item.subject === currentSubject && item.moduleInternalId === module.internalId && item.taskNumber === nextTask); if (toDoIndex !== -1) { const completedItem = todayToDoList.splice(toDoIndex, 1)[0]; completedItem.completedTimestamp = Date.now(); todayCompletedHistoryList.push(completedItem); updateDailyCompletionCount(getDateStringFromTimestamp(completedItem.completedTimestamp), 1); } else { const completedDate = getTodayDateString(); const isAlreadyInHistory = todayCompletedHistoryList.some(histItem => histItem.subject === currentSubject && histItem.moduleInternalId === module.internalId && histItem.taskNumber === nextTask && histItem.completedTimestamp && getDateStringFromTimestamp(histItem.completedTimestamp) === completedDate); if (!isAlreadyInHistory) { todayCompletedHistoryList.push({ id: generateUniqueId(), subject: currentSubject, subjectTitle: allData[currentSubject].title.replace('è¿›åº¦è¡¨', ''), moduleName: module.name, moduleInternalId: module.internalId, taskNumber: nextTask, addedDate: completedDate, completedTimestamp: Date.now() }); updateDailyCompletionCount(completedDate, 1); } } saveAllDataToStorage(); saveTodayToDoListToStorage(); saveTodayCompletedHistoryToStorage(); saveDailyCompletionStatsToStorage(); renderAppView(); showEncouragement(module.internalId); const isModuleComplete = module.completedTasks.size === module.total; if (isModuleComplete) { showModuleCompletionCelebration(); } } else { showStatusMessage(`æ¨¡å— "${module.name}" å·²å…¨éƒ¨å®Œæˆ!`, false); } }
    
    function showEncouragement(moduleInternalId) {
        const randomQuote = encouragementQuotes[Math.floor(Math.random() * encouragementQuotes.length)];
        encouragementToast.textContent = randomQuote;
        encouragementToast.classList.add('show');
        if (typeof confetti === 'function') { confetti({ particleCount: 80, spread: 70, origin: { y: 0.6 }, zIndex: 102 }); }
        setTimeout(() => { encouragementToast.classList.remove('show'); }, 2500);
        if (currentAnimationEffect !== 'none') {
            const row = document.querySelector(`#progressTable tbody tr[data-internal-id='${moduleInternalId}']`);
            if (row) {
                const animationClasses = ['animate-pulse', 'animate-flash', 'animate-float', 'animate-sway', 'animate-flip', 'animate-jelly', 'anim-fast', 'anim-medium', 'anim-slow'];
                row.classList.remove(...animationClasses);
                void row.offsetWidth;
                row.classList.add(`animate-${currentAnimationEffect}`, currentAnimationSpeed);
                setTimeout(() => { row.classList.remove(...animationClasses); }, 1500);
            }
        }
    }

    function showModuleCompletionCelebration() {
        moduleCompletionCelebration.classList.add('show');
        if (typeof confetti === 'function') {
            const duration = 3 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 102 };
            function randomInRange(min, max) { return Math.random() * (max - min) + min; }
            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) { return clearInterval(interval); }
                const particleCount = 50 * (timeLeft / duration);
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }
        setTimeout(() => { moduleCompletionCelebration.classList.remove('show'); }, 4000);
    }

    // --- è§„åˆ’ä»Šæ—¥å¾…åŠæ¨¡æ€æ¡† ---
    function openPlanToDoModal(moduleInternalId) { 
        currentPlanningModuleInternalId = moduleInternalId; 
        const module = allData[currentSubject].modules.find(m => m.internalId === moduleInternalId); 
        if (!module) { console.error("æœªæ‰¾åˆ°è¦è§„åˆ’çš„æ¨¡å—:", moduleInternalId); return; } 
        planModalTitle.textContent = `è§„åˆ’ä»Šæ—¥å¾…åŠ: ${module.name} (${allData[currentSubject].title.replace('è¿›åº¦è¡¨','')})`; 
        planModalBodyEl.innerHTML = ''; 
        const checkboxContainer = document.createElement('div'); 
        checkboxContainer.className = 'grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-x-3 gap-y-2 sm:gap-x-4 sm:gap-y-3'; 
        if (module.total === 0) { 
            checkboxContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">è¯¥æ¨¡å—æ²¡æœ‰è¯¾ç¨‹å¯è§„åˆ’ã€‚</p>'; 
        } else { 
            for (let i = 1; i <= module.total; i++) { 
                const label = document.createElement('label'); 
                label.className = 'flex items-center space-x-2 p-1.5 rounded-md hover:bg-gray-100 cursor-pointer transition-colors duration-150'; 
                const checkbox = document.createElement('input'); 
                checkbox.type = 'checkbox'; 
                checkbox.value = i; 
                const isPlannedAndPending = todayToDoList.some(item => item.subject === currentSubject && item.moduleInternalId === module.internalId && item.taskNumber === i); 
                const isCompletedInHistory = todayCompletedHistoryList.some(item => item.subject === currentSubject && item.moduleInternalId === module.internalId && item.taskNumber === i && item.completedTimestamp);
                checkbox.checked = isPlannedAndPending || isCompletedInHistory; 
                if (isCompletedInHistory && !isPlannedAndPending) { checkbox.disabled = true; label.classList.add('opacity-50', 'cursor-not-allowed'); }
                checkbox.className = 'form-checkbox h-5 w-5 text-orange-600 rounded border-gray-300 focus:ring-orange-500 focus:ring-offset-0'; 
                const text = document.createElement('span'); 
                text.textContent = `è¯¾ç¨‹ ${i}`; 
                text.className = 'text-sm text-gray-700 select-none'; 
                label.appendChild(checkbox); 
                label.appendChild(text); 
                checkboxContainer.appendChild(label); 
            } 
        } 
        planModalBodyEl.appendChild(checkboxContainer); 
        planToDoModal.classList.remove('hidden'); 
        document.body.style.overflow = 'hidden'; 
    }
    
    function closePlanToDoModal() { planToDoModal.classList.add('hidden'); currentPlanningModuleInternalId = null; document.body.style.overflow = ''; }
    
    function savePlanToDo() { 
        if (currentPlanningModuleInternalId === null) return; 
        const module = allData[currentSubject].modules.find(m => m.internalId === currentPlanningModuleInternalId); 
        if (!module) return; 
        const today = getTodayDateString(); 
        const plannedTasksInModal = new Set(); 
        planModalBodyEl.querySelectorAll('input[type="checkbox"]:checked:not(:disabled)').forEach(checkbox => { plannedTasksInModal.add(parseInt(checkbox.value)); }); 
        plannedTasksInModal.forEach(taskNumber => { 
            const isAlreadyPending = todayToDoList.some(item => item.subject === currentSubject && item.moduleInternalId === module.internalId && item.taskNumber === taskNumber); 
            if (!isAlreadyPending) { todayToDoList.push({ id: generateUniqueId(), subject: currentSubject, subjectTitle: allData[currentSubject].title.replace('è¿›åº¦è¡¨', ''), moduleName: module.name, moduleInternalId: module.internalId, taskNumber: taskNumber, addedDate: today }); } 
        }); 
        const uncheckedInputs = Array.from(planModalBodyEl.querySelectorAll('input[type="checkbox"]:not(:checked):not(:disabled)'));
        const uncheckedTaskNumbers = new Set(uncheckedInputs.map(input => parseInt(input.value)));
        if (uncheckedTaskNumbers.size > 0) { todayToDoList = todayToDoList.filter(item => { if (item.subject === currentSubject && item.moduleInternalId === module.internalId && uncheckedTaskNumbers.has(item.taskNumber)) { return false; } return true; }); }
        saveTodayToDoListToStorage(); 
        closePlanToDoModal(); 
        showStatusMessage('ä»Šæ—¥è®¡åˆ’å·²æ›´æ–°!', false); 
        if (currentAppView === 'todayTask') { displayTodayToDoListAndHistory(); } 
    }

    // --- å¯¼å…¥/å¯¼å‡º ---
    function exportData() { 
        const dataToExport = allData[currentSubject].modules.map(m => ({ internalId: m.internalId, originalId: m.originalId, name: m.name, total: m.total, completedTasks: Array.from(m.completedTasks).sort((a,b) => a-b), link: m.link })); 
        const jsonData = JSON.stringify(dataToExport, null, 2); 
        const blob = new Blob([jsonData], { type: 'application/json' }); 
        const url = URL.createObjectURL(blob); 
        const a = document.createElement('a'); 
        a.href = url; 
        a.download = allData[currentSubject].fileName; 
        document.body.appendChild(a); 
        a.click(); 
        document.body.removeChild(a); 
        URL.revokeObjectURL(url); 
        showStatusMessage('æ•°æ®å·²æˆåŠŸå¯¼å‡º!', false); 
    }
    
    function triggerImport() { fileImporter.click(); }
    
    function backupAllData() {
        const backup = {
            meta: { type: 'full_backup', date: new Date().toISOString() },
            allProgressData: localStorage.getItem('allProgressData'),
            todayToDoList: localStorage.getItem('todayToDoList'),
            todayCompletedHistoryList: localStorage.getItem('todayCompletedHistoryList'),
            dailyCompletionStats: localStorage.getItem('dailyCompletionStats'),
            preferences: {
                animationEffect: localStorage.getItem('animationEffect'),
                animationSpeed: localStorage.getItem('animationSpeed'),
                tableProgressViewMode: localStorage.getItem('tableProgressViewMode')
            }
        };
        const blob = new Blob([JSON.stringify(backup)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `é«˜è€ƒå¤ä¹ å…¨å¤‡ä»½_${getTodayDateString()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showStatusMessage('âœ… å…¨å±€å¤‡ä»½å·²ä¸‹è½½ï¼Œè¯·å¦¥å–„ä¿å­˜åˆ°ç”µè„‘æˆ–äº‘ç›˜ï¼', false);
    }

    function handleBackupImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (data.meta && data.meta.type === 'full_backup') {
                    if(!confirm(`è­¦å‘Šï¼šè¿™å°†è¦†ç›–å½“å‰çš„ã€æ‰€æœ‰æ•°æ®ã€‘ï¼ˆåŒ…æ‹¬æ‰€æœ‰ç§‘ç›®è¿›åº¦ã€å¾…åŠå’Œç»Ÿè®¡ï¼‰ã€‚\n\nç¡®å®šè¦æ¢å¤åˆ°å¤‡ä»½ç‚¹ (${data.meta.date}) å—ï¼Ÿ`)) return;
                    if(data.allProgressData) localStorage.setItem('allProgressData', data.allProgressData);
                    if(data.todayToDoList) localStorage.setItem('todayToDoList', data.todayToDoList);
                    if(data.todayCompletedHistoryList) localStorage.setItem('todayCompletedHistoryList', data.todayCompletedHistoryList);
                    if(data.dailyCompletionStats) localStorage.setItem('dailyCompletionStats', data.dailyCompletionStats);
                    if (data.preferences) {
                        if(data.preferences.animationEffect) localStorage.setItem('animationEffect', data.preferences.animationEffect);
                        if(data.preferences.tableProgressViewMode) localStorage.setItem('tableProgressViewMode', data.preferences.tableProgressViewMode);
                    }
                    alert('æ•°æ®æ¢å¤æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ã€‚');
                    location.reload();
                } else {
                    alert('é”™è¯¯ï¼šè¿™ä¸æ˜¯æœ‰æ•ˆçš„å…¨å±€å¤‡ä»½æ–‡ä»¶ï¼è¯·ä½¿ç”¨"å…¨å±€å¤‡ä»½"æŒ‰é’®ç”Ÿæˆçš„æ–‡ä»¶ã€‚');
                }
            } catch (err) {
                console.error(err);
                alert('æ–‡ä»¶æŸåæˆ–æ ¼å¼é”™è¯¯ã€‚');
            } finally {
                event.target.value = ''; 
            }
        };
        reader.readAsText(file);
    }

    // --- ç§‘ç›®/è§†å›¾æ¨¡å¼åˆ‡æ¢ ---
    function updateModeButtonsUI() { const allModeButtons = [todayTaskButton, chineseModeButton, englishModeButton, mathModeButton, physicsModeButton, biologyModeButton, chemistryModeButton]; allModeButtons.forEach(button => { button.classList.remove('mode-button-active'); button.classList.add('mode-button-inactive'); }); if (currentAppView === 'subject') { const activeSubjectButton = { Chinese: chineseModeButton, English: englishModeButton, Math: mathModeButton, Physics: physicsModeButton, Biology: biologyModeButton, Chemistry: chemistryModeButton }[currentSubject]; if (activeSubjectButton) { activeSubjectButton.classList.add('mode-button-active'); activeSubjectButton.classList.remove('mode-button-inactive'); } } else if (currentAppView === 'todayTask') { todayTaskButton.classList.add('mode-button-active'); todayTaskButton.classList.remove('mode-button-inactive'); } }
    function switchToSubjectView(subjectName) { currentAppView = 'subject'; if (allData[subjectName]) { currentSubject = subjectName; } else { console.error("é”™è¯¯: æ— æ•ˆçš„ç§‘ç›®åç§° -", subjectName); currentSubject = 'Chinese'; } mainTitleElement.textContent = allData[currentSubject].title; if (!editProgressModal.classList.contains('hidden')) closeEditProgressModal(); if (!addModuleModal.classList.contains('hidden')) closeAddModuleModal(); if(!planToDoModal.classList.contains('hidden')) closePlanToDoModal(); renderAppView(); showStatusMessage(`${allData[currentSubject].title} å·²åŠ è½½`, false); }
    function toggleProgressDisplayMode() { 
        if (currentProgressViewInTable === 'percentage') { 
            currentProgressViewInTable = 'progressBar'; 
            toggleViewButton.textContent = 'åˆ‡æ¢è§†å›¾: è¿›åº¦æ¡'; 
            toggleViewButton.classList.remove('bg-purple-600', 'hover:bg-purple-700'); 
            toggleViewButton.classList.add('bg-teal-600', 'hover:bg-teal-700'); 
        } else { 
            currentProgressViewInTable = 'percentage'; 
            toggleViewButton.textContent = 'åˆ‡æ¢è§†å›¾: æ•°å­—'; 
            toggleViewButton.classList.remove('bg-teal-600', 'hover:bg-teal-700'); 
            toggleViewButton.classList.add('bg-purple-600', 'hover:bg-purple-700'); 
        } 
        localStorage.setItem('tableProgressViewMode', currentProgressViewInTable);

        if (currentAppView === 'subject' && currentMainDisplayMode === 'table') { renderTable(); } else if (currentAppView === 'overallStats') { displayOverallStatistics(); } 
    }
    function setSubjectDisplayMode(mode) { currentMainDisplayMode = mode; if (currentAppView === 'subject') renderSubjectContentView(); }

    // --- æ·»åŠ æ–°æ¨¡å—æ¨¡æ€æ¡† ---
    function openAddModuleForm() { modalNewModuleNameInput.value = ''; modalNewModuleTotalInput.value = ''; modalAddModuleStatusMessage.textContent = ''; addModuleModal.classList.remove('hidden'); document.body.style.overflow = 'hidden'; modalNewModuleNameInput.focus(); }
    function closeAddModuleModal() { addModuleModal.classList.add('hidden'); document.body.style.overflow = ''; }
    function confirmAndAddNewModule() { 
        const name = modalNewModuleNameInput.value.trim(); 
        const totalStr = modalNewModuleTotalInput.value.trim(); 
        if (!validateModuleName(name, modalAddModuleStatusMessage)) { return; } 
        const total = parseInt(totalStr); 
        if (isNaN(total) || total < 0) { showStatusMessage("è¯¾ç¨‹æ€»æ•°å¿…é¡»æ˜¯æœ‰æ•ˆçš„éè´Ÿæ•°å­—ï¼", true, modalAddModuleStatusMessage); return; } 
        const currentModules = allData[currentSubject].modules; 
        const newOriginalId = currentModules.length > 0 ? Math.max(0, ...currentModules.map(m => m.originalId)) + 1 : 1; 
        const newModule = { internalId: generateUniqueId(), originalId: newOriginalId, name: name, total: total, completedTasks: new Set(), link: '' }; 
        currentModules.push(newModule); 
        saveAllDataToStorage(); 
        renderAppView(); 
        showStatusMessage(`æ¨¡å— "${name}" å·²æ·»åŠ !`, false, modalAddModuleStatusMessage); 
        setTimeout(closeAddModuleModal, 1500); 
    }

    // --- èƒŒæ™¯é¢œè‰²æ§åˆ¶ ---
    function populateColorSelectors() { [pageBgColorSelector, contentBgColorSelector, todayTaskPageBgColorSelector, todayTaskContentBgColorSelector].forEach(selector => { if (!selector) return; selector.innerHTML = ''; colorOptions.forEach(color => { const option = document.createElement('option'); option.value = color.value; option.textContent = color.name; selector.appendChild(option); }); }); }
    function applyPageBgColor(colorValue) { const effectiveColor = (colorValue === "transparent" || !colorValue) ? (colorOptions.find(c => c.name === "æ— èƒŒæ™¯").pageDefault || "#f3f4f6") : colorValue; pageBody.style.background = effectiveColor; localStorage.setItem(`pageBgColor_${currentSubject}`, colorValue); }
    function applyContentBgColor(colorValue) { const effectiveColor = (colorValue === "transparent" || !colorValue) ? (colorOptions.find(c => c.name === "æ— èƒŒæ™¯").contentDefault || "#ffffff") : colorValue; mainContainer.style.background = effectiveColor; statisticsView.style.background = effectiveColor; localStorage.setItem(`contentBgColor_${currentSubject}`, colorValue); }
    function loadAndApplySubjectBgColors() { const pageBgKey = `pageBgColor_${currentSubject}`; const contentBgKey = `contentBgColor_${currentSubject}`; const savedPageBg = localStorage.getItem(pageBgKey); const savedContentBg = localStorage.getItem(contentBgKey); const pageValueToApply = (savedPageBg === null || savedPageBg === undefined) ? "transparent" : savedPageBg; if(pageBgColorSelector) pageBgColorSelector.value = pageValueToApply; applyPageBgColor(pageValueToApply); const contentValueToApply = (savedContentBg === null || savedContentBg === undefined) ? "transparent" : savedContentBg; if(contentBgColorSelector) contentBgColorSelector.value = contentValueToApply; applyContentBgColor(contentValueToApply); }
    function applyTodayTaskPageBgColor(colorValue) { const effectiveColor = (colorValue === "transparent" || !colorValue) ? (colorOptions.find(c => c.name === "æ— èƒŒæ™¯").pageDefault || "#f3f4f6") : colorValue; pageBody.style.background = effectiveColor; localStorage.setItem('todayTask_pageBgColor', colorValue); }
    function applyTodayTaskContentBgColor(colorValue) { const effectiveColor = (colorValue === "transparent" || !colorValue) ? (colorOptions.find(c => c.name === "æ— èƒŒæ™¯").contentDefault || "#ffffff") : colorValue; todayTaskView.style.background = effectiveColor; localStorage.setItem('todayTask_contentBgColor', colorValue); }
    function loadAndApplyTodayTaskBgColors() { const savedPageBg = localStorage.getItem('todayTask_pageBgColor'); const savedContentBg = localStorage.getItem('todayTask_contentBgColor'); const pageValueToApply = (savedPageBg === null || savedPageBg === undefined) ? "transparent" : savedPageBg; if(todayTaskPageBgColorSelector) todayTaskPageBgColorSelector.value = pageValueToApply; applyTodayTaskPageBgColor(pageValueToApply); const contentValueToApply = (savedContentBg === null || savedContentBg === undefined) ? "transparent" : savedContentBg; if(todayTaskContentBgColorSelector) todayTaskContentBgColorSelector.value = contentValueToApply; applyTodayTaskContentBgColor(contentValueToApply); }

    // --- æ€»ä½“ç»Ÿè®¡å‡½æ•° ---
    function calculateOverallStatistics() { let totalModules = 0; let totalCourses = 0; let totalCompletedCourses = 0; Object.values(allData).forEach(subjectData => { totalModules += subjectData.modules.length; subjectData.modules.forEach(module => { totalCourses += module.total; totalCourses += module.total; totalCompletedCourses += module.completedTasks.size; }); }); const totalPendingCourses = totalCourses - totalCompletedCourses; const completionRate = totalCourses > 0 ? (totalCompletedCourses / totalCourses) * 100 : 0; const pendingRate = totalCourses > 0 ? (totalPendingCourses / totalCourses) * 100 : 0; return { totalModules, totalCourses, totalCompletedCourses, totalPendingCourses, completionRate, pendingRate }; }
    function createOverallStatsProgressBarHTML(value, total, percentage, barColorClass = 'bg-sky-500', textColorClass = 'text-sky-700') { const showTextInsideBar = percentage > 15; return ` <div class="space-y-1"> <div class="flex justify-between text-sm font-medium ${textColorClass}"> <span>${value} / ${total}</span> <span>${percentage.toFixed(1)}%</span> </div> <div class="w-full stats-progress-bar-bg"> <div class="stats-progress-bar-fill ${barColorClass} text-center text-white text-xs leading-6" style="width: ${percentage}%"> ${showTextInsideBar ? percentage.toFixed(1) + '%' : ''} </div> </div> </div> `; }
    function displayOverallStatistics() { const stats = calculateOverallStatistics(); statsTotalModules.textContent = stats.totalModules; statsTotalCourses.textContent = stats.totalCourses; if (currentProgressViewInTable === 'progressBar') { statsCompletedCoursesDisplay.innerHTML = createOverallStatsProgressBarHTML(stats.totalCompletedCourses, stats.totalCourses, stats.completionRate, 'bg-green-500', 'text-green-700'); statsPendingCoursesDisplay.innerHTML = createOverallStatsProgressBarHTML(stats.totalPendingCourses, stats.totalCourses, stats.pendingRate, 'bg-amber-500', 'text-amber-700'); } else { statsCompletedCoursesDisplay.innerHTML = `<p class="text-3xl font-bold text-green-600">${stats.totalCompletedCourses} (${stats.completionRate.toFixed(1)}%)</p>`; statsPendingCoursesDisplay.innerHTML = `<p class="text-3xl font-bold text-amber-600">${stats.totalPendingCourses} (${stats.pendingRate.toFixed(1)}%)</p>`; } overallPieChartInstance = renderPieChart(overallPieChartCanvas, overallPieChartInstance, [stats.totalCompletedCourses, stats.totalPendingCourses], 'æ€»ä½“å®Œæˆæƒ…å†µ'); }
    function switchToOverallStatsView() { currentAppView = 'overallStats'; renderAppView(); window.scrollTo(0, 0); }
    function switchToTodayTaskView() { currentAppView = 'todayTask'; renderAppView(); window.scrollTo(0,0); }
    function renderAppView() { mainContainer.classList.add('hidden'); statisticsView.classList.add('hidden'); todayTaskView.classList.add('hidden'); updateModeButtonsUI(); if (currentAppView === 'subject') { mainContainer.classList.remove('hidden'); renderSubjectContentView(); loadAndApplySubjectBgColors(); } else if (currentAppView === 'overallStats') { statisticsView.classList.remove('hidden'); statisticsViewTitle.textContent = 'æ€»ä½“å­¦ä¹ ç»Ÿè®¡'; displayOverallStatistics(); loadAndApplySubjectBgColors(); } else if (currentAppView === 'todayTask') { todayTaskView.classList.remove('hidden'); displayTodayToDoListAndHistory(); renderDailyCompletionChart(); loadAndApplyTodayTaskBgColors(); } }
    function updateDailyCompletionCount(dateStr, change) { if (!dateStr) return; let statEntry = dailyCompletionStats.find(s => s.date === dateStr); if (statEntry) { statEntry.count += change; if (statEntry.count < 0) statEntry.count = 0; } else if (change > 0) { dailyCompletionStats.push({ date: dateStr, count: change }); } dailyCompletionStats.sort((a, b) => new Date(a.date) - new Date(b.date)); saveDailyCompletionStatsToStorage(); }
    
    // --- ä»Šæ—¥å¾…åŠä¸å†å²æ˜¾ç¤º ---
    function displayTodayToDoListAndHistory() { 
        todayToDoListDisplay.innerHTML = ''; 
        const today = getTodayDateString(); 
        const pendingItems = todayToDoList.filter(item => !item.completedTimestamp).sort((a,b) => { if (a.addedDate !== b.addedDate) return a.addedDate < b.addedDate ? -1 : 1; if (a.moduleName < b.moduleName) return -1; if (a.moduleName > b.moduleName) return 1; return a.taskNumber - b.taskNumber; }); 
        
        if (pendingItems.length === 0) { 
            todayToDoListDisplay.innerHTML = '<p class="text-gray-500 text-center py-4">å¤ªæ£’äº†ï¼æ‰€æœ‰å¾…åŠä»»åŠ¡éƒ½å·²å®Œæˆã€‚</p>'; 
        } else { 
            const ulPending = document.createElement('ul'); 
            ulPending.className = 'divide-y divide-gray-200'; 
            const overdueCount = pendingItems.filter(i => i.addedDate !== today).length;
            if (overdueCount > 0) { const overdueMsg = document.createElement('div'); overdueMsg.className = 'text-xs text-orange-600 mb-2 px-2'; overdueMsg.textContent = `ğŸ’¡ åŒ…å« ${overdueCount} ä¸ªä¹‹å‰æœªå®Œæˆçš„ä»»åŠ¡`; todayToDoListDisplay.appendChild(overdueMsg); }
            pendingItems.forEach(item => { 
                const li = document.createElement('li'); 
                li.className = 'p-3 hover:bg-gray-50 rounded-md transition-colors duration-150 flex items-center justify-between cursor-pointer'; 
                li.title = "åŒå‡»å¯åˆ é™¤æ­¤ä»»åŠ¡"; // æç¤ºç”¨æˆ·
                
                // --- æ–°å¢ï¼šåŒå‡»åˆ é™¤äº‹ä»¶ç»‘å®š ---
                li.addEventListener('dblclick', function(e) {
                    // é˜²æ­¢ç‚¹å‡»å¤é€‰æ¡†æ—¶è§¦å‘åŒå‡»é€»è¾‘
                    if (e.target.type === 'checkbox') return;
                    openDeleteTodoModal(item.id);
                });
                // --- ç»“æŸæ–°å¢ ---

                const isOverdue = item.addedDate !== today;
                const itemTextDiv = document.createElement('div'); 
                itemTextDiv.className = 'flex-grow select-none'; // å¢åŠ  select-none é¿å…åŒå‡»é€‰ä¸­æ–‡æœ¬
                itemTextDiv.innerHTML = ` <p class="text-sm font-medium ${isOverdue ? 'text-orange-600' : 'text-indigo-600'}"> ${item.subjectTitle} - ${item.moduleName} ${isOverdue ? '<span class="text-xs font-normal text-gray-400 ml-2">(' + item.addedDate + ')</span>' : ''} </p> <p class="text-sm text-gray-700">è¯¾ç¨‹ ${item.taskNumber}</p> `; 
                li.appendChild(itemTextDiv); 
                const checkbox = document.createElement('input'); 
                checkbox.type = 'checkbox'; 
                checkbox.checked = false; 
                checkbox.className = 'form-checkbox h-5 w-5 text-green-600 rounded border-gray-300 focus:ring-green-500 focus:ring-offset-0 todo-item-checkbox flex-shrink-0'; 
                checkbox.dataset.todoId = item.id; 
                checkbox.addEventListener('change', (e) => handleToDoItemCompletion(e.target.dataset.todoId, e.target.checked)); 
                li.appendChild(checkbox); 
                ulPending.appendChild(li); 
            }); 
            todayToDoListDisplay.appendChild(ulPending); 
        } 
        
        todayToDoListTitle.textContent = `å¾…åŠåˆ—è¡¨ (${pendingItems.length} é¡¹)`; 
        todayCompletedHistoryDisplay.innerHTML = ''; 
        const completedTodayItemsForDisplay = todayCompletedHistoryList.filter(item => item.completedTimestamp && getDateStringFromTimestamp(item.completedTimestamp) === today).sort((a,b) => (b.completedTimestamp || 0) - (a.completedTimestamp || 0)); 
        if (completedTodayItemsForDisplay.length === 0) { 
            todayCompletedHistoryDisplay.innerHTML = '<p class="text-gray-500 text-center py-4">ä»Šæ—¥æš‚æ— å·²å®Œæˆå†å²è®°å½•ã€‚</p>'; 
        } else { 
            const ulHistory = document.createElement('ul'); 
            ulHistory.className = 'divide-y divide-slate-200'; 
            completedTodayItemsForDisplay.forEach(item => { 
                const li = document.createElement('li'); 
                li.className = 'p-2.5 hover:bg-slate-100 rounded-md transition-colors duration-150 flex items-center justify-between'; 
                const itemContentDiv = document.createElement('div'); 
                itemContentDiv.className = 'flex items-center flex-grow'; 
                const completionTimeStr = new Date(item.completedTimestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }); 
                itemContentDiv.innerHTML = ` <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500 mr-2 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg> <div class="flex-grow"> <p class="text-sm font-medium text-slate-700 line-through">${item.subjectTitle} - ${item.moduleName}</p> <p class="text-xs text-slate-500 line-through">è¯¾ç¨‹ ${item.taskNumber}</p> </div> `; 
                li.appendChild(itemContentDiv); 
                const rightSideDiv = document.createElement('div'); 
                rightSideDiv.className = 'flex items-center flex-shrink-0'; 
                const timeText = document.createElement('p'); 
                timeText.className = 'text-xs text-slate-500 whitespace-nowrap mr-2'; 
                timeText.textContent = `å®Œæˆäº ${completionTimeStr}`; 
                rightSideDiv.appendChild(timeText); 
                const deleteButton = document.createElement('button'); 
                deleteButton.className = 'delete-history-button'; 
                deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`; 
                deleteButton.setAttribute('aria-label', 'åˆ é™¤æ­¤æ¡å†å²è®°å½•'); 
                deleteButton.dataset.historyItemId = item.id; 
                deleteButton.addEventListener('click', handleDeleteHistoryItem); 
                rightSideDiv.appendChild(deleteButton); 
                li.appendChild(rightSideDiv); 
                ulHistory.appendChild(li); 
            }); 
            todayCompletedHistoryDisplay.appendChild(ulHistory); 
        } 
        todayCompletedHistoryTitle.textContent = `ä»Šæ—¥å·²å®Œæˆå†å² (${completedTodayItemsForDisplay.length} é¡¹)`; 
    }
    
    // --- æ–°å¢ï¼šåˆ é™¤å¾…åŠç›¸å…³å‡½æ•° ---
    function openDeleteTodoModal(todoId) {
        currentTodoIdToDelete = todoId;
        deleteTodoModal.classList.remove('hidden');
    }

    function closeDeleteTodoModal() {
        deleteTodoModal.classList.add('hidden');
        currentTodoIdToDelete = null;
    }

    function confirmDeleteTodo() {
        if (!currentTodoIdToDelete) return;

        const todoIndex = todayToDoList.findIndex(item => item.id === currentTodoIdToDelete);
        if (todoIndex !== -1) {
            todayToDoList.splice(todoIndex, 1);
            saveTodayToDoListToStorage();
            displayTodayToDoListAndHistory(); // åˆ·æ–°åˆ—è¡¨
            showStatusMessage('ä»»åŠ¡å·²å–æ¶ˆè§„åˆ’', false);
        }
        closeDeleteTodoModal();
    }
    // --- ç»“æŸæ–°å¢ ---
    
    function handleDeleteHistoryItem(event) { 
        const historyItemIdToDelete = event.currentTarget.dataset.historyItemId; 
        if (!historyItemIdToDelete) return; 
        const itemIndex = todayCompletedHistoryList.findIndex(item => item.id === historyItemIdToDelete); 
        if (itemIndex === -1) return; 
        const itemToDelete = todayCompletedHistoryList[itemIndex]; 
        if (!confirm(`ç¡®å®šåˆ é™¤ "${itemToDelete.moduleName} - è¯¾ç¨‹ ${itemToDelete.taskNumber}" çš„å†å²è®°å½•å—ï¼Ÿ\n\nè¯¥ä»»åŠ¡å°†æ ‡è®°ä¸ºã€æœªå®Œæˆã€‘ï¼Œå¹¶æ”¾å›å¾…åŠåˆ—è¡¨ã€‚`)) { return; } 
        todayCompletedHistoryList.splice(itemIndex, 1); 
        if (itemToDelete.completedTimestamp) { const completionDate = getDateStringFromTimestamp(itemToDelete.completedTimestamp); updateDailyCompletionCount(completionDate, -1); } 
        const subjectData = allData[itemToDelete.subject];
        if (subjectData) { const module = subjectData.modules.find(m => m.internalId === itemToDelete.moduleInternalId); if (module) { module.completedTasks.delete(itemToDelete.taskNumber); } }
        const isAlreadyInToDo = todayToDoList.some(todo => todo.subject === itemToDelete.subject && todo.moduleInternalId === itemToDelete.moduleInternalId && todo.taskNumber === itemToDelete.taskNumber);
        if (!isAlreadyInToDo) { todayToDoList.push({ id: generateUniqueId(), subject: itemToDelete.subject, subjectTitle: itemToDelete.subjectTitle, moduleName: itemToDelete.moduleName, moduleInternalId: itemToDelete.moduleInternalId, taskNumber: itemToDelete.taskNumber, addedDate: getTodayDateString() }); showStatusMessage('å†å²è®°å½•å·²æ’¤é”€ï¼Œä»»åŠ¡å·²æ”¾å›å¾…åŠåˆ—è¡¨ã€‚', false, ioStatusMessage); }
        saveAllDataToStorage(); saveTodayToDoListToStorage(); saveTodayCompletedHistoryToStorage(); saveDailyCompletionStatsToStorage(); renderAppView(); 
    }
    
    function handleToDoItemCompletion(toDoId, isNowCompleted) { let itemToMove; if (isNowCompleted) { const toDoIndex = todayToDoList.findIndex(item => item.id === toDoId); if (toDoIndex !== -1) { itemToMove = todayToDoList.splice(toDoIndex, 1)[0]; itemToMove.completedTimestamp = Date.now(); todayCompletedHistoryList.push(itemToMove); updateDailyCompletionCount(getDateStringFromTimestamp(itemToMove.completedTimestamp), 1); const correspondingModule = allData[itemToMove.subject]?.modules.find(m => m.internalId === itemToMove.moduleInternalId); if (correspondingModule) { correspondingModule.completedTasks.add(itemToMove.taskNumber); } saveAllDataToStorage(); } } else { const historyIndex = todayCompletedHistoryList.findIndex(item => item.id === toDoId); if (historyIndex !== -1) { itemToMove = todayCompletedHistoryList.splice(historyIndex, 1)[0]; const originalCompletionDate = getDateStringFromTimestamp(itemToMove.completedTimestamp); itemToMove.completedTimestamp = null; if (itemToMove.addedDate === getTodayDateString()) { todayToDoList.push(itemToMove); } updateDailyCompletionCount(originalCompletionDate, -1); const correspondingModule = allData[itemToMove.subject]?.modules.find(m => m.internalId === itemToMove.moduleInternalId); if (correspondingModule) { correspondingModule.completedTasks.delete(itemToMove.taskNumber); } saveAllDataToStorage(); } } saveTodayToDoListToStorage(); saveTodayCompletedHistoryToStorage(); saveDailyCompletionStatsToStorage(); renderAppView(); }

    // --- DOMContentLoaded åˆå§‹åŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        pageBody = document.getElementById('pageBody'); mainContainer = document.getElementById('mainContainer'); mainTitleElement = document.getElementById('mainTitle'); tableBody = document.getElementById('progressTable').getElementsByTagName('tbody')[0]; tableViewContainer = document.getElementById('tableViewContainer'); subjectPieChartContainer = document.getElementById('subjectPieChartContainer'); tableViewButton = document.getElementById('tableViewButton'); pieChartViewButton = document.getElementById('pieChartViewButton'); subjectPieChartCanvas = document.getElementById('subjectPieChart'); totalProgress = document.getElementById('totalProgress'); toggleViewButton = document.getElementById('toggleViewButton'); openAddModuleModalButton = document.getElementById('openAddModuleModalButton'); exportDataButton = document.getElementById('exportDataButton'); importDataButton = document.getElementById('importDataButton'); fileImporter = document.getElementById('fileImporter'); ioStatusMessage = document.getElementById('ioStatusMessage');
        chineseModeButton = document.getElementById('chineseModeButton'); englishModeButton = document.getElementById('englishModeButton'); mathModeButton = document.getElementById('mathModeButton'); physicsModeButton = document.getElementById('physicsModeButton'); biologyModeButton = document.getElementById('biologyModeButton'); chemistryModeButton = document.getElementById('chemistryModeButton'); todayTaskButton = document.getElementById('todayTaskButton');
        addModuleModal = document.getElementById('addModuleModal'); closeAddModuleModalButton = document.getElementById('closeAddModuleModalButton'); cancelAddModuleButton = document.getElementById('cancelAddModuleButton'); confirmAddModuleButton = document.getElementById('confirmAddModuleButton'); modalNewModuleNameInput = document.getElementById('modalNewModuleName'); modalNewModuleTotalInput = document.getElementById('modalNewModuleTotal'); modalAddModuleStatusMessage = document.getElementById('modalAddModuleStatusMessage');
        editProgressModal = document.getElementById('editProgressModal'); modalTitle = document.getElementById('modalTitle'); modalBodyEl = document.getElementById('modalBody'); closeEditProgressModalButton = document.getElementById('closeEditProgressModalButton'); cancelEditProgressButton = document.getElementById('cancelEditProgressButton'); saveEditProgressButton = document.getElementById('saveEditProgressButton'); deleteModuleButton = document.getElementById('deleteModuleButton');
        planToDoModal = document.getElementById('planToDoModal'); planModalTitle = document.getElementById('planModalTitle'); planModalBodyEl = document.getElementById('planModalBody'); closePlanToDoModalButton = document.getElementById('closePlanToDoModalButton'); cancelPlanToDoButton = document.getElementById('cancelPlanToDoButton'); confirmPlanToDoButton = document.getElementById('confirmPlanToDoButton');
        pageBgColorSelector = document.getElementById('pageBgColorSelector'); contentBgColorSelector = document.getElementById('contentBgColorSelector');
        statisticsView = document.getElementById('statisticsView'); statisticsViewTitle = document.getElementById('statisticsViewTitle'); backToMainViewButton = document.getElementById('backToMainViewButton'); statsTotalModules = document.getElementById('statsTotalModules'); statsTotalCourses = document.getElementById('statsTotalCourses'); statsCompletedCoursesDisplay = document.getElementById('statsCompletedCoursesDisplay'); statsPendingCoursesDisplay = document.getElementById('statsPendingCoursesDisplay'); overallPieChartCanvas = document.getElementById('overallPieChart'); overallStatsContentContainer = document.getElementById('overallStatsContentContainer'); document.getElementById('showOverallStatsButton').addEventListener('click', switchToOverallStatsView);
        todayTaskView = document.getElementById('todayTaskView'); todayTaskContent = document.getElementById('todayTaskContent'); backToSubjectViewButton = document.getElementById('backToSubjectViewButton'); todayToDoListTitle = document.getElementById('todayToDoListTitle'); todayToDoListDisplayContainer = document.getElementById('todayToDoListDisplayContainer'); todayToDoListDisplay = document.getElementById('todayToDoListDisplay'); todayCompletedHistoryTitle = document.getElementById('todayCompletedHistoryTitle'); todayCompletedHistoryContainer = document.getElementById('todayCompletedHistoryContainer'); todayCompletedHistoryDisplay = document.getElementById('todayCompletedHistoryDisplay'); dailyCompletionChartCanvas = document.getElementById('dailyCompletionChartCanvas'); todayTaskPageBgColorSelector = document.getElementById('todayTaskPageBgColorSelector'); todayTaskContentBgColorSelector = document.getElementById('todayTaskContentBgColorSelector');
        
        // --- Added: New Navigation Buttons ---
        goToTaskFromStatsButton = document.getElementById('goToTaskFromStatsButton');
        goToStatsFromTaskButton = document.getElementById('goToStatsFromTaskButton');
        if(goToTaskFromStatsButton) goToTaskFromStatsButton.addEventListener('click', switchToTodayTaskView);
        if(goToStatsFromTaskButton) goToStatsFromTaskButton.addEventListener('click', switchToOverallStatsView);
        
        // --- æ–°å¢ï¼šåˆ é™¤å¾…åŠæ¨¡æ€æ¡†äº‹ä»¶ç»‘å®š ---
        deleteTodoModal = document.getElementById('deleteTodoModal');
        cancelDeleteTodoButton = document.getElementById('cancelDeleteTodoButton');
        confirmDeleteTodoButton = document.getElementById('confirmDeleteTodoButton');
        
        cancelDeleteTodoButton.addEventListener('click', closeDeleteTodoModal);
        confirmDeleteTodoButton.addEventListener('click', confirmDeleteTodo);
        // ç‚¹å‡»é®ç½©å±‚å…³é—­
        deleteTodoModal.addEventListener('click', (event) => {
             if (event.target === deleteTodoModal) closeDeleteTodoModal();
        });
        // --- ç»“æŸæ–°å¢ ---

        animationEffectSelector = document.getElementById('animationEffectSelector'); animationSpeedSelector = document.getElementById('animationSpeedSelector'); encouragementToast = document.getElementById('encouragementToast'); moduleCompletionCelebration = document.getElementById('moduleCompletionCelebration');
        const effects = { 'pulse': 'è„‰å†²', 'flash': 'é—ªçƒ', 'float': 'æµ®ç°', 'sway': 'å¾®æ‘†', 'flip': 'ç¿»è½¬', 'jelly': 'æœå†»', 'none': 'æ— åŠ¨æ•ˆ' };
        const speeds = { 'anim-fast': 'å¿«', 'anim-medium': 'ä¸­', 'anim-slow': 'æ…¢' };
        Object.keys(effects).forEach(key => { animationEffectSelector.add(new Option(effects[key], key)); });
        Object.keys(speeds).forEach(key => { animationSpeedSelector.add(new Option(speeds[key], key)); });
        currentAnimationEffect = localStorage.getItem('animationEffect') || 'pulse';
        currentAnimationSpeed = localStorage.getItem('animationSpeed') || 'anim-medium';
        animationEffectSelector.value = currentAnimationEffect;
        animationSpeedSelector.value = currentAnimationSpeed;
        animationEffectSelector.addEventListener('change', (e) => { currentAnimationEffect = e.target.value; localStorage.setItem('animationEffect', currentAnimationEffect); });
        animationSpeedSelector.addEventListener('change', (e) => { currentAnimationSpeed = e.target.value; localStorage.setItem('animationSpeed', currentAnimationSpeed); });

        backupAllButton = document.getElementById('backupAllButton');
        backupImporter = document.getElementById('backupImporter');
        if(backupAllButton) backupAllButton.addEventListener('click', backupAllData);
        if(backupImporter) backupImporter.addEventListener('change', handleBackupImport);
        
        fileImporter.removeEventListener('change', handleFileImport);
        fileImporter.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const data = JSON.parse(evt.target.result);
                    if (data.meta && data.meta.type === 'full_backup') {
                        if(!confirm(`æ£€æµ‹åˆ°è¿™æ˜¯ä¸€ä»½ã€å…¨å±€å¤‡ä»½ã€‘æ–‡ä»¶ã€‚\næ—¥æœŸï¼š${data.meta.date}\n\næ˜¯å¦è¦è¿›è¡Œã€å…¨å±€æ¢å¤ã€‘ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ã€‚`)) {
                            fileImporter.value = null; return;
                        }
                        if(data.allProgressData) localStorage.setItem('allProgressData', data.allProgressData);
                        if(data.todayToDoList) localStorage.setItem('todayToDoList', data.todayToDoList);
                        if(data.todayCompletedHistoryList) localStorage.setItem('todayCompletedHistoryList', data.todayCompletedHistoryList);
                        if(data.dailyCompletionStats) localStorage.setItem('dailyCompletionStats', data.dailyCompletionStats);
                         if (data.preferences) {
                            if(data.preferences.animationEffect) localStorage.setItem('animationEffect', data.preferences.animationEffect);
                            if(data.preferences.tableProgressViewMode) localStorage.setItem('tableProgressViewMode', data.preferences.tableProgressViewMode);
                        }
                        alert('å…¨å±€æ•°æ®æ¢å¤æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ã€‚');
                        location.reload();
                    } else {
                        handleNormalImport(data);
                    }
                } catch (err) {
                    console.error(err);
                    showStatusMessage('æ–‡ä»¶è§£æå¤±è´¥', true);
                } finally {
                    fileImporter.value = null;
                }
            };
            reader.readAsText(file);
        });
        
        // --- æ–°å¢ï¼šç»Ÿè®¡èŒƒå›´ç­›é€‰é€»è¾‘ ---
        statsRangeBtns = document.querySelectorAll('.stats-range-btn');
        statsStartDateInput = document.getElementById('statsStartDate');
        statsEndDateInput = document.getElementById('statsEndDate');
        statsCustomRangeBtn = document.getElementById('statsCustomRangeBtn');

        // ç»‘å®šé¢„è®¾æŒ‰é’®äº‹ä»¶
        statsRangeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
                statsRangeBtns.forEach(b => b.classList.remove('stats-range-btn-active', 'bg-blue-50', 'text-blue-700', 'border-blue-200'));
                statsRangeBtns.forEach(b => b.classList.add('bg-white', 'text-gray-700', 'border-gray-300'));
                
                // æ¿€æ´»å½“å‰æŒ‰é’®
                btn.classList.add('stats-range-btn-active');
                // Tailwindçš„ !important æ ·å¼åœ¨ active ç±»ä¸­å·²å®šä¹‰ï¼Œä½†ä¸ºäº†ä¿é™©èµ·è§ï¼Œåˆ‡æ¢åŸºç¡€ç±»
                btn.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');

                const range = btn.dataset.range;
                let filteredData;

                if (range === 'all') {
                    filteredData = null; // null è¡¨ç¤ºæ˜¾ç¤ºæ‰€æœ‰
                } else {
                    const days = parseInt(range);
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - days);
                    
                    filteredData = dailyCompletionStats.filter(stat => {
                        const statDate = new Date(stat.date);
                        return statDate >= cutoffDate;
                    });
                }
                
                // æ¸…ç©ºè‡ªå®šä¹‰è¾“å…¥æ¡†ä»¥é¿å…æ··æ·†
                statsStartDateInput.value = '';
                statsEndDateInput.value = '';
                
                renderDailyCompletionChart(filteredData);
            });
        });

        // ç»‘å®šè‡ªå®šä¹‰èŒƒå›´åº”ç”¨æŒ‰é’®
        statsCustomRangeBtn.addEventListener('click', () => {
            const startVal = statsStartDateInput.value;
            const endVal = statsEndDateInput.value;

            if (!startVal || !endVal) {
                alert('è¯·åŒæ—¶é€‰æ‹©å¼€å§‹æ—¥æœŸå’Œç»“æŸæ—¥æœŸ');
                return;
            }

            const startDate = new Date(startVal);
            const endDate = new Date(endVal);

            if (startDate > endDate) {
                alert('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
                return;
            }

            // ç§»é™¤é¢„è®¾æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            statsRangeBtns.forEach(b => b.classList.remove('stats-range-btn-active', 'bg-blue-50', 'text-blue-700', 'border-blue-200'));
            statsRangeBtns.forEach(b => b.classList.add('bg-white', 'text-gray-700', 'border-gray-300'));

            const filteredData = dailyCompletionStats.filter(stat => {
                const statDate = new Date(stat.date);
                // æ¯”è¾ƒæ—¥æœŸéƒ¨åˆ† (statDate æ˜¯å½“å¤© 0ç‚¹æˆ–è€…UTC, inputæ˜¯ YYYY-MM-DD)
                // ç®€å•èµ·è§ç›´æ¥æ¯”è¾ƒå­—ç¬¦ä¸²æˆ–è€…æ—¶é—´æˆ³
                return statDate >= startDate && statDate <= endDate;
            });

            renderDailyCompletionChart(filteredData);
        });
        
        // --- æ–°å¢ï¼šæ¸…é™¤æ¯æ—¥ç»Ÿè®¡æ•°æ®æŒ‰é’®é€»è¾‘ ---
        const clearBtn = document.getElementById('clearDailyStatsButton');
        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºã€æ¯æ—¥å®Œæˆä»»åŠ¡æ•°ç»Ÿè®¡ã€‘çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\næ³¨æ„ï¼š\n1. è¿™å°†åˆ é™¤æŠ˜çº¿å›¾çš„æ‰€æœ‰å†å²ç‚¹ã€‚\n2. è¿™ä¸»è¦ç”¨äºæ¸…é™¤æµ‹è¯•æ•°æ®ã€‚\n3. æ­¤æ“ä½œã€ä¸å¯æ’¤é”€ã€‘ã€‚')) {
                    dailyCompletionStats = [];
                    saveDailyCompletionStatsToStorage();
                    renderDailyCompletionChart(); // åˆ·æ–°å›¾è¡¨å®ä¾‹ï¼ˆå³ä½¿å½“å‰ä¸å¯è§ï¼Œä»¥é˜²ä¸‡ä¸€ï¼‰
                    alert('æ¯æ—¥ç»Ÿè®¡æ•°æ®å·²æˆåŠŸæ¸…ç©ºã€‚');
                    // å¦‚æœåœ¨ç»Ÿè®¡è§†å›¾ä¸‹ï¼Œè¿™é‡Œä¸éœ€è¦åšå¤ªå¤šé¢å¤–æ“ä½œï¼Œä½†å¦‚æœç”¨æˆ·å›åˆ°ä»Šæ—¥ä»»åŠ¡è§†å›¾ï¼Œå›¾è¡¨å°†ä¸ºç©º
                }
            });
        }
        // --- ç»“æŸæ–°å¢ ---

        initializeAllData();
        populateColorSelectors();
        loadAndRefreshAllData();

        currentAppView = 'subject';
        currentSubject = 'Chinese';
        switchToSubjectView(currentSubject); 

        if (currentProgressViewInTable === 'percentage') { 
            toggleViewButton.textContent = 'åˆ‡æ¢è§†å›¾: æ•°å­—'; 
            toggleViewButton.classList.remove('bg-teal-600', 'hover:bg-teal-700'); 
            toggleViewButton.classList.add('bg-purple-600', 'hover:bg-purple-700'); 
        }
        else { 
            toggleViewButton.textContent = 'åˆ‡æ¢è§†å›¾: è¿›åº¦æ¡'; 
            toggleViewButton.classList.remove('bg-purple-600', 'hover:bg-purple-700'); 
            toggleViewButton.classList.add('bg-teal-600', 'hover:bg-teal-700'); 
        }

        closeEditProgressModalButton.addEventListener('click', closeEditProgressModal); cancelEditProgressButton.addEventListener('click', closeEditProgressModal);
        saveEditProgressButton.addEventListener('click', saveModuleProgress); deleteModuleButton.addEventListener('click', handleDeleteModule);
        editProgressModal.addEventListener('click', (event) => { if (event.target === editProgressModal) closeEditProgressModal(); });
        openAddModuleModalButton.addEventListener('click', openAddModuleForm); closeAddModuleModalButton.addEventListener('click', closeAddModuleModal);
        cancelAddModuleButton.addEventListener('click', closeAddModuleModal); confirmAddModuleButton.addEventListener('click', confirmAndAddNewModule);
        addModuleModal.addEventListener('click', (event) => { if (event.target === addModuleModal) closeAddModuleModal(); });
        exportDataButton.addEventListener('click', exportData); importDataButton.addEventListener('click', triggerImport);
        todayTaskButton.addEventListener('click', switchToTodayTaskView); 
        chineseModeButton.addEventListener('click', () => switchToSubjectView('Chinese'));
        englishModeButton.addEventListener('click', () => switchToSubjectView('English'));
        mathModeButton.addEventListener('click', () => switchToSubjectView('Math'));
        physicsModeButton.addEventListener('click', () => switchToSubjectView('Physics'));
        biologyModeButton.addEventListener('click', () => switchToSubjectView('Biology'));
        chemistryModeButton.addEventListener('click', () => switchToSubjectView('Chemistry'));
        backToMainViewButton.addEventListener('click', () => switchToSubjectView(currentSubject || 'Chinese'));
        backToSubjectViewButton.addEventListener('click', () => switchToSubjectView(currentSubject || 'Chinese'));
        toggleViewButton.addEventListener('click', toggleProgressDisplayMode);
        if(pageBgColorSelector) pageBgColorSelector.addEventListener('change', (e) => applyPageBgColor(e.target.value));
        if(contentBgColorSelector) contentBgColorSelector.addEventListener('change', (e) => applyContentBgColor(e.target.value));
        if(todayTaskPageBgColorSelector) todayTaskPageBgColorSelector.addEventListener('change', (e) => applyTodayTaskPageBgColor(e.target.value));
        if(todayTaskContentBgColorSelector) todayTaskContentBgColorSelector.addEventListener('change', (e) => applyTodayTaskContentBgColor(e.target.value));
        tableViewButton.addEventListener('click', () => setSubjectDisplayMode('table'));
        pieChartViewButton.addEventListener('click', () => setSubjectDisplayMode('pie'));
        closePlanToDoModalButton.addEventListener('click', closePlanToDoModal);
        cancelPlanToDoButton.addEventListener('click', closePlanToDoModal);
        confirmPlanToDoButton.addEventListener('click', savePlanToDo);
        planToDoModal.addEventListener('click', (event) => { if (event.target === planToDoModal) closePlanToDoModal(); });
    });
    
    function handleNormalImport(importedData) {
        if (!Array.isArray(importedData)) throw new Error("å¯¼å…¥æ–‡ä»¶æ ¼å¼æ— æ•ˆï¼Œæ ¹å¿…é¡»æ˜¯æ•°ç»„ã€‚"); 
        let allModulesValid = true; 
        for (const importedModule of importedData) { 
            if (typeof importedModule.originalId !== 'number' || typeof importedModule.name !== 'string' || typeof importedModule.total !== 'number' || !Array.isArray(importedModule.completedTasks) || importedModule.total < 0 || !importedModule.completedTasks.every(task => typeof task === 'number' && task > 0) || importedModule.completedTasks.some(task => task > importedModule.total)) { 
                allModulesValid = false; 
                let errorMsg = "å¯¼å…¥çš„æ•°æ®åŒ…å«æ— æ•ˆçš„æ¨¡å—æ ¼å¼æˆ–ä¸ä¸€è‡´çš„æ•°æ®ã€‚"; 
                if (importedModule.completedTasks.some(task => task > importedModule.total)) { 
                    errorMsg = `é”™è¯¯: æ¨¡å— "${importedModule.name}", å·²å®Œæˆè¯¾ç¨‹å· (${Math.max(...importedModule.completedTasks.filter(t => t > importedModule.total))}) ä¸èƒ½å¤§äºå…¶è¯¾ç¨‹æ€»æ•° (${importedModule.total})ã€‚`; 
                } else if (!importedModule.completedTasks.every(task => typeof task === 'number' && task > 0) && importedModule.completedTasks.length > 0) { 
                    errorMsg = `é”™è¯¯: æ¨¡å— "${importedModule.name}" çš„å·²å®Œæˆè¯¾ç¨‹å¿…é¡»æ˜¯æœ‰æ•ˆçš„æ­£æ•´æ•°ã€‚`; 
                } 
                showStatusMessage(errorMsg, true); 
                break; 
            } 
        } 
        if (!allModulesValid) { 
            if (!ioStatusMessage.textContent) throw new Error("å¯¼å…¥æ•°æ®éªŒè¯å¤±è´¥ã€‚"); 
            return; 
        } 
        allData[currentSubject].modules = importedData.map((item, index) => ({ 
            internalId: item.internalId || generateUniqueId(), 
            originalId: item.originalId, 
            name: item.name, 
            total: item.total, 
            completedTasks: new Set(item.completedTasks), 
            link: item.link || '' 
        })); 
        saveAllDataToStorage(); 
        renderAppView(); 
        showStatusMessage('æ•°æ®å¯¼å…¥æˆåŠŸ!', false); 
    }
    
    function handleFileImport(event) { 
        const file = event.target.files[0]; 
        if (!file) return; 
        const reader = new FileReader(); 
        reader.onload = function(e) { 
            try { 
                const importedData = JSON.parse(e.target.result); 
                handleNormalImport(importedData);
            } catch (error) { 
                console.error("å¯¼å…¥é”™è¯¯:", error); 
                showStatusMessage(`å¯¼å…¥å¤±è´¥: ${error.message}`, true); 
            } finally { 
                fileImporter.value = null; 
            } 
        }; 
        reader.onerror = function() { showStatusMessage('è¯»å–æ–‡ä»¶å¤±è´¥!', true); fileImporter.value = null; }; 
        reader.readAsText(file); 
    }
</script>
</body>
</html>