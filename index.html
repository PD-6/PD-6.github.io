<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>综合学习体系 - 智能版</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- 引入图标库 -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <style>
    :root {
      /* Default Colors */
      --default-primary-color: #3b82f6; 
      --default-sidebar-bg-color: #1659df; /* Updated Blue */
      --default-sidebar-text-color: #ffffff;
      --default-sidebar-hover-bg-color: #2563eb; 
      --default-active-button-text-color: #ffffff;

      /* Current Colors */
      --primary-color: var(--default-primary-color);
      --sidebar-bg-color: var(--default-sidebar-bg-color);
      --sidebar-text-color: var(--default-sidebar-text-color);
      --sidebar-hover-bg-color: var(--default-sidebar-hover-bg-color);
      --active-button-text-color: var(--default-active-button-text-color);
    }

    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Inter', sans-serif;
      background-color: #f9fafb;
    }
    .iframe-wrapper {
      width: 100%;
      height: 100%;
      overflow: hidden;
      border-radius: 0.5rem; /* rounded-lg */
      background: white;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    /* Sidebar Styles & Transition */
    .sidebar {
        background-color: var(--sidebar-bg-color);
        color: var(--sidebar-text-color);
        height: 100vh;
        display: flex;
        flex-direction: column;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Smoother transition */
        white-space: nowrap; /* Prevent text wrapping when shrinking */
        overflow: hidden;
    }

    /* 侧边栏收起状态 */
    .sidebar.collapsed {
        width: 0 !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
        opacity: 0;
    }

    .sidebar-button {
      transition: all 0.2s ease;
      color: var(--sidebar-text-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .sidebar-button:hover {
      background-color: var(--sidebar-hover-bg-color);
      padding-left: 1.25rem; 
    }
    .active-sidebar-button {
      background-color: rgba(255, 255, 255, 0.2) !important;
      color: #ffffff !important;
      font-weight: 600;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .main-content-area {
        height: 100vh;
        overflow-y: hidden;
        background-color: #f3f4f6;
    }
    
    /* 模态框样式 */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(4px);
        z-index: 50;
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        animation: modalFadeIn 0.2s ease-out;
    }
    @keyframes modalFadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }

    /* 拖拽区域样式 */
    .drop-zone {
        border: 2px dashed #cbd5e1;
        border-radius: 0.75rem;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        background: #f8fafc;
        cursor: pointer;
    }
    .drop-zone.drag-over {
        border-color: var(--primary-color);
        background: #eff6ff;
        transform: scale(1.02);
    }
    
    .color-controls-container {
        margin-top: auto; 
        padding-top: 1rem;
        border-top: 1px solid rgba(255,255,255,0.1);
    }

    /* 顶部菜单切换按钮动画 */
    #menu-toggle-btn {
        transition: transform 0.2s;
    }
    #menu-toggle-btn:active {
        transform: scale(0.95);
    }
  </style>
</head>
<body class="flex h-screen antialiased text-gray-900">

  <!-- 侧边栏 -->
  <aside id="main-sidebar" class="sidebar w-56 md:w-64 p-5 space-y-2 shadow-2xl z-20 flex-shrink-0">
    <div class="mb-8 px-2 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-white/20 flex items-center justify-center">
                <i class="ph-bold ph-stack text-xl"></i>
            </div>
            <h1 class="text-xl font-bold tracking-tight">学习体系</h1>
        </div>
        
        <!-- 【新功能】侧边栏内的收起按钮 -->
        <button onclick="toggleSidebar()" class="p-1.5 rounded-lg hover:bg-white/10 text-white/80 hover:text-white transition-colors" title="收起侧边栏">
            <i class="ph-bold ph-caret-double-left text-xl"></i>
        </button>
    </div>
    
    <!-- 导航按钮 -->
    <button id="btn-ziyou"
            class="sidebar-button w-full text-left px-4 py-3 rounded-xl"
            onclick="switchSystem('ziyou')">
      <img src="dove.png" 
           alt="自由系统图标" 
           class="w-6 h-6 object-contain" 
           style="filter: invert(1); mix-blend-mode: screen;"
           onerror="this.style.display='none'; document.getElementById('ziyou-fallback').style.display='block';">
      <i id="ziyou-fallback" class="ph-bold ph-bird text-lg" style="display:none;"></i>
      <span>自由系统</span>
    </button>
    
    <button id="btn-course-progress"
            class="sidebar-button w-full text-left px-4 py-3 rounded-xl"
            onclick="switchSystem('course-progress')">
      <i class="ph-bold ph-chart-line-up text-lg"></i>
      <span>课程进度</span>
    </button>
    
    <button id="btn-wengu"
            class="sidebar-button w-full text-left px-4 py-3 rounded-xl"
            onclick="switchSystem('wengu')">
      <i class="ph-bold ph-book-open-text text-lg"></i>
      <span>温故系统</span>
    </button>
    
    <button id="btn-zhixin"
            class="sidebar-button w-full text-left px-4 py-3 rounded-xl"
            onclick="switchSystem('zhixin')">
      <i class="ph-bold ph-rocket-launch text-lg"></i>
      <span>知新系统</span>
    </button>
    
    <!-- 底部控制区 -->
    <div class="color-controls-container space-y-4">
        <button onclick="openPathSettings()" class="sidebar-button w-full text-left px-4 py-2 rounded-lg text-sm opacity-80 hover:opacity-100">
            <i class="ph-bold ph-gear"></i>
            <span>文件路径配置</span>
        </button>

        <div class="space-y-3 px-1">
            <div class="flex items-center justify-between text-sm">
                <label>高亮色</label>
                <input type="color" id="highlightColorPicker" class="w-6 h-6 rounded cursor-pointer border-none bg-transparent">
            </div>
            <div class="flex items-center justify-between text-sm">
                <label>背景色</label>
                <input type="color" id="sidebarBgColorPicker" class="w-6 h-6 rounded cursor-pointer border-none bg-transparent">
            </div>
            <button id="restoreDefaultsButton" class="text-xs w-full text-center py-1.5 bg-white/10 hover:bg-white/20 rounded transition-colors">恢复默认颜色</button>
        </div>
    </div>
  </aside>

  <!-- 主内容区 -->
  <main class="main-content-area flex-grow flex flex-col h-full relative">
    
    <!-- 顶部栏 -->
    <header class="bg-white shadow-sm px-6 py-4 flex justify-between items-center z-10 flex-shrink-0 h-16">
      <div class="flex items-center gap-4">
        <!-- 【新功能】主内容区的展开按钮 (菜单按钮) -->
        <button id="menu-toggle-btn" 
                onclick="toggleSidebar()" 
                class="p-2 -ml-2 rounded-lg hover:bg-gray-100 text-gray-600 transition-colors" 
                title="展开/收起侧边栏">
            <i class="ph-bold ph-list text-xl"></i>
        </button>

        <h2 id="content-title" class="text-xl font-bold text-gray-800">课程进度</h2>
        <span id="file-version-tag" class="text-xs px-2 py-0.5 bg-gray-100 text-gray-500 rounded-full font-mono hidden">v?</span>
      </div>
      
      <button id="enter-system-button"
              class="flex items-center gap-2 bg-[var(--default-sidebar-bg-color)] text-white px-4 py-2 rounded-lg shadow hover:opacity-90 transition-all font-medium text-sm"
              onclick="openCurrentInNewTab()">
        <span>全屏进入</span>
        <i class="ph-bold ph-arrow-square-out"></i>
      </button>
    </header>

    <!-- iframe 容器 -->
    <div class="flex-grow p-4 md:p-6 overflow-hidden">
        <div class="iframe-wrapper shadow-lg relative bg-gray-50 flex items-center justify-center">
            <iframe id="frame-ziyou" class="system-frame" style="display:none;"></iframe>
            <iframe id="frame-course-progress" class="system-frame" style="display:none;"></iframe>
            <iframe id="frame-wengu" class="system-frame" style="display:none;"></iframe>
            <iframe id="frame-zhixin" class="system-frame" style="display:none;"></iframe>
            
            <div id="not-found-state" class="hidden text-center p-8">
                <i class="ph-duotone ph-file-x text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-lg font-bold text-gray-700">找不到文件</h3>
                <p class="text-gray-500 text-sm mt-2 mb-4">
                    系统无法加载 <span id="missing-filename" class="font-mono bg-gray-200 px-1 rounded">...</span>
                </p>
                <button onclick="openPathSettings()" class="text-blue-500 hover:underline text-sm">点击配置正确的文件名</button>
            </div>
        </div>
    </div>
  </main>

  <!-- 路径配置模态框 -->
  <div id="pathSettingsModal" class="modal-overlay">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-800">文件路径配置</h3>
            <button onclick="closePathSettings()" class="p-1 hover:bg-gray-100 rounded-full"><i class="ph-bold ph-x text-lg"></i></button>
        </div>

        <div id="dropZone" class="drop-zone mb-6 group">
            <i class="ph-duotone ph-file-arrow-up text-4xl text-gray-400 group-hover:text-blue-500 transition-colors mb-2"></i>
            <p class="text-sm font-medium text-gray-600">把你的 HTML 文件拖拽到这里</p>
            <p class="text-xs text-gray-400 mt-1">自动识别名称并更新链接</p>
        </div>

        <div class="space-y-4 mb-6">
            <div class="grid grid-cols-4 items-center gap-2">
                <label class="text-sm font-medium text-gray-700 text-right">自由系统</label>
                <input type="text" id="input-ziyou" class="col-span-3 text-sm border rounded px-3 py-2 bg-gray-50 focus:bg-white focus:border-blue-500 outline-none transition-colors" placeholder="例如: 自由系统3.0.html">
            </div>
            <div class="grid grid-cols-4 items-center gap-2">
                <label class="text-sm font-medium text-gray-700 text-right">课程进度</label>
                <input type="text" id="input-course-progress" class="col-span-3 text-sm border rounded px-3 py-2 bg-gray-50 focus:bg-white focus:border-blue-500 outline-none transition-colors" placeholder="例如: 进度跟进系统.html">
            </div>
            <div class="grid grid-cols-4 items-center gap-2">
                <label class="text-sm font-medium text-gray-700 text-right">温故系统</label>
                <input type="text" id="input-wengu" class="col-span-3 text-sm border rounded px-3 py-2 bg-gray-50 focus:bg-white focus:border-blue-500 outline-none transition-colors" placeholder="例如: 温故系统5.0.html">
            </div>
            <div class="grid grid-cols-4 items-center gap-2">
                <label class="text-sm font-medium text-gray-700 text-right">知新系统</label>
                <input type="text" id="input-zhixin" class="col-span-3 text-sm border rounded px-3 py-2 bg-gray-50 focus:bg-white focus:border-blue-500 outline-none transition-colors" placeholder="例如: 知新系统5.0.html">
            </div>
        </div>

        <div class="flex justify-end gap-3">
            <button onclick="closePathSettings()" class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg">取消</button>
            <button onclick="savePaths()" class="px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-lg shadow">保存配置</button>
        </div>
    </div>
  </div>

  <script>
    // --- 1. 核心配置逻辑 ---
    const defaultPaths = {
        'ziyou': '自由系统3.0.html',
        'course-progress': '进度跟进系统.html',
        'wengu': '温故系统5.0.html',
        'zhixin': '知新系统5.0.html'
    };

    let currentPaths = { ...defaultPaths };
    let activeSystem = 'ziyou'; 

    const sysNames = {
        'ziyou': '自由系统',
        'course-progress': '课程进度',
        'wengu': '温故系统',
        'zhixin': '知新系统'
    };

    function init() {
        const savedPaths = localStorage.getItem('learningSystemPaths');
        if (savedPaths) {
            try {
                const parsed = JSON.parse(savedPaths);
                currentPaths = { ...defaultPaths, ...parsed };
                if (currentPaths['ziyou'] === '自由系统 3.0.html') {
                    currentPaths['ziyou'] = '自由系统3.0.html';
                    localStorage.setItem('learningSystemPaths', JSON.stringify(currentPaths));
                }
            } catch(e) { console.error('Path load error', e); }
        }

        loadColorSettings();
        switchSystem(activeSystem);
        setupDropZone();
        
        // 恢复侧边栏状态
        const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        if (isCollapsed) {
            document.getElementById('main-sidebar').classList.add('collapsed');
        }
    }

    // --- 新功能：侧边栏切换 ---
    function toggleSidebar() {
        const sidebar = document.getElementById('main-sidebar');
        sidebar.classList.toggle('collapsed');
        
        // 保存状态
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
    }

    function switchSystem(key) {
        activeSystem = key;

        document.querySelectorAll('.sidebar-button').forEach(btn => btn.classList.remove('active-sidebar-button'));
        const activeBtn = document.getElementById(`btn-${key}`);
        if(activeBtn) activeBtn.classList.add('active-sidebar-button');

        const titleEl = document.getElementById('content-title');
        titleEl.textContent = sysNames[key];
        
        const fileName = currentPaths[key];
        const versionMatch = fileName.match(/(\d+\.\d+)/);
        const verTag = document.getElementById('file-version-tag');
        if (versionMatch) {
            verTag.textContent = `v${versionMatch[1]}`;
            verTag.classList.remove('hidden');
        } else {
            verTag.classList.add('hidden');
        }

        const frames = document.querySelectorAll('.system-frame');
        frames.forEach(f => f.style.display = 'none');
        
        const targetFrame = document.getElementById(`frame-${key}`);
        const notFoundState = document.getElementById('not-found-state');
        
        if (targetFrame) {
            targetFrame.src = currentPaths[key];
            targetFrame.style.display = 'block';
            notFoundState.classList.add('hidden');
            
            targetFrame.onerror = () => {
                targetFrame.style.display = 'none';
                document.getElementById('missing-filename').textContent = currentPaths[key];
                notFoundState.classList.remove('hidden');
            }
        }
    }

    function openCurrentInNewTab() {
        const path = currentPaths[activeSystem];
        if (path) window.open(path, '_blank');
    }

    // --- 2. 配置面板逻辑 ---
    const modal = document.getElementById('pathSettingsModal');
    
    function openPathSettings() {
        document.getElementById('input-ziyou').value = currentPaths['ziyou'];
        document.getElementById('input-course-progress').value = currentPaths['course-progress'];
        document.getElementById('input-wengu').value = currentPaths['wengu'];
        document.getElementById('input-zhixin').value = currentPaths['zhixin'];
        modal.style.display = 'flex';
    }

    function closePathSettings() {
        modal.style.display = 'none';
    }

    function savePaths() {
        const newPaths = {
            'ziyou': document.getElementById('input-ziyou').value.trim() || defaultPaths['ziyou'],
            'course-progress': document.getElementById('input-course-progress').value.trim() || defaultPaths['course-progress'],
            'wengu': document.getElementById('input-wengu').value.trim() || defaultPaths['wengu'],
            'zhixin': document.getElementById('input-zhixin').value.trim() || defaultPaths['zhixin']
        };

        currentPaths = newPaths;
        localStorage.setItem('learningSystemPaths', JSON.stringify(currentPaths));
        
        const targetFrame = document.getElementById(`frame-${activeSystem}`);
        targetFrame.src = 'about:blank'; 
        setTimeout(() => switchSystem(activeSystem), 50);

        closePathSettings();
    }

    // --- 3. 拖拽自动识别 ---
    function setupDropZone() {
        const dropZone = document.getElementById('dropZone');
        const inputs = {
            'ziyou': document.getElementById('input-ziyou'),
            'course-progress': document.getElementById('input-course-progress'),
            'wengu': document.getElementById('input-wengu'),
            'zhixin': document.getElementById('input-zhixin')
        };

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('drag-over');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('drag-over');
            }, false);
        });

        dropZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                let updatedCount = 0;
                for(let file of files) {
                    const name = file.name;
                    if (name.includes('自由')) {
                        inputs['ziyou'].value = name;
                        flashInput(inputs['ziyou']);
                        updatedCount++;
                    } else if (name.includes('进度') || name.includes('课程')) {
                        inputs['course-progress'].value = name;
                        flashInput(inputs['course-progress']);
                        updatedCount++;
                    } else if (name.includes('温故')) {
                        inputs['wengu'].value = name;
                        flashInput(inputs['wengu']);
                        updatedCount++;
                    } else if (name.includes('知新')) {
                        inputs['zhixin'].value = name;
                        flashInput(inputs['zhixin']);
                        updatedCount++;
                    }
                }

                if (updatedCount > 0) {
                   const p = dropZone.querySelector('p.text-sm');
                   const originalText = p.textContent;
                   p.textContent = `成功识别 ${updatedCount} 个文件！记得点保存。`;
                   p.classList.add('text-green-600');
                   setTimeout(() => {
                       p.textContent = originalText;
                       p.classList.remove('text-green-600');
                   }, 2000);
                }
            }
        });
    }

    function flashInput(el) {
        el.style.backgroundColor = '#dbeafe'; 
        el.style.borderColor = '#3b82f6';
        setTimeout(() => {
            el.style.backgroundColor = '';
            el.style.borderColor = '';
        }, 800);
    }

    // --- 4. 颜色与外观 ---
    const root = document.documentElement;
    const highlightColorPicker = document.getElementById('highlightColorPicker');
    const sidebarBgColorPicker = document.getElementById('sidebarBgColorPicker');

    function applyHighlightColor(color) {
        root.style.setProperty('--primary-color', color);
        const luma = getLuma(color);
        root.style.setProperty('--active-button-text-color', luma > 150 ? '#000000' : '#ffffff');
    }

    function applySidebarBgColor(color) {
        root.style.setProperty('--sidebar-bg-color', color);
        const luma = getLuma(color);
        if (luma > 128) {
            root.style.setProperty('--sidebar-text-color', '#1f2937');
            root.style.setProperty('--sidebar-hover-bg-color', adjustColor(color, -20));
        } else {
            root.style.setProperty('--sidebar-text-color', '#ffffff');
            root.style.setProperty('--sidebar-hover-bg-color', adjustColor(color, 20));
        }
    }

    function getLuma(c) {
        const hex = c.startsWith('#') ? c.substring(1) : c;
        const rgb = parseInt(hex, 16);
        return 0.2126 * ((rgb >> 16) & 0xff) + 0.7152 * ((rgb >> 8) & 0xff) + 0.0722 * ((rgb >> 0) & 0xff);
    }

    function adjustColor(col, amt) {
        let usePound = false;
        if (col[0] === "#") { col = col.slice(1); usePound = true; }
        let num = parseInt(col, 16);
        let r = (num >> 16) + amt; if (r > 255) r = 255; else if (r < 0) r = 0;
        let b = ((num >> 8) & 0x00FF) + amt; if (b > 255) b = 255; else if (b < 0) b = 0;
        let g = (num & 0x0000FF) + amt; if (g > 255) g = 255; else if (g < 0) g = 0;
        return (usePound ? "#" : "") + (g | (b << 8) | (r << 16)).toString(16).padStart(6,'0');
    }

    function loadColorSettings() {
        const savedHighlight = localStorage.getItem('userHighlightColor');
        const savedSidebarBg = localStorage.getItem('userSidebarBgColor');
        
        const defaultPrimary = getComputedStyle(root).getPropertyValue('--default-primary-color').trim();
        const defaultSidebarBg = getComputedStyle(root).getPropertyValue('--default-sidebar-bg-color').trim();

        if (savedHighlight) {
            highlightColorPicker.value = savedHighlight;
            applyHighlightColor(savedHighlight);
        } else {
            highlightColorPicker.value = defaultPrimary;
            applyHighlightColor(defaultPrimary);
        }

        if (savedSidebarBg) {
            sidebarBgColorPicker.value = savedSidebarBg;
            applySidebarBgColor(savedSidebarBg);
        } else {
            sidebarBgColorPicker.value = defaultSidebarBg;
            applySidebarBgColor(defaultSidebarBg);
        }
    }

    highlightColorPicker.addEventListener('input', (e) => {
        applyHighlightColor(e.target.value);
        localStorage.setItem('userHighlightColor', e.target.value);
    });

    sidebarBgColorPicker.addEventListener('input', (e) => {
        applySidebarBgColor(e.target.value);
        localStorage.setItem('userSidebarBgColor', e.target.value);
    });

    document.getElementById('restoreDefaultsButton').addEventListener('click', () => {
        localStorage.removeItem('userHighlightColor');
        localStorage.removeItem('userSidebarBgColor');
        loadColorSettings();
    });

    window.onload = init;
  </script>
</body>
</html>